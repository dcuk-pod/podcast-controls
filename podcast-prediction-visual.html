<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Match Preview</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        /* CSS styles remain unchanged */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');
        body{background-color:transparent;font-family:'Poppins',sans-serif;color:#333;margin:0;padding:0;overflow:hidden}.preview-wrapper{width:1920px;height:1080px;background-color:#f4f6f9;box-sizing:border-box;padding:30px;display:flex;flex-direction:column;opacity:0;transform:translateY(20px);transition:opacity .5s ease-out,transform .5s ease-out}.preview-wrapper.visible{opacity:1;transform:translateY(0)}.top-bar{display:flex;align-items:center;gap:20px;padding-bottom:20px;border-bottom:2px solid #e0e0e0;flex-shrink:0}.league-logo{width:70px;height:70px;object-fit:contain}.header-details{display:flex;flex-direction:column;justify-content:center}.fixture-name{font-size:30px;font-weight:700}.fixture-meta{font-size:18px;color:#888}.main-content{flex-grow:1;display:grid;grid-template-columns:1fr 1fr;gap:30px;padding-top:20px;overflow:hidden}.column{display:flex;flex-direction:column;gap:20px;overflow:hidden}.section{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,.05);flex-shrink:0}.section-title{font-size:20px;font-weight:700;margin:0 0 10px;padding-bottom:8px;border-bottom:1px solid #eee}.prediction-summary .details{display:grid;grid-template-columns:1fr 1fr 1.5fr;align-items:center;text-align:center}.prediction-item{padding:0 15px}.prediction-item:not(:last-child){border-right:1px solid #eee}.prediction-item .label{font-size:15px;color:#777;margin-bottom:5px}.prediction-item .value{font-size:24px;font-weight:700}.prediction-chances{display:flex;justify-content:space-around}.chance-item .value{font-size:22px}.team-stats .team-header{display:flex;align-items:center;gap:15px;margin-bottom:10px}.team-stats .team-header img{width:45px;height:45px;object-fit:contain}.team-stats .team-header .team-name{font-size:22px;font-weight:700;margin:0}.team-stats .stat-row{display:flex;justify-content:space-between;font-size:14px;padding:4px 0;border-bottom:1px solid #f9f9f9}.team-stats .stat-row:last-child{border-bottom:none}.team-stats .stat-row .label{color:#666}.team-stats .stat-row .value{font-weight:600}.h2h-list .match{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:15px;padding:4px 0;border-bottom:1px solid #f0f0f0;font-size:14px}.h2h-list .match:last-child{border-bottom:none}.h2h-list .match .team-name.home{text-align:right}.h2h-list .match .team-name.away{text-align:left}.h2h-list .winner{font-weight:700}.h2h-list .score{font-weight:900}.form-container{display:grid;grid-template-columns:1fr 1fr;gap:20px}.form-title{font-size:16px;font-weight:600;margin-bottom:10px}.form-boxes{display:flex;gap:8px}.form-box{width:35px;height:35px;border-radius:6px;line-height:35px;text-align:center;color:#fff;font-weight:700;font-size:14px}.form-W{background-color:#4caf50}.form-D{background-color:#ffc107}.form-L{background-color:#f44336}.standings-table{width:100%;border-collapse:collapse;font-size:14px}.standings-table thead tr{border-bottom:2px solid #ddd}.standings-table th{padding:8px 5px;font-weight:700;text-align:center;color:#555}.standings-table th:nth-child(2){text-align:left}.standings-table td{padding:6px 5px;text-align:center;vertical-align:middle}.standings-table .team-cell{display:flex;align-items:center;gap:10px;font-weight:600;text-align:left}.standings-table .team-cell img{width:24px;height:24px;object-fit:contain}.standings-table .highlight-team{background-color:#f0f8ff;font-weight:700}
    </style>
</head>
<body>
    <div id="preview-container"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
            authDomain: "scoreboard-control.firebaseapp.com",
            projectId: "scoreboard-control",
            storageBucket: "scoreboard-control.appspot.com",
            messagingSenderId: "438021450087",
            appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <script>
        window.addEventListener('load', function() {
            // All of your existing JavaScript for this page remains unchanged
            const container=document.getElementById("preview-container"),visibilityDocRef=db.collection("podcast").doc("visibility"),dataDocRef=db.collection("podcast").doc("predictionData"),fixtureDocRef=db.collection("podcast").doc("currentFixture");let unsubscribeAll=null;function subscribeToData(){if(unsubscribeAll)unsubscribeAll();let e=null,t=null;const n=dataDocRef.onSnapshot(n=>{n.exists&&n.data().prediction?(e=n.data().prediction,checkAndRender()):displayError("Prediction data not found. Please click 'Load Data' in the control panel.")}),i=fixtureDocRef.onSnapshot(n=>{n.exists?(t=n.data(),checkAndRender()):displayError("Fixture data not found. Please load a fixture from the control panel.")});unsubscribeAll=()=>{n(),i()};async function checkAndRender(){if(e&&t)try{const n=e.league.id,i=e.league.season,a=await fetch(`${API_BASE_URL}/standings?league=${n}&season=${i}`,{headers:{"x-rapidapi-key":apiKey,"x-rapidapi-host":"v3.football.api-sports.io"}}),d=await a.json();if(!d.response||0===d.response.length)return void buildGraphic(t,e,[]);const o=d.response[0].league.standings.flat();buildGraphic(t,e,o)}catch(e){console.error("PREDICTION RENDER ERROR:",e),displayError(e.message)}}}function hideGraphic(){const e=container.querySelector(".preview-wrapper");e?(e.classList.remove("visible"),setTimeout(()=>{e.classList.contains("visible")||(container.innerHTML="")},500)):container.innerHTML=""}function displayError(e){container.innerHTML=`<div class="preview-wrapper visible"><h1>Error</h1><p style="font-size: 24px;">${e}</p></div>`}function buildGraphic(e,t,n){container.innerHTML="";const i=document.createElement("div");i.className="preview-wrapper";const a=t.teams.home,d=t.teams.away,o=new Date(e.fixture.date),s=o.toLocaleDateString("en-GB",{day:"numeric",month:"long"}),r=o.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit",timeZoneName:"short"}),l=e=>(e||"-----").slice(-6).split("").map(e=>`<div class="form-box form-${e}">${e}</div>`).join(""),c=`
            <div class="top-bar">
                <img src="${t.league.logo}" alt="${t.league.name}" class="league-logo">
                <div class="header-details">
                    <div class="fixture-name">${t.teams.home.name} vs ${t.teams.away.name}</div>
                    <div class="fixture-meta">${s} at ${r} | ${e.fixture.venue.name} | Referee: ${e.fixture.referee||"Not Announced"}</div>
                </div>
            </div>
        `,m=`
            <div class="section prediction-summary">
                <div class="details">
                    <div class="prediction-item">
                        <div class="label">Predicted Winner</div>
                        <div class="value">${t.predictions.winner.name||"Draw"}</div>
                    </div>
                    <div class="prediction-item">
                        <div class="label">Predicted Score</div>
                        <div class="value">${(t.predictions.goals.home||"-").replace("-","")} - ${(t.predictions.goals.away||"-").replace("-","")}</div>
                    </div>
                    <div class="prediction-item prediction-chances">
                        <div class="chance-item">
                            <div class="label">${a.name}</div>
                            <div class="value">${t.predictions.percent.home}</div>
                        </div>
                        <div class="chance-item">
                            <div class="label">Draw</div>
                            <div class="value">${t.predictions.percent.draw}</div>
                        </div>
                        <div class="chance-item">
                            <div class="label">${d.name}</div>
                            <div class="value">${t.predictions.percent.away}</div>
                        </div>
                    </div>
                </div>
            </div>
        `,p=(e,t)=>{const n=e.league;if(!n)return"";const i=n.lineups?.sort((e,t)=>t.played-e.played)[0]?.formation||"N/A";return`
                <div class="section team-stats">
                    <div class="team-header">
                        <img src="${e.logo}" alt="${e.name}">
                        <h2 class="team-name">${e.name}</h2>
                    </div>
                    <div class="stat-row"><span class="label">Record (W-D-L)</span> <span class="value">${n.fixtures.wins.total}-${n.fixtures.draws.total}-${n.fixtures.loses.total}</span></div>
                    <div class="stat-row"><span class="label">Goals For / Against</span> <span class="value">${n.goals.for.total.total} / ${n.goals.against.total.total}</span></div>
                    <div class="stat-row"><span class="label">Avg Goals For</span> <span class="value">${n.goals.for.average.total}</span></div>
                    <div class="stat-row"><span class="label">Avg Goals Against</span> <span class="value">${n.goals.against.average.total}</span></div>
                    <div class="stat-row"><span class="label">Clean Sheets</span> <span class="value">${n.clean_sheet.total}</span></div>
                    <div class="stat-row"><span class="label">Failed to Score</span> <span class="value">${n.failed_to_score.total}</span></div>
                    <div class="stat-row"><span class="label">Biggest Win</span> <span class="value">${n.biggest.wins[t]||"-"}</span></div>
                    <div class="stat-row"><span class="label">Main Formation</span> <span class="value">${i}</span></div>
                </div>
            `},f=`
            <div class="section h2h">
                <h3 class="section-title">Head to Head (Last 5)</h3>
                <div class="h2h-list">
                    ${t.h2h.slice(0,5).map(e=>`
                        <div class="match">
                            <span class="team-name home ${e.teams.home.winner?"winner":""}">${e.teams.home.name}</span>
                            <span class="score">${e.goals.home} - ${e.goals.away}</span>
                            <span class="team-name away ${e.teams.away.winner?"winner":""}">${e.teams.away.name}</span>
                        </div>
                    `).join("")}
                </div>
            </div>
        `,g=`
            <div class="section form">
                <h3 class="section-title">Recent Form (Last 6)</h3>
                <div class="form-container">
                    <div class="form-team">
                        <div class="form-title">${a.name}</div>
                        <div class="form-boxes">${l(a.league.form)}</div>
                    </div>
                    <div class="form-team">
                        <div class="form-title">${d.name}</div>
                        <div class="form-boxes">${l(d.league.form)}</div>
                    </div>
                </div>
            </div>
        `,h=n&&n.length>0?`
            <div class="section standings">
                <h3 class="section-title">League Standings</h3>
                <table class="standings-table">
                    <thead>
                        <tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr>
                    </thead>
                    <tbody>
                        ${n.filter(e=>e.team.id===a.id||e.team.id===d.id).map(e=>`
                                <tr class="highlight-team">
                                    <td>${e.rank}</td>
                                    <td class="team-cell"><img src="${e.team.logo}" alt="${e.team.name}"><span>${e.team.name}</span></td>
                                    <td>${e.all.played}</td>
                                    <td>${e.all.win}</td>
                                    <td>${e.all.draw}</td>
                                    <td>${e.all.lose}</td>
                                    <td>${e.goalsDiff}</td>
                                    <td><b>${e.points}</b></td>
                                </tr>
                            `).join("")}
                    </tbody>
                </table>
            </div>
        `:"";i.innerHTML=`
            ${c}
            <div class="main-content">
                <div class="column left-column">
                    ${m}
                    ${p(a,"home")}
                    ${p(d,"away")}
                </div>
                <div class="column right-column">
                    ${f}
                    ${g}
                    ${h}
                </div>
            </div>
        `,container.appendChild(i),setTimeout(()=>i.classList.add("visible"),50)}visibilityDocRef.onSnapshot(e=>{const t=e.data()?.showPrediction===!0;t?(container.innerHTML="<h1><br/>Loading Match Preview...</h1>",subscribeToData()):(unsubscribeAll&&(unsubscribeAll(),unsubscribeAll=null),hideGraphic())});
        });
    </script>
</body>
</html>