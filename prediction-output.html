<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Match Preview Output</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;900&display=swap');
        body { background-color: transparent; font-family: 'Poppins', sans-serif; color: #333; margin: 0; padding: 0; overflow: hidden; }
        .preview-wrapper { width: 1920px; height: 1080px; background-color: #f4f6f9; box-sizing: border-box; padding: 30px; display: flex; flex-direction: column; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
        .preview-wrapper.visible { opacity: 1; transform: translateY(0); }
        .top-bar { display: flex; align-items: center; gap: 20px; padding-bottom: 20px; border-bottom: 2px solid #e0e0e0; flex-shrink: 0; }
        .league-logo { width: 70px; height: 70px; object-fit: contain; }
        .header-details { display: flex; flex-direction: column; justify-content: center; }
        .fixture-name { font-size: 30px; font-weight: 700; }
        .fixture-meta { font-size: 18px; color: #888; }
        .main-content { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding-top: 20px; overflow: hidden; }
        .column { display: flex; flex-direction: column; gap: 20px; overflow: hidden; }
        .section { background: #ffffff; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); flex-shrink: 0; }
        .section-title { font-size: 20px; font-weight: 700; margin: 0 0 10px 0; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .prediction-summary .details { display: grid; grid-template-columns: 1fr 1fr 1.5fr; align-items: center; text-align: center; }
        .prediction-item { padding: 0 15px; }
        .prediction-item:not(:last-child) { border-right: 1px solid #eee; }
        .prediction-item .label { font-size: 15px; color: #777; margin-bottom: 5px; }
        .prediction-item .value { font-size: 24px; font-weight: 700; }
        .prediction-chances { display: flex; justify-content: space-around; }
        .chance-item .value { font-size: 22px; }
        .team-stats .team-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .team-stats .team-header img { width: 45px; height: 45px; object-fit: contain; }
        .team-stats .team-header .team-name { font-size: 22px; font-weight: 700; margin: 0; }
        .team-stats .stat-row { display: flex; justify-content: space-between; font-size: 14px; padding: 4px 0; border-bottom: 1px solid #f9f9f9; }
        .team-stats .stat-row:last-child { border-bottom: none; }
        .team-stats .stat-row .label { color: #666; }
        .team-stats .stat-row .value { font-weight: 600; }
        .h2h-list .match { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 15px; padding: 4px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
        .h2h-list .match:last-child { border-bottom: none; }
        .h2h-list .match .team-name.home { text-align: right; }
        .h2h-list .match .team-name.away { text-align: left; }
        .h2h-list .winner { font-weight: 700; }
        .h2h-list .score { font-weight: 900; }
        .form-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; }
        .form-boxes { display: flex; gap: 8px; }
        .form-box { width: 35px; height: 35px; border-radius: 6px; line-height: 35px; text-align: center; color: white; font-weight: 700; font-size: 14px; }
        .form-W { background-color: #4CAF50; }
        .form-D { background-color: #FFC107; }
        .form-L { background-color: #F44336; }
        .standings-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .standings-table thead tr { border-bottom: 2px solid #ddd; }
        .standings-table th { padding: 8px 5px; font-weight: 700; text-align: center; color: #555; }
        .standings-table th:nth-child(2) { text-align: left; }
        .standings-table td { padding: 6px 5px; text-align: center; vertical-align: middle; }
        .standings-table .team-cell { display: flex; align-items: center; gap: 10px; font-weight: 600; text-align: left; }
        .standings-table .team-cell img { width: 24px; height: 24px; object-fit: contain; }
        .standings-table .highlight-team { background-color: #f0f8ff; font-weight: 700; }
    </style>
</head>
<body>
    <div id="preview-container"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
                authDomain: "scoreboard-control.firebaseapp.com",
                projectId: "scoreboard-control",
                storageBucket: "scoreboard-control.appspot.com",
                messagingSenderId: "438021450087",
                appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // COMMENT: Define the base URL for your GitHub Pages assets.
            const assetsBaseUrl = 'https://dcuk-pod.github.io/podcast-controls/';

            const container = document.getElementById('preview-container');
            const visibilityDocRef = db.collection('scoreboard').doc('predictionVisibility');
            const dataDocRef = db.collection('scoreboard').doc('predictionData');
            const fixtureDocRef = db.collection('scoreboard').doc('currentFixture');
            const standingsDocRef = db.collection('scoreboard').doc('standingsData');
            
            let unsubscribeAll = null;

            visibilityDocRef.onSnapshot(doc => {
                const isVisible = doc.data()?.show === true;
                if (isVisible) {
                    container.innerHTML = `<div class="preview-wrapper visible"><h1>Loading Match Preview...</h1></div>`;
                    subscribeToData();
                } else {
                    if (unsubscribeAll) {
                        unsubscribeAll();
                        unsubscribeAll = null;
                    }
                    hideGraphic();
                }
            });

            function subscribeToData() {
                if (unsubscribeAll) unsubscribeAll();

                let predictionData = null;
                let fixtureData = null;
                let standingsData = null;

                const unsubPrediction = dataDocRef.onSnapshot(doc => {
                    if (doc.exists && doc.data().data) {
                        predictionData = doc.data().data;
                        checkAndRender();
                    } else {
                        displayError("Prediction data not found. Please click 'Load Data' in the control panel.");
                    }
                });

                const unsubFixture = fixtureDocRef.onSnapshot(doc => {
                     if (doc.exists) {
                        fixtureData = doc.data();
                        checkAndRender();
                    } else {
                        displayError("Fixture data not found. Please load a fixture from the control panel.");
                    }
                });

                const unsubStandings = standingsDocRef.onSnapshot(doc => {
                    if (doc.exists && doc.data().data) {
                        standingsData = doc.data().data;
                        checkAndRender();
                    } else {
                        displayError("Standings data not found. Click 'Load Data' in the control panel to fetch it.");
                    }
                });
                
                unsubscribeAll = () => {
                    unsubPrediction();
                    unsubFixture();
                    unsubStandings();
                };

                function checkAndRender() {
                    if (predictionData && fixtureData && standingsData) {
                        try {
                            buildGraphic(fixtureData, predictionData, standingsData);
                        } catch (err) {
                            console.error("PREDICTION RENDER ERROR:", err);
                            displayError(err.message);
                        }
                    }
                }
            }

            function hideGraphic() {
                const wrapper = container.querySelector('.preview-wrapper');
                if (wrapper) {
                    wrapper.classList.remove('visible');
                    setTimeout(() => { if (!wrapper.classList.contains('visible')) container.innerHTML = ''; }, 500);
                } else {
                    container.innerHTML = '';
                }
            }

            function displayError(message) {
                 container.innerHTML = `<div class="preview-wrapper visible"><h1 style="text-align:center;">Error</h1><p style="font-size: 24px; text-align:center;">${message}</p></div>`;
            }

            function buildGraphic(fixture, prediction, standings) {
                container.innerHTML = '';
                const wrapper = document.createElement('div');
                wrapper.className = 'preview-wrapper';

                const homeTeam = prediction.teams.home;
                const awayTeam = prediction.teams.away;
                const fixtureDate = new Date(fixture.fixture.date);
                const formattedDate = fixtureDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long' });
                const formattedTime = fixtureDate.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', timeZoneName: 'short' });
                const createFormHtml = (formString) => (formString || '-----').slice(-6).split('').map(r => `<div class="form-box form-${r}">${r}</div>`).join('');
                
                // COMMENT: Updated league logo path.
                // REASON: While the API provides a URL, using your own hosted asset ensures consistency.
                // NOTE: This assumes you have league logos in an 'assets/leagues/' folder named by league ID.
                const leagueLogoUrl = `${assetsBaseUrl}assets/leagues/${fixture.league.id}.png`;

                const topBarHTML = `
                    <div class="top-bar">
                        <img src="${leagueLogoUrl}" alt="${fixture.league.name}" class="league-logo" onerror="this.src='${fixture.league.logo}'">
                        <div class="header-details">
                            <div class="fixture-name">${fixture.teams.home.name} vs ${fixture.teams.away.name}</div>
                            <div class="fixture-meta">${formattedDate} at ${formattedTime} | ${fixture.fixture.venue.name} | Referee: ${fixture.fixture.referee || 'N/A'}</div>
                        </div>
                    </div>`;

                const predictionSummaryHTML = `
                    <div class="section prediction-summary">
                        <div class="details">
                            <div class="prediction-item">
                                <div class="label">Predicted Winner</div>
                                <div class="value">${prediction.predictions.winner.name || 'Draw'}</div>
                            </div>
                            <div class="prediction-item">
                                <div class="label">Predicted Score</div>
                                <div class="value">${prediction.predictions.goals.home.replace('-', '')} - ${prediction.predictions.goals.away.replace('-', '')}</div>
                            </div>
                            <div class="prediction-item prediction-chances">
                                <div class="chance-item">
                                    <div class="label">${homeTeam.name}</div>
                                    <div class="value">${prediction.predictions.percent.home}</div>
                                </div>
                                <div class="chance-item">
                                    <div class="label">Draw</div>
                                    <div class="value">${prediction.predictions.percent.draw}</div>
                                </div>
                                <div class="chance-item">
                                    <div class="label">${awayTeam.name}</div>
                                    <div class="value">${prediction.predictions.percent.away}</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                
                const createTeamStatsHTML = (team, type) => {
                    const league = team.league;
                    const mostUsedFormation = league.lineups?.sort((a, b) => b.played - a.played)[0]?.formation || 'N/A';
                    // COMMENT: Updated team logo path.
                    // REASON: Constructs the URL from the team ID to use your hosted asset.
                    const teamLogoUrl = `${assetsBaseUrl}assets/logos/${team.id}.png`;
                    return `
                        <div class="section team-stats">
                            <div class="team-header">
                                <img src="${teamLogoUrl}" alt="${team.name}" onerror="this.src='${team.logo}'">
                                <h2 class="team-name">${team.name}</h2>
                            </div>
                            <div class="stat-row"><span class="label">Record (W-D-L)</span> <span class="value">${league.fixtures.wins.total}-${league.fixtures.draws.total}-${league.fixtures.loses.total}</span></div>
                            <div class="stat-row"><span class="label">Goals For / Against</span> <span class="value">${league.goals.for.total.total} / ${league.goals.against.total.total}</span></div>
                            <div class="stat-row"><span class="label">Avg Goals For</span> <span class="value">${league.goals.for.average.total}</span></div>
                            <div class="stat-row"><span class="label">Avg Goals Against</span> <span class="value">${league.goals.against.average.total}</span></div>
                            <div class="stat-row"><span class="label">Clean Sheets</span> <span class="value">${league.clean_sheet.total}</span></div>
                            <div class="stat-row"><span class="label">Failed to Score</span> <span class="value">${league.failed_to_score.total}</span></div>
                            <div class="stat-row"><span class="label">Biggest Win</span> <span class="value">${league.biggest.wins[type] || '-'}</span></div>
                            <div class="stat-row"><span class="label">Main Formation</span> <span class="value">${mostUsedFormation}</span></div>
                        </div>`;
                };

                const h2hHTML = `
                    <div class="section h2h">
                        <h3 class="section-title">Head to Head (Last 5)</h3>
                        <div class="h2h-list">
                            ${prediction.h2h.slice(0, 5).map(match => `
                                <div class="match">
                                    <span class="team-name home ${match.teams.home.winner ? 'winner' : ''}">${match.teams.home.name}</span>
                                    <span class="score">${match.goals.home} - ${match.goals.away}</span>
                                    <span class="team-name away ${match.teams.away.winner ? 'winner' : ''}">${match.teams.away.name}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;

                const formHTML = `
                    <div class="section form">
                        <h3 class="section-title">Recent Form (Last 6)</h3>
                        <div class="form-container">
                            <div class="form-team">
                                <div class="form-title">${homeTeam.name}</div>
                                <div class="form-boxes">${createFormHtml(homeTeam.league.form)}</div>
                            </div>
                            <div class="form-team">
                                <div class="form-title">${awayTeam.name}</div>
                                <div class="form-boxes">${createFormHtml(awayTeam.league.form)}</div>
                            </div>
                        </div>
                    </div>`;

                const standingsHTML = `
                    <div class="section standings">
                        <h3 class="section-title">League Standings</h3>
                        <table class="standings-table">
                            <thead>
                                <tr><th>#</th><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr>
                            </thead>
                            <tbody>
                                ${standings
                                    .filter(row => row.team.id === homeTeam.id || row.team.id === awayTeam.id)
                                    .map(row => {
                                        // COMMENT: Updated standings table logo path.
                                        // REASON: Ensures the logos in the table also come from your GitHub repo.
                                        const standingTeamLogoUrl = `${assetsBaseUrl}assets/logos/${row.team.id}.png`;
                                        return `
                                        <tr class="highlight-team">
                                            <td>${row.rank}</td>
                                            <td class="team-cell"><img src="${standingTeamLogoUrl}" alt="${row.team.name}" onerror="this.src='${row.team.logo}'"><span>${row.team.name}</span></td>
                                            <td>${row.all.played}</td>
                                            <td>${row.all.win}</td>
                                            <td>${row.all.draw}</td>
                                            <td>${row.all.lose}</td>
                                            <td>${row.goalsDiff}</td>
                                            <td><b>${row.points}</b></td>
                                        </tr>
                                    `}).join('')}
                            </tbody>
                        </table>
                    </div>`;
                
                wrapper.innerHTML = `
                    ${topBarHTML}
                    <div class="main-content">
                        <div class="column left-column">
                            ${predictionSummaryHTML}
                            ${createTeamStatsHTML(homeTeam, 'home')}
                            ${createTeamStatsHTML(awayTeam, 'away')}
                        </div>
                        <div class="column right-column">
                            ${h2hHTML}
                            ${formHTML}
                            ${standingsHTML}
                        </div>
                    </div>`;

                container.appendChild(wrapper);
                setTimeout(() => wrapper.classList.add('visible'), 50);
            }
        });
    </script>
</body>
</html>
