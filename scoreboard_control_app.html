<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Control App</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    <style>
        /* --- Global & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .control-panel-wrapper { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; }
        .panel-header h1 { margin: 0; font-size: 24px; }
        
        .api-status-bar {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            font-size: 14px;
        }
        .api-status-bar .session-calls { text-align: left; }
        .api-status-bar .daily-calls { text-align: right; }
        .api-status-bar span { font-weight: bold; }
        .polling-controls-wrapper { display: flex; justify-content: center; align-items: center; gap: 10px; }
        
        .fixture-container {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .fixture-header {
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
         .fixture-header::after {
            content: 'â–²';
            transition: transform 0.3s ease;
        }
        .fixture-container.collapsed .fixture-header::after {
             transform: rotate(180deg);
        }
        .data-fetch-section {
            padding: 15px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 15px;
            max-height: 500px;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        .fixture-container.collapsed .data-fetch-section {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .data-fetch-section label { font-weight: bold; }
        .data-fetch-section select, .data-fetch-section button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            width: 100%;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        #status-text {
            margin-top: 10px;
            color: #555;
            font-style: italic;
        }

        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .control-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; }
        .card-title { margin-top: 0; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .score-controls { display: flex; flex-direction: column; gap: 15px; }
        .team-control { display: flex; justify-content: space-between; align-items: center; }
        .team-info { display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .team-logo-small { width: 30px; height: 30px; object-fit: contain; }
        .score-buttons { display: flex; align-items: center; gap: 10px; }
        .score-display { font-size: 20px; font-weight: 700; min-width: 30px; text-align: center; }
        
        .game-clock-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .clock-inputs {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 20px;
            font-weight: bold;
        }
        .clock-inputs input {
            font-size: 18px;
            width: 70px;
        }
        .clock-actions {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .clock-actions button {
            flex-grow: 1;
        }
        .period-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .period-row {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .period-row button {
            flex-grow: 1;
        }
        .stoppage-time-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .stoppage-time-controls input {
            width: 120px;
        }
        
        .event-controls, .player-profile-controls, .player-stats-controls, .combined-lineup-controls, .match-stats-controls, .scroller-controls, .match-events-controls, .league-events-controls, .player-profile-season-controls, .prediction-controls { display: flex; flex-direction: column; align-items: stretch; gap: 10px; }
        .event-controls > div { display: flex; gap: 10px; width: 100%;}
        .event-controls select, .player-profile-controls select, .player-profile-season-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; flex-grow: 1; }
        .event-controls button, .player-profile-controls .button-row, .player-stats-controls .button-row, .combined-lineup-controls .button-row, .match-stats-controls .button-row, .scroller-controls .button-row, .match-events-controls .button-row, .league-events-controls .button-row, .player-profile-season-controls .button-row, .prediction-controls .button-row { margin-top: 10px; }
        .hidden { display: none !important; }
        .sub-select { width: 50%; }
        .button-row { display: flex; gap: 10px; }
        .button-row button { flex-grow: 1; margin-top: 0 !important; }
        button { padding: 8px 15px; border: none; background-color: #3498db; color: white; border-radius: 5px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
        button:hover { background-color: #2980b9; }
        input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 16px; }

        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>
<body>

    <div class="control-panel-wrapper">
        <header class="panel-header">
            <h1>Scoreboard Control Panel</h1>
        </header>

        <div class="api-status-bar">
            <div class="session-calls">Session API Calls: <span id="session-api-calls">0</span></div>
            <div class="polling-controls-wrapper">
                <span>Live Polling</span>
                <label class="switch">
                    <input type="checkbox" id="polling-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="daily-calls">Daily API Calls: <span id="daily-api-calls">Loading...</span></div>
        </div>

        <div class="fixture-container">
            <div class="fixture-header" id="fixture-header">Fixture Selection</div>
            <div class="data-fetch-section">
                <label for="year-select">Season:</label>
                <select id="year-select">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
                <button id="get-fixtures-btn">Get Fixtures</button>
                
                <label for="fixture-select">Fixture:</label>
                <select id="fixture-select">
                    <option>Select a year first...</option>
                </select>
                <button id="load-fixture-btn">Load Selected Fixture</button>

                <p id="status-text" class="full-width">Select a season and click "Get Fixtures" to begin.</p>
            </div>
        </div>


        <div class="control-grid">
            <div class="control-card">
                <h2 class="card-title">Scoreboard</h2>
                <div class="button-row">
                    <button id="show-scoreboard-btn">Show Scoreboard</button>
                    <button id="hide-scoreboard-btn">Hide Scoreboard</button>
                </div>
            </div>

            <div class="control-card">
                 <h2 class="card-title">Score</h2>
                <div class="score-controls">
                    <div class="team-control">
                        <div class="team-info">
                            <img id="home-logo-control" src="https://placehold.co/30x30/eee/ccc?text=H" class="team-logo-small">
                            <span id="home-name-control">HOME</span>
                        </div>
                        <div class="score-buttons">
                            <button id="home-score-down">-</button>
                            <span id="home-score-display" class="score-display">0</span>
                            <button id="home-score-up">+</button>
                        </div>
                    </div>
                    <div class="team-control">
                        <div class="team-info">
                            <img id="away-logo-control" src="https://placehold.co/30x30/eee/ccc?text=A" class="team-logo-small">
                            <span id="away-name-control">AWAY</span>
                        </div>
                        <div class="score-buttons">
                            <button id="away-score-down">-</button>
                            <span id="away-score-display" class="score-display">0</span>
                            <button id="away-score-up">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Game Clock & Period</h2>
                <div class="game-clock-wrapper">
                    <div class="clock-inputs">
                        <input type="number" id="minutes-input" value="0" min="0">
                        <span>:</span>
                        <input type="number" id="seconds-input" value="0" min="0" max="59">
                    </div>
                    <div class="clock-actions">
                        <button id="set-time-btn">Set</button>
                        <button id="play-pause-btn">Play</button>
                        <button id="reset-time-btn">Reset</button>
                    </div>
                </div>
                <div class="period-controls">
                    <div class="period-row">
                        <button class="period-btn" data-period="1H" data-time="0">1H</button>
                        <button class="period-btn" data-period="HT" data-time="45">HT</button>
                        <button class="period-btn" data-period="2H" data-time="45">2H</button>
                        <button class="period-btn" data-period="FT" data-time="90">FT</button>
                    </div>
                    <div class="period-row">
                        <button class="period-btn" data-period="ET1" data-time="90">ET1</button>
                        <button class="period-btn" data-period="ET2" data-time="105">ET2</button>
                        <button class="period-btn" data-period="PENS" data-time="120">PENS</button>
                    </div>
                </div>
                 <div class="stoppage-time-controls">
                    <input type="number" id="stoppage-input" placeholder="+ Mins" min="0">
                    <button id="show-stoppage-btn">Show</button>
                    <button id="hide-stoppage-btn">Hide</button>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Broadcast Events</h2>
                <div class="event-controls">
                    <select id="event-type-select">
                        <option value="goal">Goal</option>
                        <option value="yellow">Yellow Card</option>
                        <option value="red">Red Card</option>
                        <option value="sub">Substitution</option>
                        <option value="var_goal">VAR: Goal Check</option>
                        <option value="var_no_goal">VAR: No Goal Check</option>
                        <option value="var_penalty">VAR: Penalty Check</option>
                        <option value="var_red">VAR: Red Card Check</option>
                        <option value="var_identity">VAR: Mistaken Identity</option>
                    </select>
                    <div id="single-player-section">
                        <label for="event-player-select">Player:</label>
                        <select id="event-player-select">
                            <option value="">(Load data first)</option>
                        </select>
                    </div>
                    <div id="sub-player-section" class="hidden">
                        <select id="player-off-select" class="sub-select">
                            <option value="">Player Off...</option>
                        </select>
                        <select id="player-on-select" class="sub-select">
                            <option value="">Player On...</option>
                        </select>
                    </div>
                    <div id="var-team-section" class="hidden">
                        <label for="var-team-select">Team:</label>
                        <select id="var-team-select">
                           </select>
                    </div>
                    <button id="trigger-event-btn">Trigger Event</button>
                </div>
            </div>

             <div class="control-card">
                <h2 class="card-title">Player Profile - Match</h2>
                <div class="player-profile-controls">
                    <label for="player-profile-select">Player:</label>
                    <select id="player-profile-select">
                        <option value="">(Load fixture first)</option>
                    </select>
                    <div class="button-row">
                        <button id="show-player-btn">Show Player</button>
                        <button id="hide-player-btn">Hide Player</button>
                    </div>
                </div>
            </div>
            
            <div class="control-card">
                <h2 class="card-title">Player Stats</h2>
                <div class="player-stats-controls">
                    <div class="button-row">
                        <button id="show-player-stats-btn">Show Stats</button>
                        <button id="hide-player-stats-btn">Hide Stats</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Combined Lineup</h2>
                <div class="combined-lineup-controls">
                    <div class="button-row">
                        <button id="show-lineup-btn">Show Lineup</button>
                        <button id="hide-lineup-btn">Hide Lineup</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Match Stats</h2>
                <div class="match-stats-controls">
                    <div class="button-row">
                        <button id="show-match-stats-btn">Show Stats</button>
                        <button id="hide-match-stats-btn">Hide Stats</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Scroller</h2>
                <div class="scroller-controls">
                    <div class="button-row">
                        <button id="show-scroller-btn">Show Scroller</button>
                        <button id="hide-scroller-btn">Hide Scroller</button>
                    </div>
                </div>
            </div>
            
            <div class="control-card">
                <h2 class="card-title">Match Events Ticker</h2>
                <div class="match-events-controls">
                    <div class="button-row">
                        <button id="show-events-btn">Show Ticker</button>
                        <button id="hide-events-btn">Hide Ticker</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">League Events Ticker</h2>
                <div class="league-events-controls">
                    <div class="button-row">
                        <button id="show-league-events-btn">Show Ticker</button>
                        <button id="hide-league-events-btn">Hide Ticker</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Player Profile - Season</h2>
                <div class="player-profile-season-controls">
                    <label for="player-profile-season-select">Player:</label>
                    <select id="player-profile-season-select">
                        <option value="">(Load fixture first)</option>
                    </select>
                    <div class="button-row">
                        <button id="load-player-season-btn">Load Data</button>
                        <button id="show-player-season-btn">Show Player</button>
                        <button id="hide-player-season-btn">Hide Player</button>
                    </div>
                </div>
            </div>
            
            <div class="control-card">
                <h2 class="card-title">Prediction Graphic</h2>
                <div class="prediction-controls">
                    <div class="button-row">
                        <button id="load-prediction-btn">Load Data</button>
                    </div>
                    <div class="button-row">
                        <button id="show-prediction-btn">Show Prediction</button>
                        <button id="hide-prediction-btn">Hide Prediction</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="config.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Firebase and Game State Setup ---
            const scoreboardDocRef = db.collection('scoreboard').doc('liveState');
            const scoreboardVisibilityDocRef = db.collection('scoreboard').doc('visibility');
            const fixtureDocRef = db.collection('scoreboard').doc('currentFixture');
            const playerProfileDocRef = db.collection('scoreboard').doc('playerProfile');
            const playerStatsDocRef = db.collection('scoreboard').doc('playerStats');
            const playerStatsDataDocRef = db.collection('scoreboard').doc('playerStatsData');
            const combinedLineupDocRef = db.collection('scoreboard').doc('combinedLineup');
            const combinedLineupDataDocRef = db.collection('scoreboard').doc('combinedLineupData');
            const matchStatsDocRef = db.collection('scoreboard').doc('matchStats');
            const matchStatsDataDocRef = db.collection('scoreboard').doc('matchStatsData');
            const scrollerDocRef = db.collection('scoreboard').doc('scroller');
            const scrollerDataDocRef = db.collection('scoreboard').doc('scrollerData');
            const matchEventsDocRef = db.collection('scoreboard').doc('matchEvents');
            const matchEventsDataDocRef = db.collection('scoreboard').doc('matchEventsData');
            const leagueEventsDocRef = db.collection('scoreboard').doc('leagueEvents');
            const leagueEventsDataDocRef = db.collection('scoreboard').doc('leagueEventsData');
            const playerProfileSeasonDocRef = db.collection('scoreboard').doc('playerProfileSeason');
            const predictionVisibilityDocRef = db.collection('scoreboard').doc('predictionVisibility');
            const predictionDataDocRef = db.collection('scoreboard').doc('predictionData');

            let gameState = {}; 
            let timerInterval = null;
            let currentFixture = null; 
            let fixturePlayerStats = [];
            let currentLineups = [];
            let statsPollingInterval = null;
            let sessionApiCallCount = 0;
            let loadedSeasonPlayerData = null;

            // --- REMOVED: The tracking variable is no longer needed for the manual refresh approach ---
            // let currentlyShownPlayerId = null;

            // --- Element References ---
            const statusText = document.getElementById('status-text');
            const homeScoreDisplay = document.getElementById('home-score-display');
            const awayScoreDisplay = document.getElementById('away-score-display');
            const minutesInput = document.getElementById('minutes-input');
            const secondsInput = document.getElementById('seconds-input');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const eventTypeSelect = document.getElementById('event-type-select');
            const singlePlayerSection = document.getElementById('single-player-section');
            const subPlayerSection = document.getElementById('sub-player-section');
            const varTeamSection = document.getElementById('var-team-section');
            const eventPlayerSelect = document.getElementById('event-player-select');
            const playerOffSelect = document.getElementById('player-off-select');
            const playerOnSelect = document.getElementById('player-on-select');
            const varTeamSelect = document.getElementById('var-team-select');
            
            const yearSelect = document.getElementById('year-select');
            const getFixturesBtn = document.getElementById('get-fixtures-btn');
            const fixtureSelect = document.getElementById('fixture-select');
            const loadFixtureBtn = document.getElementById('load-fixture-btn');
            const fixtureHeader = document.getElementById('fixture-header');
            const fixtureContainer = document.querySelector('.fixture-container');
            
            const playerProfileSelect = document.getElementById('player-profile-select');
            const showPlayerBtn = document.getElementById('show-player-btn');
            const hidePlayerBtn = document.getElementById('hide-player-btn');

            const showPlayerStatsBtn = document.getElementById('show-player-stats-btn');
            const hidePlayerStatsBtn = document.getElementById('hide-player-stats-btn');
            
            const showLineupBtn = document.getElementById('show-lineup-btn');
            const hideLineupBtn = document.getElementById('hide-lineup-btn');

            const showMatchStatsBtn = document.getElementById('show-match-stats-btn');
            const hideMatchStatsBtn = document.getElementById('hide-match-stats-btn');

            const pollingToggle = document.getElementById('polling-toggle');
            const sessionApiCallsSpan = document.getElementById('session-api-calls');
            const dailyApiCallsSpan = document.getElementById('daily-api-calls');

            const showScrollerBtn = document.getElementById('show-scroller-btn');
            const hideScrollerBtn = document.getElementById('hide-scroller-btn');

            const showScoreboardBtn = document.getElementById('show-scoreboard-btn');
            const hideScoreboardBtn = document.getElementById('hide-scoreboard-btn');
            
            const showEventsBtn = document.getElementById('show-events-btn');
            const hideEventsBtn = document.getElementById('hide-events-btn');

            const showLeagueEventsBtn = document.getElementById('show-league-events-btn');
            const hideLeagueEventsBtn = document.getElementById('hide-league-events-btn');
            
            const playerProfileSeasonSelect = document.getElementById('player-profile-season-select');
            const loadPlayerSeasonBtn = document.getElementById('load-player-season-btn');
            const showPlayerSeasonBtn = document.getElementById('show-player-season-btn');
            const hidePlayerSeasonBtn = document.getElementById('hide-player-season-btn');

            const loadPredictionBtn = document.getElementById('load-prediction-btn');
            const showPredictionBtn = document.getElementById('show-prediction-btn');
            const hidePredictionBtn = document.getElementById('hide-prediction-btn');

            const DC_UNITED_TEAM_ID = 1615;
            const MLS_LEAGUE_ID = 253;

            // --- Toggle for collapsible section ---
            fixtureHeader.addEventListener('click', () => {
                fixtureContainer.classList.toggle('collapsed');
            });

            // --- API Status Functions ---
            async function fetchApiStatus() {
                try {
                    const response = await fetch(`${API_BASE_URL}/status`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                    const data = await response.json();
                    if (data.response && data.response.requests) {
                        dailyApiCallsSpan.textContent = `${data.response.requests.current} / ${data.response.requests.limit_day}`;
                    }
                    updateSessionCallCount();
                } catch (err) {
                    console.error("Error fetching API status:", err);
                    dailyApiCallsSpan.textContent = 'Error';
                }
            }

            function updateSessionCallCount() {
                sessionApiCallsSpan.textContent = sessionApiCallCount;
            }

            // --- Fixture Retrieval and Caching Logic ---
            async function getFixturesForYear() {
                const year = yearSelect.value;
                statusText.textContent = `Checking for saved fixtures for ${year}...`;
                const fixturesDocRef = db.collection('fixtures').doc(year);
                try {
                    const doc = await fixturesDocRef.get();
                    if (doc.exists && doc.data().fixtures && doc.data().fixtures.length > 0 && doc.data().fixtures[0].competition) {
                        statusText.textContent = `Fixtures for ${year} loaded from database.`;
                        populateFixtureSelect(doc.data().fixtures);
                    } else {
                        statusText.textContent = `Fetching fixtures for ${year} from API...`;
                        const response = await fetch(`${API_BASE_URL}/fixtures?season=${year}&team=${DC_UNITED_TEAM_ID}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                        sessionApiCallCount++; updateSessionCallCount();
                        const data = await response.json();
                        if (!data.response || data.response.length === 0) throw new Error(`No fixtures found for ${year}.`);
                        const fixtures = data.response.map(f => ({
                            id: f.fixture.id,
                            name: `${f.teams.home.name} vs ${f.teams.away.name} (${new Date(f.fixture.date).toLocaleDateString()})`,
                            competition: f.league.name
                        }));
                        await fixturesDocRef.set({ fixtures });
                        statusText.textContent = `Fixtures for ${year} fetched and saved.`;
                        populateFixtureSelect(fixtures);
                    }
                } catch (err) {
                    console.error("Error getting fixtures:", err);
                    statusText.textContent = `Error: ${err.message}`;
                    statusText.style.color = 'red';
                }
            }
            
            function populateFixtureSelect(fixtures) {
                fixtureSelect.innerHTML = ''; 
                if (!fixtures || fixtures.length === 0) {
                    fixtureSelect.innerHTML = '<option>No fixtures found</option>';
                    return;
                }
                const groupedByCompetition = fixtures.reduce((acc, fixture) => {
                    const comp = fixture.competition || 'Other';
                    if (!acc[comp]) acc[comp] = [];
                    acc[comp].push(fixture);
                    return acc;
                }, {});
                for (const competition in groupedByCompetition) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = competition;
                    groupedByCompetition[competition].forEach(fixture => {
                        const option = document.createElement('option');
                        option.value = fixture.id;
                        option.textContent = fixture.name;
                        optgroup.appendChild(option);
                    });
                    fixtureSelect.appendChild(optgroup);
                }
            }

            // --- Main Data Loading & Polling Control ---
            async function loadLineupData() {
                stopPolling();
                const fixtureId = fixtureSelect.value;
                if (!fixtureId || isNaN(fixtureId)) {
                    statusText.textContent = "Error: Please select a valid fixture.";
                    statusText.style.color = 'red';
                    return;
                }
                await fetchAllData(fixtureId);
                if (pollingToggle.checked) {
                    startPolling(fixtureId);
                }
            }

            function startPolling(fixtureId) {
                if (statsPollingInterval) clearInterval(statsPollingInterval);
                statsPollingInterval = setInterval(() => pollStatsData(fixtureId), 60000); // 60000ms = 1 minute
                console.log(`Started polling for fixture ${fixtureId} every 60 seconds.`);
                statusText.textContent = `Live polling enabled.`;
            }

            function stopPolling() {
                if (statsPollingInterval) {
                    clearInterval(statsPollingInterval);
                    statsPollingInterval = null;
                    console.log("Stats polling stopped.");
                    statusText.textContent = `Live polling disabled.`;
                }
            }

            pollingToggle.addEventListener('change', () => {
                if (pollingToggle.checked && fixtureSelect.value) {
                    startPolling(fixtureSelect.value);
                } else {
                    stopPolling();
                }
            });

            async function pollStatsData(fixtureId) {
                console.log(`Polling for updated stats for fixture ${fixtureId}...`);
                try {
                    const [playerStatsRes, matchStatsRes, liveFixturesRes, eventsRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/fixtures/players?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures/statistics?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures?live=all`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures/events?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } })
                    ]);
                    sessionApiCallCount += 4; updateSessionCallCount();

                    const playerStatsData = await playerStatsRes.json();
                    const matchStatsData = await matchStatsRes.json();
                    const liveFixturesData = await liveFixturesRes.json();
                    const eventsData = await eventsRes.json();
                    
                    fixturePlayerStats = playerStatsData.response || [];
                    await playerStatsDataDocRef.set({ stats: fixturePlayerStats });
                    
                    // --- REMOVED: The automatic profile update logic has been removed from the polling function. ---
                    
                    let matchStatsDetails = matchStatsData.response || [];
                    await matchStatsDataDocRef.set({ stats: matchStatsDetails });
                    
                    let liveFixtures = liveFixturesData.response || [];
                    const mlsLiveFixtures = liveFixtures.filter(f => f.league.id === MLS_LEAGUE_ID);
                    await scrollerDataDocRef.set({ liveFixtures: mlsLiveFixtures });
                    
                    let matchEvents = eventsData.response || [];
                    await matchEventsDataDocRef.set({ events: matchEvents });

                    let leagueEvents = [];
                    if (mlsLiveFixtures.length > 0) {
                        mlsLiveFixtures.forEach(f => {
                            if(f.events) {
                                f.events.forEach(e => {
                                    leagueEvents.push({...e, fixtureInfo: f});
                                });
                            }
                        });
                    }
                    await leagueEventsDataDocRef.set({ events: leagueEvents });


                    console.log("Live stats updated in Firestore.");
                    statusText.textContent = `Stats updated at ${new Date().toLocaleTimeString()}`;
                    fetchApiStatus();

                } catch (err) {
                    console.error("Error polling for stats:", err);
                }
            }

            async function fetchAllData(fixtureId) {
                statusText.textContent = "Fetching all fixture data...";
                statusText.style.color = '#555';
                try {
                    const [fixtureRes, lineupsRes, playerStatsRes, matchStatsRes, liveFixturesRes, eventsRes] = await Promise.all([
                        fetch(`${API_BASE_URL}/fixtures?id=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures/lineups?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures/players?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures/statistics?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures?live=all`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } }),
                        fetch(`${API_BASE_URL}/fixtures/events?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } })
                    ]);
                    sessionApiCallCount += 6; updateSessionCallCount();

                    const fixtureData = await fixtureRes.json();
                    const lineupsData = await lineupsRes.json();
                    const playerStatsData = await playerStatsRes.json();
                    const matchStatsData = await matchStatsRes.json();
                    const liveFixturesData = await liveFixturesRes.json();
                    const eventsData = await eventsRes.json();

                    if (!fixtureData.response || fixtureData.response.length === 0) throw new Error("Fixture data not found.");
                    
                    const fixtureDetails = fixtureData.response[0];
                    currentFixture = fixtureDetails;
                    const homeId = fixtureDetails.teams.home.id;
                    const awayId = fixtureDetails.teams.away.id;

                    const fixtureForFirestore = {
                        teams: {
                            home: { ...fixtureDetails.teams.home, initials: TEAM_INITIALS[homeId] || '???', color: TEAM_COLORS[homeId] || TEAM_COLORS['default'], altColor: TEAM_COLORS_ALT[homeId] || TEAM_COLORS_ALT['default'] },
                            away: { ...fixtureDetails.teams.away, initials: TEAM_INITIALS[awayId] || '???', color: TEAM_COLORS[awayId] || TEAM_COLORS['default'], altColor: TEAM_COLORS_ALT[awayId] || TEAM_COLORS_ALT['default'] }
                        },
                        league: fixtureDetails.league,
                        fixture: fixtureDetails.fixture,
                        goals: fixtureDetails.goals
                    };
                    await fixtureDocRef.set(fixtureForFirestore);
                    
                    currentLineups = lineupsData.response || [];
                    fixturePlayerStats = playerStatsData.response || [];

                    await playerStatsDataDocRef.set({ stats: fixturePlayerStats });
                    await combinedLineupDataDocRef.set({ lineups: currentLineups });
                    
                    let matchStatsDetails = matchStatsData.response || [];
                    await matchStatsDataDocRef.set({ stats: matchStatsDetails });
                    
                    let liveFixtures = liveFixturesData.response || [];
                    const mlsLiveFixtures = liveFixtures.filter(f => f.league.id === MLS_LEAGUE_ID);
                    await scrollerDataDocRef.set({ liveFixtures: mlsLiveFixtures });

                    let matchEvents = eventsData.response || [];
                    await matchEventsDataDocRef.set({ events: matchEvents });
                    
                    let leagueEvents = [];
                    if (mlsLiveFixtures.length > 0) {
                        mlsLiveFixtures.forEach(f => {
                            if(f.events) {
                                f.events.forEach(e => {
                                    leagueEvents.push({...e, fixtureInfo: f});
                                });
                            }
                        });
                    }
                    await leagueEventsDataDocRef.set({ events: leagueEvents });
                    
                    let statusMessage = `Successfully loaded: ${fixtureDetails.teams.home.name} vs ${fixtureDetails.teams.away.name}.`;
                    if (currentLineups.length === 0) statusMessage += " (Warning: Lineups not available)";
                    
                    statusText.textContent = statusMessage;
                    
                    populateControls(fixtureDetails, currentLineups);
                    populatePlayerProfileSelectFromLineups(currentLineups);
                    populatePlayerProfileSeasonSelect(currentLineups);

                    gameState = { homeScore: 0, awayScore: 0, minutes: 0, seconds: 0, period: '1H', showStoppage: false, event: null };
                    saveState();
                    updateDisplays();
                    fetchApiStatus();

                } catch (err) {
                    console.error("SCOREBOARD APP ERROR:", err);
                    statusText.textContent = `Error: ${err.message}`;
                    statusText.style.color = 'red';
                }
            }

            getFixturesBtn.addEventListener('click', getFixturesForYear);
            loadFixtureBtn.addEventListener('click', loadLineupData);

            // --- UI Population Logic ---
            function populateControls(fixture, lineups) {
                currentFixture = fixture;
                [eventPlayerSelect, playerOffSelect, playerOnSelect].forEach(sel => sel.innerHTML = '');

                document.getElementById('home-name-control').textContent = fixture.teams.home.name;
                document.getElementById('away-name-control').textContent = fixture.teams.away.name;
                document.getElementById('home-logo-control').src = `assets/logos/${fixture.teams.home.id}.png`;
                document.getElementById('away-logo-control').src = `assets/logos/${fixture.teams.away.id}.png`;

                varTeamSelect.innerHTML = `<option value="${fixture.teams.home.id}">${fixture.teams.home.name}</option><option value="${fixture.teams.away.id}">${fixture.teams.away.name}</option>`;

                const populateSelect = (select, teamData) => {
                    const optGroup = document.createElement('optgroup');
                    optGroup.label = teamData.team.name;
                    teamData.startXI.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.player.name;
                        option.dataset.teamId = teamData.team.id;
                        option.textContent = `#${p.player.number} - ${p.player.name}`;
                        optGroup.appendChild(option);
                    });
                    if (teamData.substitutes.length > 0) {
                        const separator = document.createElement('option');
                        separator.disabled = true;
                        separator.textContent = '--- Subs ---';
                        optGroup.appendChild(separator);
                    }
                    teamData.substitutes.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.player.name;
                        option.dataset.teamId = teamData.team.id;
                        option.textContent = `#${p.player.number} - ${p.player.name}`;
                        optGroup.appendChild(option);
                    });
                    select.appendChild(optGroup);
                };

                if (lineups && lineups.length > 0) {
                    const homeTeam = lineups.find(l => l.team.id === fixture.teams.home.id);
                    const awayTeam = lineups.find(l => l.team.id === fixture.teams.away.id);
                    [eventPlayerSelect, playerOffSelect, playerOnSelect].forEach(sel => {
                        sel.appendChild(document.createElement('option')).textContent = 'Select Player...';
                        if (homeTeam) populateSelect(sel, homeTeam);
                        if (awayTeam) populateSelect(sel, awayTeam);
                    });
                } else {
                    [eventPlayerSelect, playerOffSelect, playerOnSelect].forEach(sel => {
                        sel.innerHTML = '<option value="" disabled>Lineups not available</option>';
                    });
                }
            }
            
            function populatePlayerProfileSelectFromLineups(lineups) {
                playerProfileSelect.innerHTML = '';
                if (!lineups || lineups.length === 0) {
                    playerProfileSelect.innerHTML = '<option>Lineups not available</option>';
                    return;
                }

                const createOptionsForTeam = (teamData) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = teamData.team.name;

                    const addPlayerOption = (playerObject) => {
                        const option = document.createElement('option');
                        option.value = playerObject.player.id; 
                        option.textContent = `#${playerObject.player.number} - ${playerObject.player.name}`;
                        optgroup.appendChild(option);
                    };

                    teamData.startXI.forEach(addPlayerOption);

                    if (teamData.substitutes.length > 0) {
                        const separator = document.createElement('option');
                        separator.disabled = true;
                        separator.textContent = '--- Substitutes ---';
                        optgroup.appendChild(separator);
                    }
                    
                    teamData.substitutes.forEach(addPlayerOption);
                    playerProfileSelect.appendChild(optgroup);
                };
                
                const homeTeamData = lineups.find(l => l.team.id === currentFixture.teams.home.id);
                const awayTeamData = lineups.find(l => l.team.id === currentFixture.teams.away.id);

                if (homeTeamData) createOptionsForTeam(homeTeamData);
                if (awayTeamData) createOptionsForTeam(awayTeamData);
            }
            
            function populatePlayerProfileSeasonSelect(lineups) {
                playerProfileSeasonSelect.innerHTML = '';
                loadedSeasonPlayerData = null; 
                if (!lineups || lineups.length === 0) {
                    playerProfileSeasonSelect.innerHTML = '<option>Lineups not available</option>';
                    return;
                }

                const createOptionsForTeam = (teamData) => {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = teamData.team.name;

                    const addPlayerOption = (playerObject) => {
                        const option = document.createElement('option');
                        option.value = playerObject.player.id;
                        option.textContent = `#${playerObject.player.number} - ${playerObject.player.name}`;
                        optgroup.appendChild(option);
                    };

                    teamData.startXI.forEach(addPlayerOption);

                    if (teamData.substitutes.length > 0) {
                        const separator = document.createElement('option');
                        separator.disabled = true;
                        separator.textContent = '--- Substitutes ---';
                        optgroup.appendChild(separator);
                    }

                    teamData.substitutes.forEach(addPlayerOption);

                    playerProfileSeasonSelect.appendChild(optgroup);
                };
                
                const homeTeamData = lineups.find(l => l.team.id === currentFixture.teams.home.id);
                const awayTeamData = lineups.find(l => l.team.id === currentFixture.teams.away.id);

                if (homeTeamData) createOptionsForTeam(homeTeamData);
                if (awayTeamData) createOptionsForTeam(awayTeamData);
            }

            // --- Core Scoreboard Logic ---
            function saveState() {
                scoreboardDocRef.set(gameState).catch(error => console.error("Error writing to Firestore: ", error));
            }
            
            function updateDisplays() {
                homeScoreDisplay.textContent = gameState.homeScore || 0;
                awayScoreDisplay.textContent = gameState.awayScore || 0;
                minutesInput.value = gameState.minutes || 0;
                secondsInput.value = gameState.seconds || 0;
            }

            // --- Event Listeners ---
            document.getElementById('home-score-up').addEventListener('click', () => { gameState.homeScore++; saveState(); updateDisplays(); });
            document.getElementById('home-score-down').addEventListener('click', () => { if (gameState.homeScore > 0) gameState.homeScore--; saveState(); updateDisplays(); });
            document.getElementById('away-score-up').addEventListener('click', () => { gameState.awayScore++; saveState(); updateDisplays(); });
            document.getElementById('away-score-down').addEventListener('click', () => { if (gameState.awayScore > 0) gameState.awayScore--; saveState(); updateDisplays(); });
            document.getElementById('set-time-btn').addEventListener('click', () => {
                gameState.minutes = parseInt(minutesInput.value) || 0;
                gameState.seconds = parseInt(secondsInput.value) || 0;
                saveState(); updateDisplays();
            });
            playPauseBtn.addEventListener('click', () => {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    playPauseBtn.textContent = 'Play';
                } else {
                    playPauseBtn.textContent = 'Pause';
                    timerInterval = setInterval(() => {
                        gameState.seconds++;
                        if (gameState.seconds >= 60) { gameState.seconds = 0; gameState.minutes++; }
                        saveState(); updateDisplays();
                    }, 1000);
                }
            });
            document.getElementById('reset-time-btn').addEventListener('click', () => {
                if (timerInterval) { clearInterval(timerInterval); timerInterval = null; playPauseBtn.textContent = 'Play'; }
                gameState.minutes = 0;
                gameState.seconds = 0;
                saveState(); updateDisplays();
            });
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    gameState.period = btn.dataset.period;
                    gameState.minutes = parseInt(btn.dataset.time);
                    gameState.seconds = 0;
                    if (timerInterval) { clearInterval(timerInterval); timerInterval = null; playPauseBtn.textContent = 'Play'; }
                    saveState();
                    updateDisplays();
                });
            });
            document.getElementById('show-stoppage-btn').addEventListener('click', () => {
                gameState.stoppageTime = document.getElementById('stoppage-input').value;
                gameState.showStoppage = true;
                saveState();
            });
            document.getElementById('hide-stoppage-btn').addEventListener('click', () => {
                gameState.showStoppage = false;
                saveState();
            });

            eventTypeSelect.addEventListener('change', () => {
                const type = eventTypeSelect.value;
                const isSub = type === 'sub';
                const isVar = type.startsWith('var');
                
                singlePlayerSection.classList.toggle('hidden', isSub || isVar);
                subPlayerSection.classList.toggle('hidden', !isSub);
                varTeamSection.classList.toggle('hidden', !isVar);
            });

            document.getElementById('trigger-event-btn').addEventListener('click', () => {
                if (!currentFixture) {
                    statusText.textContent = "Please load a fixture before triggering an event.";
                    statusText.style.color = 'red';
                    return;
                }
                const type = eventTypeSelect.value;
                let eventData = {};

                if (type === 'sub') {
                    const playerOnOption = playerOnSelect.options[playerOnSelect.selectedIndex];
                    const playerOffOption = playerOffSelect.options[playerOffSelect.selectedIndex];
                    if (!playerOnOption.value || !playerOffOption.value) return;
                    eventData = { playerOn: playerOnOption.value, playerOff: playerOffOption.value, teamId: playerOnOption.dataset.teamId };
                } else if (type.startsWith('var')) {
                    eventData = { teamId: varTeamSelect.value };
                } else {
                    const playerOption = eventPlayerSelect.options[eventPlayerSelect.selectedIndex];
                    if (!playerOption.value) return;
                    eventData = { player: playerOption.value, teamId: playerOption.dataset.teamId };
                }
                
                const eventId = new Date().getTime();
                gameState.event = { type, data: eventData, id: eventId };

                if (type === 'goal') {
                    const scoringTeamId = eventData.teamId;
                    if (scoringTeamId == currentFixture.teams.home.id) {
                        gameState.homeScore++;
                    } else if (scoringTeamId == currentFixture.teams.away.id) {
                        gameState.awayScore++;
                    }
                    updateDisplays();
                }
                
                saveState();

                setTimeout(() => {
                    if (gameState.event && gameState.event.id === eventId) {
                        gameState.event = null;
                        saveState();
                    }
                }, 11000);
            });
            
            // --- MODIFIED: The "Show Player" button now fetches fresh data on every click ---
            showPlayerBtn.addEventListener('click', async () => {
                const selectedPlayerId = playerProfileSelect.value;
                const fixtureId = fixtureSelect.value;
                if (!selectedPlayerId) {
                    statusText.textContent = 'Please select a player.';
                    statusText.style.color = 'red';
                    return;
                }
                if (!fixtureId) {
                    statusText.textContent = 'Please load a fixture first.';
                    statusText.style.color = 'red';
                    return;
                }

                try {
                    // REASON: This new section fetches the latest player stats for the fixture right when the button is clicked.
                    // This ensures the data is always up-to-date without needing constant polling.
                    statusText.textContent = 'Fetching latest player stats...';
                    const playerStatsRes = await fetch(`${API_BASE_URL}/fixtures/players?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                    sessionApiCallCount++;
                    updateSessionCallCount();
                    
                    const playerStatsData = await playerStatsRes.json();
                    // Update our local copy of the stats with the fresh data
                    fixturePlayerStats = playerStatsData.response || [];
                    statusText.textContent = 'Latest stats fetched. Building profile...';
                    
                } catch (err) {
                    console.error("Error fetching latest player stats:", err);
                    statusText.textContent = `Error fetching stats: ${err.message}`;
                    statusText.style.color = 'red';
                    // We can still proceed with possibly stale data if the fetch fails
                }

                // The rest of the logic remains the same, but now operates on the freshly fetched data
                let playerInfo = null;
                let teamInfo = null;
                let playerStats = null;

                for (const team of fixturePlayerStats) {
                    const foundPlayer = team.players.find(p => p.player.id == selectedPlayerId);
                    if (foundPlayer) {
                        playerInfo = foundPlayer.player;
                        teamInfo = team.team;
                        playerStats = foundPlayer.statistics[0];
                        break;
                    }
                }

                if (!playerInfo) {
                    for (const lineup of currentLineups) {
                        const allPlayers = [...lineup.startXI, ...lineup.substitutes];
                        const foundPlayerInLineup = allPlayers.find(p => p.player.id == selectedPlayerId);
                        if (foundPlayerInLineup) {
                            playerInfo = foundPlayerInLineup.player;
                            teamInfo = lineup.team;
                            break;
                        }
                    }
                    
                    if (playerInfo) {
                        playerStats = {
                            games: { minutes: null, number: playerInfo.number, position: playerInfo.pos, rating: null, captain: false, substitute: false },
                            shots: { total: null, on: null },
                            goals: { total: 0, conceded: 0, assists: null, saves: null },
                            passes: { total: null, key: null, accuracy: null },
                            tackles: { total: null, blocks: null, interceptions: null },
                            duels: { total: null, won: null },
                            dribbles: { attempts: null, success: null, past: null },
                            fouls: { drawn: null, committed: null },
                            cards: { yellow: 0, red: 0 },
                            penalty: { won: null, commited: null, scored: 0, missed: 0, saved: null }
                        };
                    }
                }

                if (playerInfo && teamInfo && playerStats) {
                    const dataForFirestore = { show: true, player: playerInfo, stats: playerStats, team: teamInfo };
                    playerProfileDocRef.set(dataForFirestore);
                    statusText.textContent = `Showing profile for ${playerInfo.name}.`;
                    statusText.style.color = '#555';
                } else {
                    statusText.textContent = `Could not find data for selected player.`;
                    statusText.style.color = 'red';
                }
            });

            hidePlayerBtn.addEventListener('click', () => {
                playerProfileDocRef.set({ show: false });
                statusText.textContent = 'Player profile hidden.';
                statusText.style.color = '#555';
            });

            showPlayerStatsBtn.addEventListener('click', () => {
                playerStatsDocRef.set({ show: true });
                statusText.textContent = 'Showing player stats comparison.';
                statusText.style.color = '#555';
            });

            hidePlayerStatsBtn.addEventListener('click', () => {
                playerStatsDocRef.set({ show: false });
                statusText.textContent = 'Player stats comparison hidden.';
                statusText.style.color = '#555';
            });

            showLineupBtn.addEventListener('click', () => {
                combinedLineupDocRef.set({ show: true });
                statusText.textContent = 'Showing combined lineup.';
                statusText.style.color = '#555';
            });

            hideLineupBtn.addEventListener('click', () => {
                combinedLineupDocRef.set({ show: false });
                statusText.textContent = 'Combined lineup hidden.';
                statusText.style.color = '#555';
            });

            showMatchStatsBtn.addEventListener('click', () => {
                matchStatsDocRef.set({ show: true });
                statusText.textContent = 'Showing match stats.';
                statusText.style.color = '#555';
            });

            hideMatchStatsBtn.addEventListener('click', () => {
                matchStatsDocRef.set({ show: false });
                statusText.textContent = 'Match stats hidden.';
                statusText.style.color = '#555';
            });

            showScrollerBtn.addEventListener('click', () => {
                scrollerDocRef.set({ show: true });
                statusText.textContent = 'Showing scroller.';
                statusText.style.color = '#555';
            });

            hideScrollerBtn.addEventListener('click', () => {
                scrollerDocRef.set({ show: false });
                statusText.textContent = 'Scroller hidden.';
                statusText.style.color = '#555';
            });

            showScoreboardBtn.addEventListener('click', () => {
                scoreboardVisibilityDocRef.set({ show: true });
                statusText.textContent = 'Showing scoreboard.';
                statusText.style.color = '#555';
            });

            hideScoreboardBtn.addEventListener('click', () => {
                scoreboardVisibilityDocRef.set({ show: false });
                statusText.textContent = 'Scoreboard hidden.';
                statusText.style.color = '#555';
            });

            showEventsBtn.addEventListener('click', () => {
                matchEventsDocRef.set({ show: true });
                statusText.textContent = 'Showing match events ticker.';
                statusText.style.color = '#555';
            });

            hideEventsBtn.addEventListener('click', () => {
                matchEventsDocRef.set({ show: false });
                statusText.textContent = 'Match events ticker hidden.';
                statusText.style.color = '#555';
            });

            showLeagueEventsBtn.addEventListener('click', () => {
                leagueEventsDocRef.set({ show: true });
                statusText.textContent = 'Showing league events ticker.';
                statusText.style.color = '#555';
            });

            hideLeagueEventsBtn.addEventListener('click', () => {
                leagueEventsDocRef.set({ show: false });
                statusText.textContent = 'League events ticker hidden.';
                statusText.style.color = '#555';
            });
            
            loadPlayerSeasonBtn.addEventListener('click', async () => {
                const selectedPlayerId = playerProfileSeasonSelect.value;
                if (!selectedPlayerId || !currentFixture) {
                    statusText.textContent = 'Please select a fixture and a player first.';
                    statusText.style.color = 'red';
                    return;
                }

                statusText.textContent = `Loading season data for player...`;
                statusText.style.color = '#555';

                try {
                    const response = await fetch(`${API_BASE_URL}/players?id=${selectedPlayerId}&season=${currentFixture.league.season}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                    sessionApiCallCount++; 
                    updateSessionCallCount();
                    fetchApiStatus();

                    const playerData = await response.json();
                    if (!playerData.response || playerData.response.length === 0) {
                        throw new Error("Player season data not found from API.");
                    }
                    
                    const rawPlayerData = playerData.response[0];
                    loadedSeasonPlayerData = {
                        player: rawPlayerData.player,
                        statistics: rawPlayerData.statistics
                    };

                    statusText.textContent = `Loaded data for ${loadedSeasonPlayerData.player.name}. Ready to show.`;
                    statusText.style.color = 'green';

                } catch (err) {
                    console.error("Error fetching player season data:", err);
                    statusText.textContent = `Error: ${err.message}`;
                    statusText.style.color = 'red';
                    loadedSeasonPlayerData = null;
                }
            });

            showPlayerSeasonBtn.addEventListener('click', () => {
                const selectedPlayerId = playerProfileSeasonSelect.value;
                if (!selectedPlayerId) {
                    statusText.textContent = 'Please select a player.';
                    statusText.style.color = 'red';
                    return;
                }
                
                if (!loadedSeasonPlayerData) {
                    statusText.textContent = 'Please click "Load Data" for the selected player first.';
                    statusText.style.color = 'red';
                    return;
                }

                if (loadedSeasonPlayerData.player.id != selectedPlayerId) {
                    statusText.textContent = `Data for a different player is loaded. Click "Load Data" again.`;
                    statusText.style.color = 'red';
                    return;
                }

                playerProfileSeasonDocRef.set({ show: true, data: loadedSeasonPlayerData });
                statusText.textContent = `Showing season profile for ${loadedSeasonPlayerData.player.name}.`;
                statusText.style.color = '#555';
            });

            hidePlayerSeasonBtn.addEventListener('click', () => {
                playerProfileSeasonDocRef.set({ show: false, data: null });
                loadedSeasonPlayerData = null;
                statusText.textContent = 'Season player profile hidden.';
                statusText.style.color = '#555';
            });

            // --- Prediction Graphic Logic ---
            loadPredictionBtn.addEventListener('click', async () => {
                const fixtureId = fixtureSelect.value;
                if (!fixtureId) {
                    statusText.textContent = "Please select a fixture first.";
                    statusText.style.color = 'red';
                    return;
                }
                statusText.textContent = "Loading prediction data...";
                statusText.style.color = '#555';
                try {
                    const response = await fetch(`${API_BASE_URL}/predictions?fixture=${fixtureId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                    sessionApiCallCount++;
                    updateSessionCallCount();
                    fetchApiStatus();

                    const data = await response.json();
                    if (!data.response || data.response.length === 0) {
                        throw new Error("Prediction data not found for this fixture.");
                    }
                    
                    await predictionDataDocRef.set({ data: data.response[0] });
                    statusText.textContent = "Prediction data loaded successfully.";
                    statusText.style.color = 'green';

                } catch (err) {
                    console.error("Error loading prediction data:", err);
                    statusText.textContent = `Error: ${err.message}`;
                    statusText.style.color = 'red';
                }
            });

            showPredictionBtn.addEventListener('click', () => {
                predictionVisibilityDocRef.set({ show: true });
                statusText.textContent = 'Showing prediction graphic.';
                statusText.style.color = '#555';
            });

            hidePredictionBtn.addEventListener('click', () => {
                predictionVisibilityDocRef.set({ show: false });
                statusText.textContent = 'Prediction graphic hidden.';
                statusText.style.color = '#555';
            });


            // --- Initial Load ---
            scoreboardDocRef.get().then((doc) => {
                if (doc.exists) gameState = doc.data();
                else gameState = { homeScore: 0, awayScore: 0, minutes: 0, seconds: 0, period: '1H', showStoppage: false, event: null };
                updateDisplays();
                getFixturesForYear();
                fetchApiStatus();
            });
        });
    </script>
</body>
</html>