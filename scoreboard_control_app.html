<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Control App</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        /* --- Global & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .control-panel-wrapper { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; }
        .panel-header h1 { margin: 0; font-size: 24px; }
        
        .api-status-bar {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            font-size: 14px;
        }
        .api-status-bar .session-calls { text-align: left; }
        .api-status-bar .daily-calls { text-align: right; }
        .api-status-bar span { font-weight: bold; }
        .polling-controls-wrapper { display: flex; justify-content: center; align-items: center; gap: 10px; }
        
        .fixture-container {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .fixture-header {
            padding: 15px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
         .fixture-header::after {
            content: '▲';
            transition: transform 0.3s ease;
        }
        .fixture-container.collapsed .fixture-header::after {
             transform: rotate(180deg);
        }
        .data-fetch-section {
            padding: 15px;
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 15px;
            max-height: 500px;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
        }
        .fixture-container.collapsed .data-fetch-section {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            overflow: hidden;
        }

        .data-fetch-section label { font-weight: bold; }
        .data-fetch-section select, .data-fetch-section button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 14px;
            width: 100%;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        #status-text {
            margin-top: 10px;
            color: #555;
            font-style: italic;
        }

        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .control-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; }
        .card-title { margin-top: 0; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .score-controls { display: flex; flex-direction: column; gap: 15px; }
        .team-control { display: flex; justify-content: space-between; align-items: center; }
        .team-info { display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .team-logo-small { width: 30px; height: 30px; object-fit: contain; }
        .score-buttons { display: flex; align-items: center; gap: 10px; }
        .score-display { font-size: 20px; font-weight: 700; min-width: 30px; text-align: center; }
        
        .game-clock-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .clock-inputs {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 20px;
            font-weight: bold;
        }
        .clock-inputs input {
            font-size: 18px;
            width: 70px;
        }
        .clock-actions {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .clock-actions button {
            flex-grow: 1;
        }
        .period-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .period-row {
            display: flex;
            gap: 10px;
            width: 100%;
        }
        .period-row button {
            flex-grow: 1;
        }
        .stoppage-time-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        .stoppage-time-controls input {
            width: 120px;
        }
        
        .event-controls, .player-profile-controls, .player-stats-controls, .combined-lineup-controls, .match-stats-controls, .scroller-controls, .match-events-controls, .league-events-controls, .player-profile-season-controls, .prediction-controls { display: flex; flex-direction: column; align-items: stretch; gap: 10px; }
        .event-controls > div { display: flex; gap: 10px; width: 100%;}
        .event-controls select, .player-profile-controls select, .player-profile-season-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; flex-grow: 1; }
        .event-controls button, .player-profile-controls .button-row, .player-stats-controls .button-row, .combined-lineup-controls .button-row, .match-stats-controls .button-row, .scroller-controls .button-row, .match-events-controls .button-row, .league-events-controls .button-row, .player-profile-season-controls .button-row, .prediction-controls .button-row { margin-top: 10px; }
        .hidden { display: none !important; }
        .sub-select { width: 50%; }
        .button-row { display: flex; gap: 10px; }
        .button-row button { flex-grow: 1; margin-top: 0 !important; }
        button { padding: 8px 15px; border: none; background-color: #3498db; color: white; border-radius: 5px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
        button:hover { background-color: #2980b9; }
        input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 16px; }

        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(26px); }
    </style>
</head>
<body>
    <div class="control-panel-wrapper">
        <header class="panel-header">
            <h1>Scoreboard Control Panel</h1>
        </header>

        <div class="api-status-bar">
            <div class="session-calls">Session API Calls: <span id="session-api-calls">0</span></div>
            <div class="polling-controls-wrapper">
                <span>Live Polling</span>
                <label class="switch">
                    <input type="checkbox" id="polling-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="daily-calls">Daily API Calls: <span id="daily-api-calls">Loading...</span></div>
        </div>

        <div class="fixture-container">
            <div class="fixture-header" id="fixture-header">Fixture Selection</div>
            <div class="data-fetch-section">
                <label for="year-select">Season:</label>
                <select id="year-select">
                    <option value="2025">2025</option>
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                </select>
                <button id="get-fixtures-btn">Get Fixtures</button>
                
                <label for="fixture-select">Fixture:</label>
                <select id="fixture-select">
                    <option>Select a year first...</option>
                </select>
                <button id="load-fixture-btn">Load Selected Fixture</button>

                <p id="status-text" class="full-width">Select a season and click "Get Fixtures" to begin.</p>
            </div>
        </div>


        <div class="control-grid">
            <div class="control-card">
                <h2 class="card-title">Scoreboard</h2>
                <div class="button-row">
                    <button id="show-scoreboard-btn">Show Scoreboard</button>
                    <button id="hide-scoreboard-btn">Hide Scoreboard</button>
                </div>
            </div>

            <div class="control-card">
                 <h2 class="card-title">Score</h2>
                <div class="score-controls">
                    <div class="team-control">
                        <div class="team-info">
                            <img id="home-logo-control" src="https://placehold.co/30x30/eee/ccc?text=H" class="team-logo-small">
                            <span id="home-name-control">HOME</span>
                        </div>
                        <div class="score-buttons">
                            <button id="home-score-down">-</button>
                            <span id="home-score-display" class="score-display">0</span>
                            <button id="home-score-up">+</button>
                        </div>
                    </div>
                    <div class="team-control">
                        <div class="team-info">
                            <img id="away-logo-control" src="https://placehold.co/30x30/eee/ccc?text=A" class="team-logo-small">
                            <span id="away-name-control">AWAY</span>
                        </div>
                        <div class="score-buttons">
                            <button id="away-score-down">-</button>
                            <span id="away-score-display" class="score-display">0</span>
                            <button id="away-score-up">+</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Game Clock & Period</h2>
                <div class="game-clock-wrapper">
                    <div class="clock-inputs">
                        <input type="number" id="minutes-input" value="0" min="0">
                        <span>:</span>
                        <input type="number" id="seconds-input" value="0" min="0" max="59">
                    </div>
                    <div class="clock-actions">
                        <button id="set-time-btn">Set</button>
                        <button id="play-pause-btn">Play</button>
                        <button id="reset-time-btn">Reset</button>
                    </div>
                </div>
                <div class="period-controls">
                    <div class="period-row">
                        <button class="period-btn" data-period="1H" data-time="0">1H</button>
                        <button class="period-btn" data-period="HT" data-time="45">HT</button>
                        <button class="period-btn" data-period="2H" data-time="45">2H</button>
                        <button class="period-btn" data-period="FT" data-time="90">FT</button>
                    </div>
                    <div class="period-row">
                        <button class="period-btn" data-period="ET1" data-time="90">ET1</button>
                        <button class="period-btn" data-period="ET2" data-time="105">ET2</button>
                        <button class="period-btn" data-period="PENS" data-time="120">PENS</button>
                    </div>
                </div>
                 <div class="stoppage-time-controls">
                    <input type="number" id="stoppage-input" placeholder="+ Mins" min="0">
                    <button id="show-stoppage-btn">Show</button>
                    <button id="hide-stoppage-btn">Hide</button>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Broadcast Events</h2>
                <div class="event-controls">
                    <select id="event-type-select">
                        <option value="goal">Goal</option>
                        <option value="yellow">Yellow Card</option>
                        <option value="red">Red Card</option>
                        <option value="sub">Substitution</option>
                        <option value="var_goal">VAR: Goal Check</option>
                        <option value="var_no_goal">VAR: No Goal Check</option>
                        <option value="var_penalty">VAR: Penalty Check</option>
                        <option value="var_red">VAR: Red Card Check</option>
                        <option value="var_identity">VAR: Mistaken Identity</option>
                    </select>
                    <div id="single-player-section">
                        <label for="event-player-select">Player:</label>
                        <select id="event-player-select">
                            <option value="">(Load data first)</option>
                        </select>
                    </div>
                    <div id="sub-player-section" class="hidden">
                        <select id="player-off-select" class="sub-select">
                            <option value="">Player Off...</option>
                        </select>
                        <select id="player-on-select" class="sub-select">
                            <option value="">Player On...</option>
                        </select>
                    </div>
                    <div id="var-team-section" class="hidden">
                        <label for="var-team-select">Team:</label>
                        <select id="var-team-select">
                           </select>
                    </div>
                    <button id="trigger-event-btn">Trigger Event</button>
                </div>
            </div>

             <div class="control-card">
                <h2 class="card-title">Player Profile - Match</h2>
                <div class="player-profile-controls">
                    <label for="player-profile-select">Player:</label>
                    <select id="player-profile-select">
                        <option value="">(Load fixture first)</option>
                    </select>
                    <div class="button-row">
                        <button id="show-player-btn">Show Player</button>
                        <button id="hide-player-btn">Hide Player</button>
                    </div>
                </div>
            </div>
            
            <div class="control-card">
                <h2 class="card-title">Player Stats</h2>
                <div class="player-stats-controls">
                    <div class="button-row">
                        <button id="show-player-stats-btn">Show Stats</button>
                        <button id="hide-player-stats-btn">Hide Stats</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Combined Lineup</h2>
                <div class="combined-lineup-controls">
                    <div class="button-row">
                        <button id="show-lineup-btn">Show Lineup</button>
                        <button id="hide-lineup-btn">Hide Lineup</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Match Stats</h2>
                <div class="match-stats-controls">
                    <div class="button-row">
                        <button id="show-match-stats-btn">Show Stats</button>
                        <button id="hide-match-stats-btn">Hide Stats</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Scroller</h2>
                <div class="scroller-controls">
                    <div class="button-row">
                        <button id="show-scroller-btn">Show Scroller</button>
                        <button id="hide-scroller-btn">Hide Scroller</button>
                    </div>
                </div>
            </div>
            
            <div class="control-card">
                <h2 class="card-title">Match Events Ticker</h2>
                <div class="match-events-controls">
                    <div class="button-row">
                        <button id="show-events-btn">Show Ticker</button>
                        <button id="hide-events-btn">Hide Ticker</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">League Events Ticker</h2>
                <div class="league-events-controls">
                    <div class="button-row">
                        <button id="show-league-events-btn">Show Ticker</button>
                        <button id="hide-league-events-btn">Hide Ticker</button>
                    </div>
                </div>
            </div>

            <div class="control-card">
                <h2 class="card-title">Player Profile - Season</h2>
                <div class="player-profile-season-controls">
                    <label for="player-profile-season-select">Player:</label>
                    <select id="player-profile-season-select">
                        <option value="">(Load fixture first)</option>
                    </select>
                    <div class="button-row">
                        <button id="load-player-season-btn">Load Data</button>
                        <button id="show-player-season-btn">Show Player</button>
                        <button id="hide-player-season-btn">Hide Player</button>
                    </div>
                </div>
            </div>
            
            <div class="control-card">
                <h2 class="card-title">Prediction Graphic</h2>
                <div class="prediction-controls">
                    <div class="button-row">
                        <button id="load-prediction-btn">Load Data</button>
                    </div>
                    <div class="button-row">
                        <button id="show-prediction-btn">Show Prediction</button>
                        <button id="hide-prediction-btn">Hide Prediction</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: Firebase config is now embedded directly in the script ---
            // REASON: This removes the need for extra files and keeps the app self-contained.
            const TEAM_COLORS = {
  1595: 'rgb(85, 150, 71)',     // Seattle Sounders FC (Green)
  1596: 'rgb(0, 102, 175)',     // San Jose Earthquakes (Blue)
  1597: 'rgb(222, 53, 56)',     // FC Dallas (Red)
  1598: 'rgb(101, 44, 144)',    // Orlando City SC (Purple)
  1599: 'rgb(181, 152, 90)',    // Philadelphia Union (Gold)
  1600: 'rgb(245, 128, 44)',    // Houston Dynamo FC (Orange)
  1601: 'rgb(222, 53, 56)',     // Toronto FC (Red)
  1602: 'rgb(217, 39, 46)',     // New York Red Bulls (Red)
  1603: 'rgb(15, 49, 92)',      // Vancouver Whitecaps FC (Dark Blue)
  1604: 'rgb(108, 169, 223)',   // New York City FC (Sky Blue)
  1605: 'rgb(0, 40, 85)',       // LA Galaxy (Dark Blue)
  1606: 'rgb(205, 34, 53)',     // Real Salt Lake (Red)
  1607: 'rgb(229, 26, 55)',     // Chicago Fire FC (Red)
  1608: 'rgb(141, 22, 44)',     // Atlanta United FC (Dark Red)
  1609: '#021D3D',     // New England Revolution (Dark Blue)
  1610: 'rgb(149, 29, 64)',     // Colorado Rapids (Burgundy)
  1611: 'rgb(80, 132, 185)',    // Sporting Kansas City (Light Blue)
  1612: 'rgb(143, 201, 232)',   // Minnesota United FC (Sky Blue)
  1613: 'rgb(254, 222, 0)',     // Columbus Crew (Yellow)
  1614: 'rgb(0, 85, 155)',      // CF Montréal (Blue)
  1615: 'rgb(239, 62, 65)',      // D.C. United (Red)
  1616: 'rgb(193, 162, 92)',     // Los Angeles FC (Gold)
  1617: 'rgb(0, 70, 41)',        // Portland Timbers (Green)
  2242: 'rgb(241, 91, 36)',      // FC Cincinnati (Orange)
  9568: 'rgb(252, 185, 205)',    // Inter Miami CF (Pink)
  9569: 'rgb(254, 219, 0)',      // Nashville SC (Yellow)
  16489: 'rgb(0, 182, 75)',      // Austin FC (Bright Green)
  18310: 'rgb(91, 192, 240)',    // Charlotte FC (Blue)
  20787: 'rgb(217, 2, 79)',      // St. Louis City SC (Magenta)
  25484: 'rgb(11, 46, 75)',      // San Diego FC (Dark Blue)
 

  // Add any other team IDs and their colors here...

  // A default color for any team not in this list
  'default': 'rgba(66, 65, 65, 1)' 
};
const TEAM_COLORS_ALT = {
  1595: '#003C71',     // Seattle Sounders FC (Sounder Blue)
  1596: '#000000',     // San Jose Earthquakes (Black)
  1597: '#003E7B',     // FC Dallas (Brazos Blue)
  1598: '#FFD100',     // Orlando City SC (Gold)
  1599: '#0A2240',     // Philadelphia Union (Union Blue)
  1600: '#000000',     // Houston Dynamo FC (Black)
  1601: '#231F20',     // Toronto FC (Onyx/Dark Grey)
  1602: '#FFC700',     // New York Red Bulls (Yellow)
  1603: '#92C1E9',     // Vancouver Whitecaps FC (Whitecaps Blue)
  1604: '#002654',     // New York City FC (Midnight Blue)
  1605: '#FFD200',     // LA Galaxy (Galaxy Gold)
  1606: '#013A81',     // Real Salt Lake (Cobalt Blue)
  1607: '#001E61',     // Chicago Fire FC (Navy Blue)
  1608: '#A48A5A',     // Atlanta United FC (Dark Gold)
  1609: '#E51938',     // New England Revolution (Revolution Red)
  1610: '#569FD3',     // Colorado Rapids (Sky Blue)
  1611: '#002F65',     // Sporting Kansas City (Dark Indigo)
  1612: '#58595B',     // Minnesota United FC (Iron Grey)
  1613: '#000000',     // Columbus Crew (Black)
  1614: '#000000',     // CF Montréal (Black)
  1615: '#000000',     // D.C. United (Black)
  1616: '#000000',     // Los Angeles FC (Black)
  1617: '#E1A023',     // Portland Timbers (Timbers Gold)
  2242: '#003067',     // FC Cincinnati (FCC Blue)
  9568: '#000000',     // Inter Miami CF (Black)
  9569: '#001F5B',     // Nashville SC (Acoustic Blue)
  16489: '#000000',    // Austin FC (Black)
  18310: '#000000',    // Charlotte FC (Black)
  20787: '#001D4C',    // St. Louis City SC (River Blue)
  25484: '#F5831F',    // San Diego FC (Horizon Orange)
  'default': 'rgb(255, 255, 255)' // A default alternate color
};
const TEAM_INITIALS = {
  1595: 'SEA',   // Seattle Sounders FC
  1596: 'SJE',   // San Jose Earthquakes
  1597: 'DAL',   // FC Dallas
  1598: 'ORL',   // Orlando City SC
  1599: 'PHI',   // Philadelphia Union
  1600: 'HOU',   // Houston Dynamo FC
  1601: 'TOR',   // Toronto FC
  1602: 'NYRB',  // New York Red Bulls
  1603: 'VAN',   // Vancouver Whitecaps FC
  1604: 'NYC',   // New York City FC
  1605: 'LAG',   // LA Galaxy
  1606: 'RSL',   // Real Salt Lake
  1607: 'CHI',   // Chicago Fire FC
  1608: 'ATL',   // Atlanta United FC
  1609: 'NER',   // New England Revolution
  1610: 'COL',   // Colorado Rapids
  1611: 'SKC',   // Sporting Kansas City
  1612: 'MIN',   // Minnesota United FC
  1613: 'CLB',   // Columbus Crew
  1614: 'MTL',   // CF Montréal
  1615: 'DCU',   // D.C. United
  1616: 'LAFC',  // Los Angeles FC
  1617: 'POR',   // Portland Timbers
  2242: 'CIN',   // FC Cincinnati
  9568: 'MIA',   // Inter Miami CF
  9569: 'NSH',   // Nashville SC
  16489: 'AUS',  // Austin FC
  18310: 'CLT',  // Charlotte FC
  20787: 'STL',  // St. Louis City SC
  25484: 'SAN',  // San Diego FC
  // Add all other team initials here...
  'default': '???'
};

            const firebaseConfig = {
                apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
  authDomain: "scoreboard-control.firebaseapp.com",
  projectId: "scoreboard-control",
  storageBucket: "scoreboard-control.firebasestorage.app",
  messagingSenderId: "438021450087",
  appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            const DC_UNITED_TEAM_ID = 1615;
            const MLS_LEAGUE_ID = 253;

            // --- Firebase Document References (no changes) ---
            const scoreboardDocRef = db.collection('scoreboard').doc('liveState');
            const scoreboardVisibilityDocRef = db.collection('scoreboard').doc('visibility');
            const fixtureDocRef = db.collection('scoreboard').doc('currentFixture');
            const playerProfileDocRef = db.collection('scoreboard').doc('playerProfile');
            const playerStatsDocRef = db.collection('scoreboard').doc('playerStats');
            const playerStatsDataDocRef = db.collection('scoreboard').doc('playerStatsData');
            const combinedLineupDocRef = db.collection('scoreboard').doc('combinedLineup');
            const combinedLineupDataDocRef = db.collection('scoreboard').doc('combinedLineupData');
            const matchStatsDocRef = db.collection('scoreboard').doc('matchStats');
            const matchStatsDataDocRef = db.collection('scoreboard').doc('matchStatsData');
            const scrollerDocRef = db.collection('scoreboard').doc('scroller');
            const scrollerDataDocRef = db.collection('scoreboard').doc('scrollerData');
            const matchEventsDocRef = db.collection('scoreboard').doc('matchEvents');
            const matchEventsDataDocRef = db.collection('scoreboard').doc('matchEventsData');
            const leagueEventsDocRef = db.collection('scoreboard').doc('leagueEvents');
            const leagueEventsDataDocRef = db.collection('scoreboard').doc('leagueEventsData');
            const playerProfileSeasonDocRef = db.collection('scoreboard').doc('playerProfileSeason');
            const predictionVisibilityDocRef = db.collection('scoreboard').doc('predictionVisibility');
            const predictionDataDocRef = db.collection('scoreboard').doc('predictionData');

            // --- App State Variables (no changes) ---
            let gameState = {}; 
            let timerInterval = null;
            let currentFixture = null; 
            let fixturePlayerStats = [];
            let currentLineups = [];
            let statsPollingInterval = null;
            let sessionApiCallCount = 0;
            let loadedSeasonPlayerData = null;

            // --- Element References (no changes) ---
            // ... (all your getElementById calls remain the same) ...
            const statusText = document.getElementById('status-text');

            // --- NEW: Helper function for making secure API calls ---
            // REASON: This centralizes all fetch requests through the Netlify proxy,
            // hides the API key, and automatically counts API calls.
            async function fetchApiData(endpoint) {
                const response = await fetch(`/api/${endpoint}`);
                sessionApiCallCount++;
                updateSessionCallCount();
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error (${response.status}): ${errorText}`);
                }
                return response.json();
            }

            // --- UPDATED: All API-calling functions now use the helper ---
            async function fetchApiStatus() {
                try {
                    const data = await fetchApiData('status');
                    if (data.response && data.response.requests) {
                        dailyApiCallsSpan.textContent = `${data.response.requests.current} / ${data.response.requests.limit_day}`;
                    }
                } catch (err) {
                    console.error("Error fetching API status:", err);
                    dailyApiCallsSpan.textContent = 'Error';
                }
            }

            function updateSessionCallCount() {
                sessionApiCallsSpan.textContent = sessionApiCallCount;
            }

            async function getFixturesForYear() {
                const year = yearSelect.value;
                statusText.textContent = `Checking for saved fixtures for ${year}...`;
                const fixturesDocRef = db.collection('fixtures').doc(year);
                try {
                    const doc = await fixturesDocRef.get();
                    if (doc.exists && doc.data().fixtures && doc.data().fixtures.length > 0 && doc.data().fixtures[0].competition) {
                        statusText.textContent = `Fixtures for ${year} loaded from database.`;
                        populateFixtureSelect(doc.data().fixtures);
                    } else {
                        statusText.textContent = `Fetching fixtures for ${year} from API...`;
                        const data = await fetchApiData(`fixtures?season=${year}&team=${DC_UNITED_TEAM_ID}`);
                        if (!data.response || data.response.length === 0) throw new Error(`No fixtures found for ${year}.`);
                        const fixtures = data.response.map(f => ({
                            id: f.fixture.id,
                            name: `${f.teams.home.name} vs ${f.teams.away.name} (${new Date(f.fixture.date).toLocaleDateString()})`,
                            competition: f.league.name
                        }));
                        await fixturesDocRef.set({ fixtures });
                        statusText.textContent = `Fixtures for ${year} fetched and saved.`;
                        populateFixtureSelect(fixtures);
                    }
                } catch (err) {
                    console.error("Error getting fixtures:", err);
                    statusText.textContent = `Error: ${err.message}`;
                    statusText.style.color = 'red';
                }
            }
            
            // ... (populateFixtureSelect remains the same) ...

            async function pollStatsData(fixtureId) {
                console.log(`Polling for updated stats for fixture ${fixtureId}...`);
                try {
                    const [playerStatsData, matchStatsData, liveFixturesData, eventsData] = await Promise.all([
                        fetchApiData(`fixtures/players?fixture=${fixtureId}`),
                        fetchApiData(`fixtures/statistics?fixture=${fixtureId}`),
                        fetchApiData(`fixtures?live=all`),
                        fetchApiData(`fixtures/events?fixture=${fixtureId}`)
                    ]);
                    
                    // ... (rest of the polling logic is the same, just without API keys) ...
                    
                    console.log("Live stats updated in Firestore.");
                    statusText.textContent = `Stats updated at ${new Date().toLocaleTimeString()}`;
                    fetchApiStatus();

                } catch (err) {
                    console.error("Error polling for stats:", err);
                }
            }

            async function fetchAllData(fixtureId) {
                statusText.textContent = "Fetching all fixture data...";
                statusText.style.color = '#555';
                try {
                    const [fixtureData, lineupsData, playerStatsData, matchStatsData, liveFixturesData, eventsData] = await Promise.all([
                        fetchApiData(`fixtures?id=${fixtureId}`),
                        fetchApiData(`fixtures/lineups?fixture=${fixtureId}`),
                        fetchApiData(`fixtures/players?fixture=${fixtureId}`),
                        fetchApiData(`fixtures/statistics?fixture=${fixtureId}`),
                        fetchApiData(`fixtures?live=all`),
                        fetchApiData(`fixtures/events?fixture=${fixtureId}`)
                    ]);
                    
                    // ... (rest of the fetchAllData logic is the same, just without API keys) ...
                    
                } catch (err) {
                    console.error("SCOREBOARD APP ERROR:", err);
                    statusText.textContent = `Error: ${err.message}`;
                    statusText.style.color = 'red';
                }
            }

            // ... (loadLineupData, startPolling, stopPolling, and UI population functions remain the same) ...

            showPlayerBtn.addEventListener('click', async () => {
                // ... (logic for getting selectedPlayerId and fixtureId) ...
                try {
                    statusText.textContent = 'Fetching latest player stats...';
                    const playerStatsData = await fetchApiData(`fixtures/players?fixture=${fixtureId}`);
                    fixturePlayerStats = playerStatsData.response || [];
                    statusText.textContent = 'Latest stats fetched. Building profile...';
                } catch (err) {
                    console.error("Error fetching latest player stats:", err);
                    // ... (error handling) ...
                }
                // ... (rest of the showPlayerBtn logic remains the same) ...
            });
            
            loadPlayerSeasonBtn.addEventListener('click', async () => {
                // ... (logic for getting selectedPlayerId and fixture) ...
                try {
                    const playerData = await fetchApiData(`players?id=${selectedPlayerId}&season=${currentFixture.league.season}`);
                    // ... (rest of the logic remains the same) ...
                } catch (err) {
                    // ... (error handling) ...
                }
            });

            loadPredictionBtn.addEventListener('click', async () => {
                // ... (logic for getting fixtureId) ...
                try {
                    const data = await fetchApiData(`predictions?fixture=${fixtureId}`);
                    // ... (rest of the logic remains the same) ...
                } catch (err) {
                    // ... (error handling) ...
                }
            });
            
            // --- All other event listeners and game state logic remain the same ---
            
            // --- Initial Load ---
            scoreboardDocRef.get().then((doc) => {
                if (doc.exists) gameState = doc.data();
                else gameState = { homeScore: 0, awayScore: 0, minutes: 0, seconds: 0, period: '1H', showStoppage: false, event: null };
                updateDisplays();
                getFixturesForYear();
                fetchApiStatus(); // Initial status fetch
            });
        });
    </script>
</body>
</html>