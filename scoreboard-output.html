<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scoreboard Output</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <link rel="stylesheet" href="scoreboard.css">
    <style>
        /* Visibility control for the scoreboard */
        #scoreboard-main-container {
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #scoreboard-main-container.visible {
            opacity: 1;
        }
    </style>
</head>
<body class="output">

    <div id="scoreboard-main-container" class="scoreboard-container">
        <div class="scoreboard-wrapper" id="scoreboard-wrapper">
            <div class="team-display home">
                <img id="home-logo-output" src="" class="team-logo-output">
                <span id="home-initials-output" class="team-initials"></span>
            </div>
            <div class="score-box">
                <span id="home-score-output">0</span>
                <span>-</span>
                <span id="away-score-output">0</span>
            </div>
            <div class="team-display away">
                <span id="away-initials-output" class="team-initials"></span>
                <img id="away-logo-output" src="" class="team-logo-output">
            </div>
            <div class="time-box">
                <span id="time-output">00:00</span>
                <span id="period-output-text" class="period-text"></span>
            </div>
            <div class="stoppage-box" id="stoppage-box">
                +<span id="stoppage-time-output">0</span>
            </div>
        </div>
        
        <div class="event-dropdown" id="event-dropdown">
            <div id="event-flash-view" class="event-view hidden">
                <span id="event-flash-text">GOAL</span>
            </div>
    
            <div id="event-detail-view" class="event-view hidden">
                <img id="event-logo" src="" class="event-logo">
                <div id="event-details">
                    <div id="event-title"></div>
                    <div id="event-player-details"></div>
                </div>
                <div id="event-card-icon" class="event-card-icon"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
                authDomain: "scoreboard-control.firebaseapp.com",
                projectId: "scoreboard-control",
                storageBucket: "scoreboard-control.appspot.com",
                messagingSenderId: "438021450087",
                appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            // COMMENT: Define the base URL for your GitHub Pages assets.
            // REASON: This makes it easy to manage your image paths and switch hosting providers in the future if needed.
            const assetsBaseUrl = 'https://dcuk-pod.github.io/podcast-controls/';

            const TEAM_COLORS = {
              1595: 'rgb(85, 150, 71)', 1596: 'rgb(0, 102, 175)', 1597: 'rgb(222, 53, 56)', 1598: 'rgb(101, 44, 144)', 1599: 'rgb(181, 152, 90)', 1600: 'rgb(245, 128, 44)', 1601: 'rgb(222, 53, 56)', 1602: 'rgb(217, 39, 46)', 1603: 'rgb(15, 49, 92)', 1604: 'rgb(108, 169, 223)', 1605: 'rgb(0, 40, 85)', 1606: 'rgb(205, 34, 53)', 1607: 'rgb(229, 26, 55)', 1608: 'rgb(141, 22, 44)', 1609: '#021D3D', 1610: 'rgb(149, 29, 64)', 1611: 'rgb(80, 132, 185)', 1612: 'rgb(143, 201, 232)', 1613: 'rgb(254, 222, 0)', 1614: 'rgb(0, 85, 155)', 1615: 'rgb(239, 62, 65)', 1616: 'rgb(193, 162, 92)', 1617: 'rgb(0, 70, 41)', 2242: 'rgb(241, 91, 36)', 9568: 'rgb(252, 185, 205)', 9569: 'rgb(254, 219, 0)', 16489: 'rgb(0, 182, 75)', 18310: 'rgb(91, 192, 240)', 20787: 'rgb(217, 2, 79)', 25484: 'rgb(11, 46, 75)', 'default': 'rgba(66, 65, 65, 1)' 
            };
            const TEAM_COLORS_ALT = {
              1595: '#003C71', 1596: '#000000', 1597: '#003E7B', 1598: '#FFD100', 1599: '#0A2240', 1600: '#000000', 1601: '#231F20', 1602: '#FFC700', 1603: '#92C1E9', 1604: '#002654', 1605: '#FFD200', 1606: '#013A81', 1607: '#001E61', 1608: '#A48A5A', 1609: '#E51938', 1610: '#569FD3', 1611: '#002F65', 1612: '#58595B', 1613: '#000000', 1614: '#000000', 1615: '#000000', 1616: '#000000', 1617: '#E1A023', 2242: '#003067', 9568: '#000000', 9569: '#001F5B', 16489: '#000000', 18310: '#000000', 20787: '#001D4C', 25484: '#F5831F', 'default': 'rgb(255, 255, 255)'
            };
            const TEAM_INITIALS = {
              1595: 'SEA', 1596: 'SJE', 1597: 'DAL', 1598: 'ORL', 1599: 'PHI', 1600: 'HOU', 1601: 'TOR', 1602: 'NYRB', 1603: 'VAN', 1604: 'NYC', 1605: 'LAG', 1606: 'RSL', 1607: 'CHI', 1608: 'ATL', 1609: 'NER', 1610: 'COL', 1611: 'SKC', 1612: 'MIN', 1613: 'CLB', 1614: 'MTL', 1615: 'DCU', 1616: 'LAFC', 1617: 'POR', 2242: 'CIN', 9568: 'MIA', 9569: 'NSH', 16489: 'AUS', 18310: 'CLT', 20787: 'STL', 25484: 'SAN', 'default': '???'
            };

            const scoreboardMainContainer = document.getElementById('scoreboard-main-container');
            const homeScore = document.getElementById('home-score-output');
            const awayScore = document.getElementById('away-score-output');
            const timeDisplay = document.getElementById('time-output');
            const periodTextDisplay = document.getElementById('period-output-text');
            const stoppageBox = document.getElementById('stoppage-box');
            const stoppageTime = document.getElementById('stoppage-time-output');
            const homeInitials = document.getElementById('home-initials-output');
            const awayInitials = document.getElementById('away-initials-output');
            const homeLogo = document.getElementById('home-logo-output');
            const awayLogo = document.getElementById('away-logo-output');
            const eventDropdown = document.getElementById('event-dropdown');
            const eventFlashView = document.getElementById('event-flash-view');
            const eventFlashText = document.getElementById('event-flash-text');
            const eventDetailView = document.getElementById('event-detail-view');
            const eventLogo = document.getElementById('event-logo');
            const eventTitle = document.getElementById('event-title');
            const eventPlayerDetails = document.getElementById('event-player-details');
            const eventCardIcon = document.getElementById('event-card-icon');
            
            const liveStateDocRef = db.collection('scoreboard').doc('liveState');
            const fixtureDocRef = db.collection('scoreboard').doc('currentFixture');
            const scoreboardVisibilityDocRef = db.collection('scoreboard').doc('visibility');
            
            let lastEventId = null;

            scoreboardVisibilityDocRef.onSnapshot((doc) => {
                if (doc.exists && doc.data().show) {
                    scoreboardMainContainer.classList.add('visible');
                } else {
                    scoreboardMainContainer.classList.remove('visible');
                }
            });

            fixtureDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const fixture = doc.data();
                    if (fixture.teams && fixture.teams.home && fixture.teams.away) {
                        const homeId = fixture.teams.home.id;
                        const awayId = fixture.teams.away.id;
                        
                        homeInitials.textContent = TEAM_INITIALS[homeId] || '???';
                        awayInitials.textContent = TEAM_INITIALS[awayId] || '???';

                        // COMMENT: Updated image paths.
                        // REASON: The 'src' attributes for the team logos are now constructed using the GitHub Pages base URL.
                        homeLogo.src = `${assetsBaseUrl}assets/logos/${homeId}.png`;
                        awayLogo.src = `${assetsBaseUrl}assets/logos/${awayId}.png`;

                        const homeColor = TEAM_COLORS[homeId] || TEAM_COLORS['default'];
                        const awayColor = TEAM_COLORS[awayId] || TEAM_COLORS['default'];
                        document.querySelector('.team-display.home').style.backgroundColor = homeColor;
                        document.querySelector('.team-display.away').style.backgroundColor = awayColor;
                        
                        const homeAltColor = TEAM_COLORS_ALT[homeId] || TEAM_COLORS_ALT['default'];
                        const awayAltColor = TEAM_COLORS_ALT[awayId] || TEAM_COLORS_ALT['default'];
                        homeInitials.style.color = homeAltColor;
                        awayInitials.style.color = awayAltColor;
                    }
                }
            });

            liveStateDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    const state = doc.data();

                    if (homeScore.textContent !== (state.homeScore || 0).toString()) {
                        homeScore.textContent = state.homeScore || 0;
                        homeScore.classList.add('flash');
                        setTimeout(() => homeScore.classList.remove('flash'), 500);
                    }
                    if (awayScore.textContent !== (state.awayScore || 0).toString()) {
                        awayScore.textContent = state.awayScore || 0;
                        awayScore.classList.add('flash');
                        setTimeout(() => awayScore.classList.remove('flash'), 500);
                    }

                    if (state.period === 'PENS') {
                        timeDisplay.textContent = 'PENS';
                        periodTextDisplay.style.display = 'none';
                    } else {
                        const minutes = String(state.minutes || 0).padStart(2, '0');
                        const seconds = String(state.seconds || 0).padStart(2, '0');
                        timeDisplay.textContent = `${minutes}:${seconds}`;
                        const intervalPeriods = ['HT', 'FT', 'ET1', 'ET2'];
                        if (intervalPeriods.includes(state.period)) {
                            periodTextDisplay.textContent = state.period;
                            periodTextDisplay.style.display = 'inline';
                        } else {
                            periodTextDisplay.style.display = 'none';
                        }
                    }

                    if (state.showStoppage && state.stoppageTime) {
                        stoppageTime.textContent = state.stoppageTime;
                        stoppageBox.classList.add('visible');
                    } else {
                        stoppageBox.classList.remove('visible');
                    }
                    
                    if (state.event && state.event.id !== lastEventId) {
                        lastEventId = state.event.id;
                        triggerEventAnimation(state.event);
                    }
                }
            });
            
            function triggerEventAnimation(event) {
                if (event.type === 'goal') {
                    const teamId = event.data.teamId;
                    const primaryColor = TEAM_COLORS[teamId] || TEAM_COLORS['default'];
                    const altColor = TEAM_COLORS_ALT[teamId] || TEAM_COLORS_ALT['default'];

                    eventDetailView.classList.add('hidden');
                    eventFlashView.classList.remove('hidden');
                    eventFlashView.style.backgroundColor = primaryColor;
                    eventFlashText.style.color = altColor;
                    eventDropdown.classList.add('visible');

                    let flashes = 0;
                    const animationInterval = setInterval(() => {
                        const isAltState = flashes % 2 !== 0;
                        eventFlashView.style.backgroundColor = isAltState ? altColor : primaryColor;
                        eventFlashText.style.color = isAltState ? primaryColor : altColor;
                        flashes++;
                    }, 250);

                    setTimeout(() => {
                        clearInterval(animationInterval);
                        eventFlashView.classList.add('hidden');
                        eventDetailView.classList.remove('hidden');
                        // COMMENT: Updated event logo path.
                        // REASON: Ensures the goal event also pulls the team logo from the GitHub repo.
                        eventLogo.src = `${assetsBaseUrl}assets/logos/${teamId}.png`;
                        eventTitle.textContent = 'GOAL';
                        eventPlayerDetails.innerHTML = event.data.player;
                        eventCardIcon.innerHTML = '';
                    }, 2500); 

                    setTimeout(() => {
                        eventDropdown.classList.remove('visible');
                    }, 10000);

                    return;
                }

                let title = '';
                let playerHtml = '';
                let cardHtml = '';
                
                // COMMENT: Updated event logo path for all other event types.
                // REASON: Standardises all team logo fetching to use the GitHub Pages URL.
                eventLogo.src = `${assetsBaseUrl}assets/logos/${event.data.teamId}.png`;

                switch (event.type) {
                    case 'yellow': 
                        title = 'YELLOW CARD'; 
                        playerHtml = event.data.player; 
                        cardHtml = '<div class="card yellow"></div>';
                        break;
                    case 'red': 
                        title = 'RED CARD'; 
                        playerHtml = event.data.player; 
                        cardHtml = '<div class="card red"></div>';
                        break;
                    case 'sub': 
                        title = 'SUBSTITUTION'; 
                        playerHtml = `<span class="sub-on">⬆ ${event.data.playerOn}</span><span class="sub-off">⬇ ${event.data.playerOff}</span>`;
                        break;
                    case 'var_goal': title = 'VAR CHECK'; playerHtml = 'POSSIBLE GOAL'; break;
                    case 'var_no_goal': title = 'VAR CHECK'; playerHtml = 'POSSIBLE DISALLOWED GOAL'; break;
                    case 'var_penalty': title = 'VAR CHECK'; playerHtml = 'POSSIBLE PENALTY'; break;
                    case 'var_red': title = 'VAR CHECK'; playerHtml = 'POSSIBLE RED CARD'; break;
                    case 'var_identity': title = 'VAR CHECK'; playerHtml = 'MISTAKEN IDENTITY'; break;
                }
                
                eventFlashView.classList.add('hidden');
                eventDetailView.classList.remove('hidden');
                eventTitle.textContent = title;
                eventPlayerDetails.innerHTML = playerHtml;
                eventCardIcon.innerHTML = cardHtml;
                
                eventDropdown.classList.add('visible');
                
                setTimeout(() => {
                    eventDropdown.classList.remove('visible');
                }, 10000);
            }
        });
    </script>
</body>
</html>
