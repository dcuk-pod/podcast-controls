<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCUK Visuals Control Panel</title>

    <!-- PWA & Themeing -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" id="theme-color-meta" content="#3498db">

    <!-- Firebase -->
    <script type="module">
        // Using the latest modular SDK for better performance and tree-shaking
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, setPersistence, browserSessionPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, addDoc, serverTimestamp, deleteDoc, query, orderBy, writeBatch, increment } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        window.firebase = {
            initializeApp, getAuth, setPersistence, browserSessionPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, addDoc, serverTimestamp, deleteDoc, query, orderBy, writeBatch, increment
        };
    </script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom styles to complement Tailwind */
        :root {
            --md-sys-color-primary: #3498db;
            --md-sys-color-primary-container: #2980b9;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-surface: #f0f2f5;
            --md-sys-color-surface-container-high: #ffffff;
            --md-sys-color-on-surface: #333333;
            --md-sys-color-on-surface-variant: #555555;
            --md-sys-color-outline: #e0e0e0;
            --md-sys-color-outline-variant: #eeeeee;
            --md-sys-color-error: #e74c3c;
            --md-sys-color-error-container: #c0392b;
            --md-sys-color-success: #2ecc71;
            --md-sys-color-tertiary-container: #e9ecef;
        }
        html[data-theme="dark"] {
            --md-sys-color-primary: #3498db;
            --md-sys-color-primary-container: #4aa9e4;
            --md-sys-color-surface: #121212;
            --md-sys-color-surface-container-high: #1e1e1e;
            --md-sys-color-on-surface: #e0e0e0;
            --md-sys-color-on-surface-variant: #bbbbbb;
            --md-sys-color-outline: #3a3a3a;
            --md-sys-color-outline-variant: #2c2c2c;
            --md-sys-color-error: #e74c3c;
            --md-sys-color-error-container: #f06a5a;
            --md-sys-color-success: #2ecc71;
            --md-sys-color-tertiary-container: #2c2c2c;
        }
        body { background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); font-family: 'Poppins', sans-serif; }
        .card { background-color: var(--md-sys-color-surface-container-high); border-color: var(--md-sys-color-outline); }
        .card-title { border-color: var(--md-sys-color-outline-variant); }
        .tab-button[aria-selected="true"] { border-color: var(--md-sys-color-primary); color: var(--md-sys-color-primary); }
        .tab-button { color: var(--md-sys-color-on-surface-variant); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 700; transition: background-color 0.2s; }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-primary:hover { background-color: var(--md-sys-color-primary-container); }
        .btn-danger { background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-primary); }
        .btn-danger:hover { background-color: var(--md-sys-color-error-container); }
        .btn-secondary { background-color: var(--md-sys-color-tertiary-container); color: var(--md-sys-color-on-surface); }
        .api-bar { background-color: var(--md-sys-color-tertiary-container); }
        input, select, textarea { background-color: var(--md-sys-color-surface); border-color: var(--md-sys-color-outline); color: var(--md-sys-color-on-surface); }
        .switch-bg { background-color: #ccc; }
        input:checked + .switch-bg { background-color: var(--md-sys-color-success); }
        html[data-theme="dark"] .switch-bg { background-color: #555; }
        .dynamic-item { background-color: var(--md-sys-color-surface); }
        .dynamic-list { max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body class="antialiased transition-colors duration-300">

    <!-- Login Screen -->
    <div id="login-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="card w-full max-w-md p-8 rounded-2xl shadow-lg border">
            <h1 class="text-3xl font-bold text-center mb-6">DCUK Control Panel</h1>
            <form id="login-form" class="space-y-4">
                <input type="email" id="login-email" placeholder="Email" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="login-password" placeholder="Password" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button type="submit" class="btn btn-primary w-full py-3 text-lg">Login</button>
                <p id="login-error" class="text-red-500 text-center font-bold mt-4 hidden"></p>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden p-4 md:p-8 max-w-7xl mx-auto">
        <div class="card p-6 rounded-2xl shadow-lg border">
            <!-- Header -->
            <header class="flex flex-wrap justify-between items-center pb-4 mb-6 border-b card-title">
                <h1 class="text-2xl font-bold">DCUK Visuals Control Panel</h1>
                <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                    <div class="flex items-center space-x-2">
                        <span>‚òÄÔ∏è</span>
                        <label for="theme-toggle" class="relative inline-block w-12 h-6 cursor-pointer">
                            <input type="checkbox" id="theme-toggle" class="sr-only peer">
                            <div class="switch-bg w-full h-full rounded-full peer-checked:bg-green-500 transition"></div>
                            <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-6"></div>
                        </label>
                        <span>üåô</span>
                    </div>
                    <button id="logout-btn" class="btn btn-danger">Logout</button>
                </div>
            </header>

            <!-- API Status Bar -->
            <div class="api-bar text-sm grid grid-cols-1 sm:grid-cols-3 gap-2 items-center p-3 rounded-lg mb-6">
                <div class="session-calls text-center sm:text-left">Session API Calls: <span id="session-api-calls" class="font-bold">0</span></div>
                <div class="flex justify-center items-center space-x-2">
                    <span class="font-bold">Live Polling</span>
                    <label for="polling-toggle" class="relative inline-block w-12 h-6 cursor-pointer">
                        <input type="checkbox" id="polling-toggle" class="sr-only peer">
                        <div class="switch-bg w-full h-full rounded-full peer-checked:bg-green-500 transition"></div>
                        <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-6"></div>
                    </label>
                </div>
                <div class="daily-calls text-center sm:text-right">Daily API Calls: <span id="daily-api-calls" class="font-bold">Loading...</span></div>
            </div>

            <!-- Fixture Selection -->
            <div class="card p-4 rounded-xl border mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-center">
                    <select id="year-select" class="p-3 border rounded-lg w-full">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                    <button id="get-fixtures-btn" class="btn btn-primary py-3">Get Fixtures</button>
                    <select id="fixture-select" class="p-3 border rounded-lg w-full sm:col-span-2">
                        <option>Select a year first...</option>
                    </select>
                    <button id="load-fixture-btn" class="btn btn-primary py-3">Load Selected Fixture</button>
                </div>
                <p id="status-text" class="text-center mt-3 text-sm">Select a season and get fixtures to begin.</p>
            </div>
            
            <!-- Tab Navigation -->
            <div class="border-b card-title mb-6">
                <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" aria-selected="true" data-tab="scoreboard">Scoreboard</button>
                    <button class="tab-button whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg" aria-selected="false" data-tab="podcast">Podcast</button>
                </nav>
            </div>

            <!-- Tab Panels -->
            <div id="tab-panels">
                <div id="tab-panel-scoreboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="tab-panel-podcast" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

        </div>
    </div>

    <script type="module">
        const {
            initializeApp, getAuth, setPersistence, browserSessionPersistence, signInWithEmailAndPassword, onAuthStateChanged, signOut,
            getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, addDoc, serverTimestamp, deleteDoc, query, orderBy, writeBatch, increment
        } = window.firebase;

        document.addEventListener('DOMContentLoaded', () => {
             const firebaseConfig = {
                apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
                authDomain: "scoreboard-control.firebaseapp.com",
                projectId: "scoreboard-control",
                storageBucket: "scoreboard-control.appspot.com",
                messagingSenderId: "438021450087",
                appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // --- App Initialization and Authentication ---
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const loginEmail = document.getElementById('login-email');
            const loginPassword = document.getElementById('login-password');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            let unsubscribeAllListeners = () => {};

            onAuthStateChanged(auth, user => {
                if (user) {
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    loginError.classList.add('hidden');
                    unsubscribeAllListeners = initializeAppLogic();
                } else {
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    unsubscribeAllListeners(); 
                    unsubscribeAllListeners = () => {};
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                setPersistence(auth, browserSessionPersistence)
                    .then(() => signInWithEmailAndPassword(auth, loginEmail.value, loginPassword.value))
                    .catch(error => {
                        console.error('Login Error:', error);
                        loginError.textContent = 'Error: Invalid email or password.';
                        loginError.classList.remove('hidden');
                    });
            });

            logoutBtn.addEventListener('click', () => signOut(auth));
            
            // --- Theme Switcher Logic ---
            const themeToggle = document.getElementById('theme-toggle');
            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                themeToggle.checked = theme === 'dark';
            };
            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });

            // --- Main Application Logic ---
            function initializeAppLogic() {
                console.log("Initializing App Logic...");
                let allUnsubscribers = [];
                const DC_UNITED_TEAM_ID = 1615;
                let currentFixtureId = null;
                let fixtureDataUnsub = null; 

                // --- Element & Firestore References ---
                const statusText = document.getElementById('status-text');
                const yearSelect = document.getElementById('year-select');
                const getFixturesBtn = document.getElementById('get-fixtures-btn');
                const fixtureSelect = document.getElementById('fixture-select');
                const loadFixtureBtn = document.getElementById('load-fixture-btn');
                const pollingToggle = document.getElementById('polling-toggle');
                const dailyApiCallsSpan = document.getElementById('daily-api-calls');
                const configDocRef = doc(db, 'config', 'global');
                const displayStateScoreboardDocRef = doc(db, 'displayState', 'scoreboard');
                const displayStatePodcastDocRef = doc(db, 'displayState', 'podcast');
                const podcastQuestionsColRef = collection(db, 'podcastContent/questions/items');
                const podcastHeadlinesColRef = collection(db, 'podcastContent/headlines/items');

                // --- Fixture Selection Logic ---
                const handleFixtureData = (doc) => {
                    if (doc.exists() && doc.data().fixtures) {
                        populateFixtureSelect(doc.data().fixtures);
                        statusText.textContent = `Fixtures for ${yearSelect.value} loaded from database.`;
                    } else {
                        statusText.textContent = `No local data found for ${yearSelect.value}. Triggering backend to fetch...`;
                        updateDoc(configDocRef, { "fetcher.manualFetchTriggers.fixtures": serverTimestamp(), "fetcher.targetYear_Fixtures": yearSelect.value });
                    }
                };
                
                const listenForFixtures = () => {
                    if (fixtureDataUnsub) fixtureDataUnsub(); 
                    const year = yearSelect.value;
                    statusText.textContent = `Listening for fixtures for ${year}...`;
                    const fixturesDocRef = doc(db, 'fixtures', `${DC_UNITED_TEAM_ID}_${year}`);
                    
                    fixtureDataUnsub = onSnapshot(fixturesDocRef, handleFixtureData, (error) => {
                        console.error("Error listening for fixtures: ", error);
                        statusText.textContent = `Error loading fixtures. Triggering backend fetch...`;
                        updateDoc(configDocRef, { "fetcher.manualFetchTriggers.fixtures": serverTimestamp(), "fetcher.targetYear_Fixtures": year });
                    });
                    
                    allUnsubscribers.push(fixtureDataUnsub);
                };

                yearSelect.addEventListener('change', listenForFixtures);
                getFixturesBtn.addEventListener('click', listenForFixtures);

                const populateFixtureSelect = (fixtures) => {
                    fixtureSelect.innerHTML = '';
                    if (!fixtures || fixtures.length === 0) {
                        fixtureSelect.innerHTML = '<option>No fixtures found for this year</option>'; return;
                    }
                    const grouped = fixtures.reduce((acc, f) => { (acc[f.league.name] = acc[f.league.name] || []).push(f); return acc; }, {});
                    
                    Object.keys(grouped).sort().forEach(group => {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = group;
                        grouped[group]
                            .sort((a,b) => new Date(a.fixture.date) - new Date(b.fixture.date))
                            .forEach(f => {
                                const option = document.createElement('option');
                                option.value = f.fixture.id;
                                option.textContent = `${new Date(f.fixture.date).toLocaleDateString()} - ${f.teams.home.name} vs ${f.teams.away.name}`;
                                optgroup.appendChild(option);
                            });
                        fixtureSelect.appendChild(optgroup);
                    });
                };

                loadFixtureBtn.addEventListener('click', () => {
                    const fixtureId = parseInt(fixtureSelect.value);
                    if (!fixtureId) { statusText.textContent = "Please select a fixture."; return; }
                    statusText.textContent = `Setting active fixture to ${fixtureId} and triggering live data fetch...`;
                    updateDoc(configDocRef, {
                        selectedFixtureId: fixtureId,
                        "fetcher.manualFetchTriggers.liveData": serverTimestamp()
                    });
                });

                // --- Global Config Listener ---
                allUnsubscribers.push(onSnapshot(configDocRef, (doc) => {
                    if (doc.exists()) {
                        const config = doc.data();
                        pollingToggle.checked = config.fetcher?.enableLivePolling || false;
                        dailyApiCallsSpan.textContent = `${config.apiStatus?.current || 0} / ${config.apiStatus?.limit_day || 'N/A'}`;
                        if(config.selectedFixtureId && config.selectedFixtureId !== currentFixtureId) {
                            currentFixtureId = config.selectedFixtureId;
                            initializeInteractiveCards(currentFixtureId);
                        }
                    }
                }));
                pollingToggle.addEventListener('change', () => {
                     updateDoc(configDocRef, { "fetcher.enableLivePolling": pollingToggle.checked });
                });


                // --- Tab Switching Logic ---
                document.querySelectorAll('.tab-button').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab-button').forEach(t => t.setAttribute('aria-selected', 'false'));
                        tab.setAttribute('aria-selected', 'true');
                        document.querySelectorAll('[id^="tab-panel-"]').forEach(p => p.classList.add('hidden'));
                        document.getElementById(`tab-panel-${tab.dataset.tab}`).classList.remove('hidden');
                    });
                });
                
                // --- Dynamic Card Generation ---
                 const scoreboardControls = [
                    { id: 'score', title: 'Score', type: 'score' },
                    { id: 'clock', title: 'Game Clock & Period', type: 'clock' },
                    { id: 'events', title: 'Broadcast Events', type: 'events' },
                    { id: 'scoreboard', title: 'Scoreboard Visibility', type: 'toggle', docRef: displayStateScoreboardDocRef, field: 'showScoreboard' },
                    { id: 'playerProfile', title: 'Player Profile (Match)', type: 'playerProfile' },
                    { id: 'playerStats', title: 'Player Stats', type: 'toggle', docRef: displayStateScoreboardDocRef, field: 'showPlayerStats' },
                    { id: 'combinedLineup', title: 'Combined Lineup', type: 'toggle', docRef: displayStateScoreboardDocRef, field: 'showLineup' },
                    { id: 'matchStats', title: 'Match Stats', type: 'toggle', docRef: displayStateScoreboardDocRef, field: 'showMatchStats' },
                    { id: 'scroller', title: 'Scroller', type: 'toggle', docRef: displayStateScoreboardDocRef, field: 'showScroller' },
                    { id: 'combinedEvents', title: 'Combined Events', type: 'toggle', docRef: displayStateScoreboardDocRef, field: 'showCombinedEvents' },
                    { id: 'playerSeason', title: 'Player Profile (Season)', type: 'playerProfileSeason' },
                    { id: 'prediction', title: 'Prediction Graphic', type: 'prediction' },
                ];
                const podcastControls = [
                    { id: 'questions', title: 'Podcast Questions', type: 'questions' },
                    { id: 'headlines', title: 'News Headlines', type: 'headlines' },
                    { id: 'podcastFixtures', title: 'Fixtures Visual', type: 'toggle', docRef: displayStatePodcastDocRef, field: 'showFixtures' },
                    { id: 'nextFixtures', title: 'Next Fixtures Visual', type: 'toggle', docRef: displayStatePodcastDocRef, field: 'showNextFixtures' },
                ];
                
                const scoreboardPanel = document.getElementById('tab-panel-scoreboard');
                const podcastPanel = document.getElementById('tab-panel-podcast');
                scoreboardPanel.innerHTML = '';
                podcastPanel.innerHTML = '';

                scoreboardControls.forEach(control => scoreboardPanel.appendChild(createCard(control)));
                podcastControls.forEach(control => podcastPanel.appendChild(createCard(control)));

                function createCard(control) {
                    let card;
                    switch (control.type) {
                        case 'toggle': card = createToggleCard(control); break;
                        case 'score': card = createScoreCard(); break;
                        case 'clock': card = createClockCard(); break;
                        case 'events': card = createEventsCard(); break;
                        case 'questions':
                        case 'headlines': card = createPodcastContentCard(control); break;
                        case 'playerProfile': card = createPlayerSelectCard(control); break;
                        case 'playerProfileSeason': card = createPlayerSelectCard(control); break;
                        case 'prediction': card = createPredictionCard(control); break;
                        default:
                            card = document.createElement('div');
                            card.className = 'card p-4 rounded-xl border';
                            card.innerHTML = `<h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">${control.title}</h2><p class="text-sm text-gray-500">Controls coming soon.</p>`;
                    }
                    return card;
                }
                
                function createToggleCard(control){const card=document.createElement("div");card.className="card p-4 rounded-xl border flex flex-col justify-between",card.innerHTML=`
                        <h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">${control.title}</h2>
                        <div class="flex justify-between items-center mt-auto">
                            <span class="font-bold">Show Visual</span>
                            <label class="relative inline-block w-12 h-6 cursor-pointer">
                                <input type="checkbox" id="toggle-${control.id}" class="sr-only peer">
                                <div class="switch-bg w-full h-full rounded-full transition"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-6"></div>
                            </label>
                        </div>`;const toggle=card.querySelector(`#toggle-${control.id}`);return toggle.addEventListener("change",()=>updateDoc(control.docRef,{[control.field]:toggle.checked})),allUnsubscribers.push(onSnapshot(control.docRef,t=>{t.exists()&&(toggle.checked=!!t.data()[control.field])})),card}
                
                function createScoreCard(){const card=document.createElement("div");card.className="card p-4 rounded-xl border",card.innerHTML=`<h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">Score</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span id="home-name-control" class="font-bold">HOME</span>
                                <div class="flex items-center space-x-2">
                                    <button id="home-score-down" class="btn btn-secondary px-3">-</button>
                                    <span id="home-score-display" class="text-xl font-bold w-8 text-center">0</span>
                                    <button id="home-score-up" class="btn btn-secondary px-3">+</button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span id="away-name-control" class="font-bold">AWAY</span>
                                <div class="flex items-center space-x-2">
                                    <button id="away-score-down" class="btn btn-secondary px-3">-</button>
                                    <span id="away-score-display" class="text-xl font-bold w-8 text-center">0</span>
                                    <button id="away-score-up" class="btn btn-secondary px-3">+</button>
                                </div>
                            </div>
                        </div>`;const homeScoreDisplay=card.querySelector("#home-score-display"),awayScoreDisplay=card.querySelector("#away-score-display");return allUnsubscribers.push(onSnapshot(displayStateScoreboardDocRef,t=>{if(t.exists()&&t.data().liveState){const e=t.data().liveState;homeScoreDisplay.textContent=e.homeScore??0,awayScoreDisplay.textContent=e.awayScore??0}})),card.querySelector("#home-score-up").addEventListener("click",()=>updateDoc(displayStateScoreboardDocRef,{"liveState.homeScore":increment(1)})),card.querySelector("#home-score-down").addEventListener("click",()=>updateDoc(displayStateScoreboardDocRef,{"liveState.homeScore":increment(-1)})),card.querySelector("#away-score-up").addEventListener("click",()=>updateDoc(displayStateScoreboardDocRef,{"liveState.awayScore":increment(1)})),card.querySelector("#away-score-down").addEventListener("click",()=>updateDoc(displayStateScoreboardDocRef,{"liveState.awayScore":increment(-1)})),card}
                
                function createClockCard(){const card=document.createElement("div");card.className="card p-4 rounded-xl border",card.innerHTML=`<h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">Game Clock & Period</h2>
                        <div class="flex flex-col items-center gap-4">
                            <div class="flex items-center gap-2 text-xl font-bold">
                                <input type="number" id="minutes-input" value="0" min="0" class="w-20 p-2 text-center border rounded-lg">
                                <span>:</span>
                                <input type="number" id="seconds-input" value="0" min="0" max="59" class="w-20 p-2 text-center border rounded-lg">
                            </div>
                            <div class="grid grid-cols-3 gap-2 w-full">
                                <button id="set-time-btn" class="btn btn-secondary">Set</button>
                                <button id="play-pause-btn" class="btn btn-primary">Play</button>
                                <button id="reset-time-btn" class="btn btn-secondary">Reset</button>
                            </div>
                            <div class="grid grid-cols-4 gap-2 w-full">
                                ${["1H:0","HT:45","2H:45","FT:90","ET1:90","ET2:105","PENS:120","Abd:0"].map(t=>{const[e,a]=t.split(":");return`<button class="period-btn btn btn-secondary" data-period="${e}" data-time="${a}">${e}</button>`}).join("")}
                            </div>
                        </div>`;let timerInterval=null;let currentLiveState={};const playPauseBtn=card.querySelector("#play-pause-btn");return allUnsubscribers.push(onSnapshot(displayStateScoreboardDocRef,t=>{t.exists()&&t.data().liveState&&(currentLiveState=t.data().liveState,card.querySelector("#minutes-input").value=currentLiveState.minutes||0,card.querySelector("#seconds-input").value=currentLiveState.seconds||0)})),card.querySelector("#set-time-btn").addEventListener("click",()=>{const t=parseInt(card.querySelector("#minutes-input").value),e=parseInt(card.querySelector("#seconds-input").value);updateDoc(displayStateScoreboardDocRef,{"liveState.minutes":t,"liveState.seconds":e})}),playPauseBtn.addEventListener("click",()=>{timerInterval?(clearInterval(timerInterval),timerInterval=null,playPauseBtn.textContent="Play"):(playPauseBtn.textContent="Pause",timerInterval=setInterval(()=>{let t=(currentLiveState.seconds||0)+1,e=currentLiveState.minutes||0;t>=60&&(t=0,e++),updateDoc(displayStateScoreboardDocRef,{"liveState.minutes":e,"liveState.seconds":t})},1e3))}),card.querySelectorAll(".period-btn").forEach(t=>{t.addEventListener("click",()=>{timerInterval&&(clearInterval(timerInterval),timerInterval=null,playPauseBtn.textContent="Play"),updateDoc(displayStateScoreboardDocRef,{"liveState.period":t.dataset.period,"liveState.minutes":parseInt(t.dataset.time),"liveState.seconds":0})})}),card.querySelector("#reset-time-btn").addEventListener("click",()=>{timerInterval&&(clearInterval(timerInterval),timerInterval=null,playPauseBtn.textContent="Play"),updateDoc(displayStateScoreboardDocRef,{"liveState.minutes":0,"liveState.seconds":0})}),card}

                function createEventsCard() {
                    const card = document.createElement('div');
                    card.className = 'card p-4 rounded-xl border';
                    card.innerHTML = `<h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">Broadcast Events</h2>
                        <div class="space-y-4">
                            <select id="event-type-select" class="w-full p-2 border rounded-lg">
                                <option value="goal">Goal</option>
                                <option value="yellow">Yellow Card</option>
                                <option value="red">Red Card</option>
                                <option value="sub">Substitution</option>
                                <option value="var_goal">VAR: Goal Check</option>
                                <option value="var_no_goal">VAR: No Goal</option>
                                <option value="var_penalty">VAR: Penalty Check</option>
                            </select>
                            <div id="single-player-section">
                                <select id="event-player-select" class="w-full p-2 border rounded-lg"><option>(Load fixture first)</option></select>
                            </div>
                            <div id="sub-player-section" class="hidden grid grid-cols-2 gap-2">
                                <select id="player-off-select" class="w-full p-2 border rounded-lg"><option>Player Off...</option></select>
                                <select id="player-on-select" class="w-full p-2 border rounded-lg"><option>Player On...</option></select>
                            </div>
                             <button id="trigger-event-btn" class="btn btn-primary w-full py-2">Trigger Event</button>
                        </div>`;
                    
                    const eventTypeSelect = card.querySelector('#event-type-select');
                    const singlePlayerSection = card.querySelector('#single-player-section');
                    const subPlayerSection = card.querySelector('#sub-player-section');

                    eventTypeSelect.addEventListener('change', () => {
                        const isSub = eventTypeSelect.value === 'sub';
                        singlePlayerSection.classList.toggle('hidden', isSub);
                        subPlayerSection.classList.toggle('hidden', !isSub);
                    });

                    card.querySelector('#trigger-event-btn').addEventListener('click', () => {
                        const type = eventTypeSelect.value;
                        let eventData = {};
                        if (type === 'sub') {
                            const playerOnSelect = card.querySelector('#player-on-select');
                            const playerOffSelect = card.querySelector('#player-off-select');
                            const playerOn = playerOnSelect.value;
                            const playerOff = playerOffSelect.value;
                            if (!playerOn || !playerOff) return;
                            eventData = { playerOn, playerOff, teamId: playerOnSelect.options[playerOnSelect.selectedIndex].dataset.teamId };
                        } else {
                            const playerSelect = card.querySelector('#event-player-select');
                            const player = playerSelect.value;
                            if (!player) return;
                             eventData = { player, teamId: playerSelect.options[playerSelect.selectedIndex].dataset.teamId };
                        }
                        updateDoc(displayStateScoreboardDocRef, { currentBroadcastEvent: { type, data: eventData, id: Date.now() } });
                    });
                    
                    return card;
                }

                function createPlayerSelectCard(control) {
                    const card = document.createElement('div');
                    card.className = 'card p-4 rounded-xl border';
                    const isSeasonCard = control.id === 'playerProfileSeason';
                    const fieldName = isSeasonCard ? 'selectedPlayerId_Season' : 'selectedPlayerId_Profile';
                    
                    card.innerHTML = `<h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">${control.title}</h2>
                        <div class="space-y-4">
                            <select id="${control.id}-select" class="w-full p-2 border rounded-lg"><option>(Load fixture first)</option></select>
                            <button class="btn btn-primary w-full py-2">Show Player</button>
                        </div>`;
                    
                    card.querySelector('button').addEventListener('click', () => {
                        const selectedId = card.querySelector('select').value;
                        if(selectedId) {
                            if (isSeasonCard) {
                                statusText.textContent = `Triggering backend to fetch season data for player ${selectedId}...`;
                                 updateDoc(configDocRef, { 
                                     "fetcher.manualFetchTriggers.playerSeasonData": serverTimestamp(),
                                     "fetcher.targetPlayerId_Season": parseInt(selectedId)
                                 });
                             }
                            updateDoc(displayStateScoreboardDocRef, { [fieldName]: parseInt(selectedId), showPlayerProfile: !isSeasonCard, showPlayerSeason: isSeasonCard });
                        }
                    });

                    return card;
                }
                
                function createPredictionCard(control) {
                     const card = document.createElement('div');
                    card.className = 'card p-4 rounded-xl border';
                    card.innerHTML = `<h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">${control.title}</h2>
                        <div class="space-y-4">
                            <button class="btn btn-primary w-full py-2">Load Data & Show</button>
                        </div>`;
                    
                    card.querySelector('button').addEventListener('click', () => {
                        statusText.textContent = `Triggering backend to fetch prediction data...`;
                        updateDoc(configDocRef, { "fetcher.manualFetchTriggers.predictionData": serverTimestamp() });
                        updateDoc(displayStateScoreboardDocRef, { showPrediction: true });
                    });
                    
                    return card;
                }

                function createPodcastContentCard(control) {
                    const isQuestions = control.id === 'questions';
                    const colRef = isQuestions ? podcastQuestionsColRef : podcastHeadlinesColRef;
                    const card = document.createElement('div');
                    card.className = 'card p-4 rounded-xl border';
                    card.innerHTML = `<h2 class="card-title text-lg font-bold pb-2 mb-4 border-b">${control.title}</h2>
                        <div class="dynamic-form space-y-2">
                            <input type="text" id="${control.id}-input-1" class="w-full p-2 border rounded-lg" placeholder="${isQuestions ? 'Enter question...' : 'Enter title...'}">
                            <textarea id="${control.id}-input-2" class="w-full p-2 border rounded-lg" placeholder="${isQuestions ? 'Enter name...' : 'Enter description...'}" rows="2"></textarea>
                            ${isQuestions ? 
                                `<select id="${control.id}-input-3" class="w-full p-2 border rounded-lg"><option value="twitter">Twitter</option><option value="facebook">Facebook</option><option value="discord">Discord</option><option value="reddit">Reddit</option><option value="other">Other</option></select>` : 
                                `<input type="text" id="${control.id}-input-3" class="w-full p-2 border rounded-lg" placeholder="image.png">`
                            }
                            <button id="add-${control.id}-btn" class="btn btn-primary w-full">Add</button>
                        </div>
                        <div id="${control.id}-list-container" class="dynamic-list mt-4 space-y-2"></div>`;

                    const inputs = [card.querySelector(`#${control.id}-input-1`), card.querySelector(`#${control.id}-input-2`), card.querySelector(`#${control.id}-input-3`)];
                    const listContainer = card.querySelector(`#${control.id}-list-container`);
                    
                    card.querySelector(`#add-${control.id}-btn`).addEventListener('click', () => {
                        const [val1, val2, val3] = inputs.map(i => i.value.trim());
                        if (!val1 || !val2) return;
                        const data = isQuestions ? { text: val1, name: val2, source: val3, createdAt: serverTimestamp() } : { title: val1, description: val2, image: val3, createdAt: serverTimestamp() };
                        addDoc(colRef, data);
                        inputs.forEach(i => i.value = '');
                    });

                    allUnsubscribers.push(onSnapshot(query(colRef, orderBy('createdAt', 'desc')), (snapshot) => {
                        listContainer.innerHTML = '';
                        snapshot.forEach(doc => {
                            const item = doc.data();
                            const itemEl = document.createElement('div');
                            itemEl.className = 'dynamic-item p-2 rounded-lg flex justify-between items-center';
                            itemEl.innerHTML = `<span class="text-sm flex-grow pr-2">${isQuestions ? item.text : item.title}</span>
                                <div class="flex-shrink-0 flex gap-1">
                                    <button class="show-btn btn btn-secondary text-xs px-2 py-1">Show</button>
                                    <button class="remove-btn btn btn-danger text-xs px-2 py-1">X</button>
                                </div>`;
                            itemEl.querySelector('.show-btn').addEventListener('click', () => {
                                const fieldToUpdate = isQuestions ? { currentQuestionId: doc.id, showQuestions: true } : { currentHeadlineId: doc.id, showNews: true };
                                updateDoc(displayStatePodcastDocRef, fieldToUpdate);
                            });
                            itemEl.querySelector('.remove-btn').addEventListener('click', () => deleteDoc(doc.ref));
                            listContainer.appendChild(itemEl);
                        });
                    }));
                    return card;
                }

                function initializeInteractiveCards(fixtureId) {
                    console.log(`Initializing interactive cards for fixture ID: ${fixtureId}`);
                    const liveDataDocRef = doc(db, 'liveData', String(fixtureId));
                    const unsub = onSnapshot(liveDataDocRef, (doc) => {
                        if (doc.exists()) {
                            const data = doc.data();
                            
                            const homeName = document.getElementById('home-name-control');
                            const awayName = document.getElementById('away-name-control');
                            if (homeName && data.fixtureDetails) {
                                homeName.textContent = data.fixtureDetails.teams.home.name;
                                awayName.textContent = data.fixtureDetails.teams.away.name;
                            }
                            
                            const playerDropdowns = [
                                {el: document.getElementById('event-player-select'), type: 'name'},
                                {el: document.getElementById('player-off-select'), type: 'name'},
                                {el: document.getElementById('player-on-select'), type: 'name'},
                                {el: document.getElementById('playerProfile-select'), type: 'id'},
                                {el: document.getElementById('playerProfileSeason-select'), type: 'id'},
                            ];
                            
                            if(playerDropdowns[0].el && data.lineupData && data.lineupData.home && data.lineupData.away) {
                                const { home, away } = data.lineupData;
                                
                                const populate = (select, valueType) => {
                                    if(!select) return;
                                    select.innerHTML = '';
                                    const createOptGroup = (team, type) => {
                                        const group = document.createElement('optgroup');
                                        group.label = team.team.name;
                                        team[type].forEach(p => {
                                            const opt = document.createElement('option');
                                            opt.value = valueType === 'id' ? p.player.id : p.player.name;
                                            opt.dataset.teamId = team.team.id;
                                            opt.textContent = `#${p.player.number} ${p.player.name}`;
                                            group.appendChild(opt);
                                        });
                                        return group;
                                    };
                                    if(home) {
                                        select.appendChild(createOptGroup(home, 'startXI'));
                                        select.appendChild(createOptGroup(home, 'substitutes'));
                                    }
                                    if(away) {
                                        select.appendChild(createOptGroup(away, 'startXI'));
                                        select.appendChild(createOptGroup(away, 'substitutes'));
                                    }
                                };
                                playerDropdowns.forEach(item => populate(item.el, item.type));
                            }
                        }
                    });
                    allUnsubscribers.push(unsub);
                }

                // Initial call to setup fixtures on load
                listenForFixtures();

                return () => {
                    console.log("Unsubscribing from all listeners...");
                    allUnsubscribers.forEach(unsub => unsub());
                };
            }
        });
    </script>
</body>
</html>

