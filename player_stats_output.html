<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Statistics - Live</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <link rel="stylesheet" href="player_stats.css">
</head>
<body>
    <div id="player-stats-container">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: Firebase config is now embedded directly in the script ---
            // REASON: This removes the need for an extra file and keeps the overlay self-contained.
            const firebaseConfig = {
                apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
  authDomain: "scoreboard-control.firebaseapp.com",
  projectId: "scoreboard-control",
  storageBucket: "scoreboard-control.firebasestorage.app",
  messagingSenderId: "438021450087",
  appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            const container = document.getElementById('player-stats-container');
            const playerStatsDocRef = db.collection('scoreboard').doc('playerStats');
            const playerStatsDataDocRef = db.collection('scoreboard').doc('playerStatsData');
            const fixtureDocRef = db.collection('scoreboard').doc('currentFixture');

            let showStats = false;
            let currentFixtureDetail = null;
            let currentStatsData = null;

            function renderGraphic() {
                if (showStats && currentFixtureDetail && currentStatsData) {
                    buildGraphic(currentFixtureDetail, currentStatsData);
                } else {
                    container.innerHTML = '';
                }
            }

            playerStatsDocRef.onSnapshot((doc) => {
                showStats = doc.exists && doc.data().show;
                renderGraphic();
            });

            fixtureDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    currentFixtureDetail = doc.data();
                    renderGraphic();
                }
            });

            playerStatsDataDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    currentStatsData = doc.data().stats;
                    renderGraphic();
                }
            });

            function getRatingColorClass(ratingStr) {
                const r = parseFloat(ratingStr);
                if (isNaN(r)) return 'rating-neutral';
                if (r < 6) return 'rating-red';
                if (r < 7) return 'rating-neutral'; 
                if (r < 8) return 'rating-green-light';
                if (r < 9) return 'rating-green-dark';
                return 'rating-blue';
            }

            function calculateAverageRating(players) {
                const playersWithRatings = players.filter(p => p.statistics[0].games.rating && parseFloat(p.statistics[0].games.rating) > 0);
                if (playersWithRatings.length === 0) return 'N/A';
                
                const totalRating = playersWithRatings.reduce((sum, p) => sum + parseFloat(p.statistics[0].games.rating), 0);
                return (totalRating / playersWithRatings.length).toFixed(1);
            }

            function findStarPlayer(homePlayers, awayPlayers) {
                const allPlayers = [...homePlayers, ...awayPlayers];
                const playersWithRatings = allPlayers.filter(p => p.statistics[0].games.rating && parseFloat(p.statistics[0].games.rating) > 0);

                if (playersWithRatings.length === 0) return null;

                return playersWithRatings.reduce((best, current) => {
                    return parseFloat(current.statistics[0].games.rating) > parseFloat(best.statistics[0].games.rating) ? current : best;
                });
            }

            function buildGraphic(fixtureDetail, playersData) {
                container.innerHTML = '';

                if (!playersData || playersData.length < 2 || !fixtureDetail) {
                    return;
                }

                const homeTeamData = playersData.find(t => t.team.id === fixtureDetail.teams.home.id) || playersData[0];
                const awayTeamData = playersData.find(t => t.team.id === fixtureDetail.teams.away.id) || playersData[1];

                const homeAvgRating = calculateAverageRating(homeTeamData.players);
                const awayAvgRating = calculateAverageRating(awayTeamData.players);
                const starPlayer = findStarPlayer(homeTeamData.players, awayTeamData.players);

                const wrapper = document.createElement('div');
                wrapper.className = 'stats-wrapper';

                wrapper.innerHTML = `
                    <div class="background-logos">
                        <img src="${fixtureDetail.teams.home.logo}" alt="${fixtureDetail.teams.home.name} Logo">
                        <img src="${fixtureDetail.teams.away.logo}" alt="${fixtureDetail.teams.away.name} Logo">
                    </div>
                `;

                const content = document.createElement('div');
                content.className = 'stats-content';
                const fixtureDate = new Date(fixtureDetail.fixture.date);
                const formattedDate = fixtureDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });

                content.innerHTML = `
                    <div class="top-bar">
                         <img src="${fixtureDetail.league.logo}" alt="${fixtureDetail.league.name}" class="league-logo">
                        <div class="fixture-details">
                            <div class="fixture-name">
                                <span class="team-name home">${fixtureDetail.teams.home.name}</span>
                                <span class="scoreline">${fixtureDetail.goals.home} - ${fixtureDetail.goals.away}</span>
                                <span class="team-name away">${fixtureDetail.teams.away.name}</span>
                            </div>
                            <div class="fixture-meta">${formattedDate} | ${fixtureDetail.fixture.venue.name}</div>
                        </div>
                    </div>
                `;

                const tablesArea = document.createElement('div');
                tablesArea.className = 'tables-area';

                tablesArea.innerHTML = `
                    <div class="team-table-container">
                        <div class="team-header">
                            <img src="${homeTeamData.team.logo}" alt="${homeTeamData.team.name} Logo">
                            <h3>${homeTeamData.team.name}</h3>
                        </div>
                        <table class="player-table">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    <th class="text-center">#</th>
                                    <th class="text-center">Mins</th>
                                    <th class="text-center">Rating</th>
                                    <th class="text-center">Gls</th>
                                    <th class="text-center">Ast</th>
                                    <th class="text-center">Shots (On)</th>
                                    <th class="text-center">KeyP</th>
                                    <th class="text-center">Tkls</th>
                                    <th class="text-center">Cards</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generatePlayerRows(homeTeamData.players)}
                            </tbody>
                        </table>
                        <div class="team-average-rating">
                            <span>Average Rating</span>
                            <span class="rating-cell ${getRatingColorClass(homeAvgRating)}">${homeAvgRating}</span>
                        </div>
                    </div>
                    <div class="team-table-container">
                        <div class="team-header">
                            <img src="${awayTeamData.team.logo}" alt="${awayTeamData.team.name} Logo">
                            <h3>${awayTeamData.team.name}</h3>
                        </div>
                        <table class="player-table">
                           <thead>
                                <tr>
                                    <th>Player</th>
                                    <th class="text-center">#</th>
                                    <th class="text-center">Mins</th>
                                    <th class="text-center">Rating</th>
                                    <th class="text-center">Gls</th>
                                    <th class="text-center">Ast</th>
                                    <th class="text-center">Shots (On)</th>
                                    <th class="text-center">KeyP</th>
                                    <th class="text-center">Tkls</th>
                                    <th class="text-center">Cards</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generatePlayerRows(awayTeamData.players)}
                            </tbody>
                        </table>
                        <div class="team-average-rating">
                            <span>Average Rating</span>
                            <span class="rating-cell ${getRatingColorClass(awayAvgRating)}">${awayAvgRating}</span>
                        </div>
                    </div>
                `;

                content.appendChild(tablesArea);

                if (starPlayer) {
                    const spStats = starPlayer.statistics[0];
                    const spRating = parseFloat(spStats.games.rating).toFixed(1);
                    const localImagePath = `/images/players/${starPlayer.player.id}.png`;

                    const starPlayerSection = document.createElement('div');
                    starPlayerSection.className = 'star-player-section';
                    starPlayerSection.innerHTML = `
                        <div class="star-player-title">⭐ Star Player</div>
                        <div class="star-player-content">
                            <img src="${localImagePath}" class="star-player-photo" onerror="this.onerror=null; this.src='${starPlayer.player.photo}'; this.style.opacity=0.5;">
                            <div class="star-player-details">
                                <div class="star-player-name">${starPlayer.player.name}</div>
                                <div class="star-player-rating rating-cell ${getRatingColorClass(spRating)}">${spRating}</div>
                            </div>
                            <div class="star-player-stats">
                                <div class="stat-item"><span>${spStats.goals.total || 0}</span><span>Goals</span></div>
                                <div class="stat-item"><span>${spStats.goals.assists || 0}</span><span>Assists</span></div>
                                <div class="stat-item"><span>${spStats.shots.total || 0}</span><span>Shots</span></div>
                                <div class="stat-item"><span>${spStats.passes.key || 0}</span><span>Key Passes</span></div>
                            </div>
                        </div>
                    `;
                    content.appendChild(starPlayerSection);
                }

                wrapper.appendChild(content);
                container.appendChild(wrapper);
                
                setTimeout(() => {
                    tablesArea.classList.add('visible');
                    const spSection = container.querySelector('.star-player-section');
                    if(spSection) spSection.classList.add('visible');
                }, 100);
            }

            function generatePlayerRows(players) {
                let rowsHtml = '';
                players
                    .filter(p => p.statistics[0].games.minutes)
                    .sort((a, b) => b.statistics[0].games.minutes - a.statistics[0].games.minutes)
                    // --- MODIFICATION: Changed slice limit from 15 to 16 ---
                    // REASON: To correctly display 11 starters and a maximum of 5 substitutes, for a total of 16 players.
                    .slice(0, 16) 
                    .forEach(p => {
                        const stats = p.statistics[0];
                        const rating = stats.games.rating ? parseFloat(stats.games.rating).toFixed(1) : '-';
                        
                        const ratingClass = getRatingColorClass(rating);

                        let cardDisplay = '-';
                        if (stats.cards.yellow > 0) cardDisplay = '<span class="card-yellow"></span>';
                        if (stats.cards.red > 0) cardDisplay = (cardDisplay !== '-') ? `${cardDisplay} <span class="card-red"></span>` : '<span class="card-red"></span>';

                        rowsHtml += `
                            <tr>
                                <td>${p.player.name}</td>
                                <td class="text-center">${stats.games.number || '-'}</td>
                                <td class="text-center">${stats.games.minutes || '-'}</td>
                                <td class="text-center"><span class="rating-cell ${ratingClass}">${rating}</span></td>
                                <td class="text-center">${stats.goals.total || 0}</td>
                                <td class="text-center">${stats.goals.assists || 0}</td>
                                <td class="text-center">${stats.shots.total || 0} (${stats.shots.on || 0})</td>
                                <td class="text-center">${stats.passes.key || 0}</td>
                                <td class="text-center">${stats.tackles.total || 0}</td>
                                <td class="text-center">${cardDisplay}</td>
                            </tr>
                        `;
                    });
                return rowsHtml;
            }
        });
    </script>
</body>
</html>