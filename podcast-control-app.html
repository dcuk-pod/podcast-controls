<!DOCTYPE html>
<html lang="en"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Visuals Control App</title>
    
    <link rel="manifest" href="manifest-podcast.json">
    <meta name="theme-color" id="theme-color-meta" content="#3498db">
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');
        
        /* COMMENT: CSS Variables for Light/Dark Mode. Same as the other app for consistency. */
        :root {
            --bg-color: #f0f2f5;
            --card-bg-color: #ffffff;
            --text-color: #333333;
            --text-color-light: #555555;
            --border-color: #e0e0e0;
            --border-color-light: #eeeeee;
            --input-border-color: #cccccc;
            --header-bg-color: #ffffff;
            --api-bar-bg-color: #e9ecef;
            --fixture-bg-color: #f9f9f9;
            --primary-color: #3498db;
            --primary-hover-color: #2980b9;
            --danger-color: #e74c3c;
            --danger-hover-color: #c0392b;
            --success-color: #2ecc71;
            --success-hover-color: #27ae60;
            --disabled-color: #bdc3c7;
            --slider-bg-color: #ccc;
        }

        html[data-theme="dark"] {
            --bg-color: #121212;
            --card-bg-color: #1e1e1e;
            --text-color: #e0e0e0;
            --text-color-light: #bbbbbb;
            --border-color: #3a3a3a;
            --border-color-light: #2c2c2c;
            --input-border-color: #444444;
            --header-bg-color: #1e1e1e;
            --api-bar-bg-color: #2c2c2c;
            --fixture-bg-color: #252525;
            --primary-color: #3498db;
            --primary-hover-color: #4aa9e4;
            --danger-color: #e74c3c;
            --danger-hover-color: #f06a5a;
            --success-color: #2ecc71;
            --success-hover-color: #48d989;
            --disabled-color: #555;
            --slider-bg-color: #555;
        }
        
        /* COMMENT: All styles below now use the CSS variables for color */
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        .hidden { display: none !important; }
        #login-container { max-width: 400px; margin: 100px auto; background: var(--card-bg-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #login-container h1 { text-align: center; margin-top: 0; }
        #login-form { display: flex; flex-direction: column; gap: 15px; }
        #login-form input { padding: 12px; font-size: 16px; border: 1px solid var(--input-border-color); border-radius: 5px; background-color:var(--bg-color); color:var(--text-color); }
        #login-error { color: var(--danger-color); text-align: center; font-weight: bold; margin-top: 10px; }
        .control-panel-wrapper { max-width: 1200px; margin: 0 auto; background: var(--header-bg-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .panel-header h1 { margin: 0; font-size: 24px; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        .api-status-bar { background-color: var(--api-bar-bg-color); padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(3, 1fr); align-items: center; font-size: 14px; text-align: center; }
        .api-status-bar .session-calls { text-align: left; }
        .api-status-bar .daily-calls { text-align: right; }
        .api-status-bar span { font-weight: bold; }
        .fixture-container { background-color: var(--fixture-bg-color); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .fixture-header { padding: 15px; cursor: pointer; font-weight: bold; font-size: 18px; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .fixture-header::after { content: '‚ñ≤'; transition: transform 0.3s ease; }
        .fixture-container.collapsed .fixture-header::after { transform: rotate(180deg); }
        .data-fetch-section { padding: 15px; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px; max-height: 500px; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; }
        .fixture-container.collapsed .data-fetch-section { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; }
        .data-fetch-section label { font-weight: bold; }
        .data-fetch-section select, .data-fetch-section button { padding: 10px; border-radius: 5px; border: 1px solid var(--input-border-color); font-size: 14px; width: 100%; background-color: var(--card-bg-color); color:var(--text-color); }
        .full-width { width: 100%; grid-column: 1 / -1; }
        #podcast-status-text { margin-top: 10px; color: var(--text-color-light); font-style: italic; }
        .control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .control-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; background-color: var(--card-bg-color); }
        .card-title { margin-top: 0; font-size: 18px; border-bottom: 1px solid var(--border-color-light); padding-bottom: 10px; margin-bottom: 15px; }
        button { padding: 8px 15px; border: none; background-color: var(--primary-color); color: white; border-radius: 5px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
        button:hover { background-color: var(--primary-hover-color); }
        button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        button.refresh-btn { background-color: var(--success-color); }
        button.refresh-btn:hover { background-color: var(--success-hover-color); }
        button.remove-btn, button.logout-btn { background-color: var(--danger-color); }
        button.remove-btn:hover, button.logout-btn:hover { background-color: var(--danger-hover-color); }
        .switch-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
        .switch-container span { font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--slider-bg-color); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        .theme-switch-wrapper { display: flex; align-items: center; gap: 8px; }
        .dynamic-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .dynamic-form input, .dynamic-form select, .dynamic-form textarea { padding: 8px; border-radius: 5px; border: 1px solid var(--input-border-color); font-size: 14px; font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color:var(--text-color); }
        .dynamic-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid var(--border-color-light); padding-top: 15px; }
        .dynamic-item { display: flex; justify-content: space-between; align-items: center; background-color: var(--fixture-bg-color); padding: 10px; border-radius: 5px; }
        .dynamic-text { flex-grow: 1; font-size: 14px; word-break: break-all; }
        .dynamic-text strong { color: var(--text-color-light); }
        .dynamic-actions { display: flex; gap: 5px; }
        .dynamic-actions button { padding: 5px 10px; font-size: 12px; }
    </style>
</head>
<body>
    <div id="login-container">
        <h1>Podcast Login</h1>
        <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login</button>
            <p id="login-error" class="hidden"></p>
        </form>
    </div>

    <div id="app-container" class="hidden">
        <div class="control-panel-wrapper">
            <header class="panel-header">
                <h1>Podcast Visuals Control Panel</h1>
                <div class="header-controls">
                    <div class="theme-switch-wrapper">
                        <span>‚òÄÔ∏è</span>
                        <label class="switch">
                            <input type="checkbox" id="theme-toggle">
                            <span class="slider"></span>
                        </label>
                        <span>üåô</span>
                    </div>
                    <a href="scoreboard_control_app.html"><button>Scoreboard App</button></a>
                    <button id="logout-btn" class="logout-btn">Logout</button>
                </div>
            </header>

            <div class="api-status-bar">
                <div class="session-calls">Session API Calls: <span id="podcast-session-api-calls">0</span></div>
                <div></div>
                <div class="daily-calls">Daily API Calls: <span id="podcast-daily-api-calls">Loading...</span></div>
            </div>

            <div class="fixture-container">
                <div class="fixture-header" id="podcast-fixture-header">Fixture Selection</div>
                <div class="data-fetch-section">
                    <label for="podcast-year-select">Season:</label>
                    <select id="podcast-year-select">
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                    </select>
                    <button id="podcast-get-fixtures-btn">Get Fixtures</button>
                    
                    <label for="podcast-fixture-select">Fixture:</label>
                    <select id="podcast-fixture-select">
                        <option>Select a year first...</option>
                    </select>
                    <button id="podcast-load-fixture-btn">Load Selected Fixture</button>

                    <p id="podcast-status-text" class="full-width">Select a season and click "Get Fixtures" to begin.</p>
                </div>
            </div>

            <div class="control-grid">
                <div class="control-card">
                    <h2 class="card-title">Fixtures</h2>
                    <div>
                        <button id="podcast-refresh-fixtures-btn" class="refresh-btn full-width">Refresh Data</button>
                        <div class="switch-container">
                            <span>Show Visual</span>
                            <label class="switch">
                                <input type="checkbox" id="podcast-toggle-fixtures">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Next Fixtures</h2>
                    <div>
                        <button id="podcast-refresh-next-fixtures-btn" class="refresh-btn full-width">Refresh Data</button>
                        <div class="switch-container">
                            <span>Show Visual</span>
                            <label class="switch">
                                <input type="checkbox" id="podcast-toggle-next-fixtures">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Prediction</h2>
                    <div>
                        <button id="podcast-refresh-prediction-btn" class="refresh-btn full-width">Refresh Data</button>
                        <div class="switch-container">
                            <span>Show Visual</span>
                            <label class="switch">
                                <input type="checkbox" id="podcast-toggle-prediction">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Player Stats</h2>
                    <div>
                        <button id="podcast-refresh-player-stats-btn" class="refresh-btn full-width">Refresh Data</button>
                        <div class="switch-container">
                            <span>Show Visual</span>
                            <label class="switch">
                                <input type="checkbox" id="podcast-toggle-player-stats">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Match Stats</h2>
                    <div>
                        <button id="podcast-refresh-match-stats-btn" class="refresh-btn full-width">Refresh Data</button>
                        <div class="switch-container">
                            <span>Show Visual</span>
                            <label class="switch">
                                <input type="checkbox" id="podcast-toggle-match-stats">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Player Profile</h2>
                     <div class="switch-container">
                        <span>Show Visual</span>
                        <label class="switch">
                            <input type="checkbox" id="podcast-toggle-player-profile">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Podcast Questions</h2>
                    <div class="dynamic-form">
                        <input type="text" id="question-text-input" placeholder="Enter question...">
                        <input type="text" id="question-name-input" placeholder="Enter name...">
                        <select id="question-source-select">
                            <option value="twitter">Twitter</option>
                            <option value="facebook">Facebook</option>
                            <option value="instagram">Instagram</option>
                            <option value="discord">Discord</option>
                            <option value="reddit">Reddit</option>
                            <option value="other">Other</option>
                        </select>
                        <button id="add-question-btn">Add Question</button>
                    </div>
                    <div class="dynamic-list" id="questions-list-container"></div>
                     <div class="switch-container">
                        <span>Show Visual</span>
                        <label class="switch">
                            <input type="checkbox" id="podcast-toggle-questions">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">News</h2>
                    <div class="dynamic-form">
                        <input type="text" id="headline-title-input" placeholder="Enter headline...">
                        <textarea id="headline-desc-input" placeholder="Enter description..." rows="3"></textarea>
                        <input type="text" id="headline-image-input" placeholder="Enter image filename (e.g., news.png)">
                        <button id="add-headline-btn">Add Headline</button>
                    </div>
                    <div class="dynamic-list" id="headlines-list-container"></div>
                     <div class="switch-container">
                        <span>Show Visual</span>
                        <label class="switch">
                            <input type="checkbox" id="podcast-toggle-news">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // COMMENT: Service Worker Registration. This registers the same sw.js file for this app.
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then(registration => {
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        })
                        .catch(err => {
                            console.log('ServiceWorker registration failed: ', err);
                        });
                });
            }

            // COMMENT: Dark Mode Logic. This is identical to the other app.
            const themeToggle = document.getElementById('theme-toggle');
            const themeColorMeta = document.getElementById('theme-color-meta');

            const applyTheme = (theme) => {
                document.documentElement.setAttribute('data-theme', theme);
                if (theme === 'dark') {
                    themeToggle.checked = true;
                    themeColorMeta.setAttribute('content', '#1e1e1e');
                } else {
                    themeToggle.checked = false;
                    themeColorMeta.setAttribute('content', '#3498db');
                }
            };

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (savedTheme) {
                applyTheme(savedTheme);
            } else if (prefersDark) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }

            themeToggle.addEventListener('change', () => {
                const newTheme = themeToggle.checked ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                applyTheme(newTheme);
            });
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });


            // All of your existing podcast app logic remains below this line...
            const firebaseConfig = {
                apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
                authDomain: "scoreboard-control.firebaseapp.com",
                projectId: "scoreboard-control",
                storageBucket: "scoreboard-control.appspot.com",
                messagingSenderId: "438021450087",
                appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
            };
            firebase.initializeApp(firebaseConfig);
            
            const auth = firebase.auth();
            const db = firebase.firestore();

            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const loginEmail = document.getElementById('login-email');
            const loginPassword = document.getElementById('login-password');
            const loginError = document.getElementById('login-error');
            const logoutBtn = document.getElementById('logout-btn');

            auth.onAuthStateChanged(user => {
                if (user) {
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    loginError.classList.add('hidden');
                    initializeApp();
                } else {
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            });

            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value)
                    .catch(error => {
                        console.error('Login Error:', error);
                        loginError.textContent = 'Error: Invalid email or password.';
                        loginError.classList.remove('hidden');
                    });
            });
            
            logoutBtn.addEventListener('click', () => auth.signOut());

            function initializeApp() {
                const PODCAST_TEAM_ID = 1615;
                
                const podcastVisibilityDocRef = db.collection('podcast').doc('visibility');
                const podcastFixtureDocRef = db.collection('podcast').doc('currentFixture');
                const podcastFixturesDataDocRef = db.collection('podcast').doc('fixturesData');
                const podcastNextFixturesDataDocRef = db.collection('podcast').doc('nextFixturesData');
                const podcastPredictionDataDocRef = db.collection('podcast').doc('predictionData');
                const podcastPlayerStatsDataDocRef = db.collection('podcast').doc('playerStatsData');
                const podcastMatchStatsDataDocRef = db.collection('podcast').doc('matchStatsData');
                const podcastQuestionsCollectionRef = db.collection('podcastQuestions');
                const podcastCurrentQuestionDocRef = db.collection('podcast').doc('currentQuestion');
                const podcastHeadlinesCollectionRef = db.collection('podcastHeadlines');
                const podcastCurrentHeadlineDocRef = db.collection('podcast').doc('currentHeadline');

                let sessionApiCallCount = 0;

                const statusText = document.getElementById('podcast-status-text');
                const yearSelect = document.getElementById('podcast-year-select');
                const getFixturesBtn = document.getElementById('podcast-get-fixtures-btn');
                const fixtureSelect = document.getElementById('podcast-fixture-select');
                const loadFixtureBtn = document.getElementById('podcast-load-fixture-btn');
                const sessionApiCallsSpan = document.getElementById('podcast-session-api-calls');
                const dailyApiCallsSpan = document.getElementById('podcast-daily-api-calls');
                const questionTextInput = document.getElementById('question-text-input');
                const questionNameInput = document.getElementById('question-name-input');
                const questionSourceSelect = document.getElementById('question-source-select');
                const addQuestionBtn = document.getElementById('add-question-btn');
                const questionsListContainer = document.getElementById('questions-list-container');
                const headlineTitleInput = document.getElementById('headline-title-input');
                const headlineDescInput = document.getElementById('headline-desc-input');
                const headlineImageInput = document.getElementById('headline-image-input');
                const addHeadlineBtn = document.getElementById('add-headline-btn');
                const headlinesListContainer = document.getElementById('headlines-list-container');
                
                document.getElementById('podcast-fixture-header').addEventListener('click', () => document.querySelector('.fixture-container').classList.toggle('collapsed'));

                async function fetchApiProxy(apiPath) {
                    const response = await fetch(`/api${apiPath}`);
                    sessionApiCallCount++; 
                    sessionApiCallsSpan.textContent = sessionApiCallCount;
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `API Proxy Error: ${response.status}`);
                    }
                    return response.json();
                }

                async function fetchApiStatus() {
                    try {
                        const data = await fetchApiProxy('/status');
                        if (data.response && data.response.requests) {
                            dailyApiCallsSpan.textContent = `${data.response.requests.current} / ${data.response.requests.limit_day}`;
                        }
                    } catch (err) { console.error("Error fetching API status:", err); dailyApiCallsSpan.textContent = 'Error'; }
                }

                async function getFixturesForYear() {
                    const year = yearSelect.value;
                    statusText.textContent = `Checking for saved fixtures for ${year}...`;
                    const fixturesDocRef = db.collection('fixtures').doc(year);
                    try {
                        const doc = await fixturesDocRef.get();
                        if (doc.exists && doc.data().fixtures && doc.data().fixtures.length > 0) {
                            statusText.textContent = `Fixtures for ${year} loaded from database.`;
                            populateFixtureSelect(doc.data().fixtures);
                        } else {
                            statusText.textContent = `Fetching fixtures for ${year} from API...`;
                            const data = await fetchApiProxy(`/fixtures?season=${year}&team=${PODCAST_TEAM_ID}`);
                            if (!data.response || data.response.length === 0) throw new Error(`No fixtures found for ${year}.`);
                            const fixtures = data.response.map(f => ({ id: f.fixture.id, name: `${f.teams.home.name} vs ${f.teams.away.name} (${new Date(f.fixture.date).toLocaleDateString()})`, competition: f.league.name }));
                            await fixturesDocRef.set({ fixtures });
                            statusText.textContent = `Fixtures for ${year} fetched and saved.`;
                            populateFixtureSelect(fixtures);
                        }
                    } catch (err) { console.error("Error getting fixtures:", err); statusText.textContent = `Error: ${err.message}`; statusText.style.color = 'red'; }
                }
                
                function populateFixtureSelect(fixtures) {
                    fixtureSelect.innerHTML = ''; 
                    if (!fixtures || fixtures.length === 0) { fixtureSelect.innerHTML = '<option>No fixtures found</option>'; return; }
                    const groupedByCompetition = fixtures.reduce((acc, fixture) => {
                        const comp = fixture.competition || 'Other';
                        if (!acc[comp]) acc[comp] = [];
                        acc[comp].push(fixture);
                        return acc;
                    }, {});
                    for (const competition in groupedByCompetition) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = competition;
                        groupedByCompetition[competition].forEach(fixture => {
                            const option = document.createElement('option');
                            option.value = fixture.id;
                            option.textContent = fixture.name;
                            optgroup.appendChild(option);
                        });
                        fixtureSelect.appendChild(optgroup);
                    }
                }

                async function loadFixtureData() {
                    const fixtureId = fixtureSelect.value;
                    if (!fixtureId || isNaN(fixtureId)) { statusText.textContent = "Error: Please select a valid fixture."; statusText.style.color = 'red'; return; }
                    statusText.textContent = "Fetching selected fixture data..."; statusText.style.color = '#555';
                    try {
                        const data = await fetchApiProxy(`/fixtures?id=${fixtureId}`);
                        if (!data.response || data.response.length === 0) throw new Error("Fixture data not found.");
                        const fixtureDetails = data.response[0];
                        await podcastFixtureDocRef.set(fixtureDetails);
                        statusText.textContent = `Successfully loaded: ${fixtureDetails.teams.home.name} vs ${fixtureDetails.teams.away.name}.`;
                    } catch (err) { console.error("PODCAST APP ERROR:", err); statusText.textContent = `Error: ${err.message}`; statusText.style.color = 'red'; }
                }

                async function refreshGenericData(endpoint, docRef, dataKey, successMessage, errorMessage) {
                    const fixtureId = fixtureSelect.value;
                    if (endpoint.includes('fixture=') && (!fixtureId || isNaN(fixtureId))) {
                         statusText.textContent = "Error: Please select a valid fixture first."; statusText.style.color = 'red'; return;
                    }
                    let finalEndpoint = endpoint.replace('${fixtureSelect.value}', fixtureId);
                    
                    statusText.textContent = `Fetching ${successMessage}...`; statusText.style.color = 'var(--text-color-light)';
                     try {
                        const data = await fetchApiProxy(`/${finalEndpoint}`);
                        if (!data.response || data.response.length === 0) throw new Error(`No ${errorMessage} found.`);
                        const payload = endpoint.includes('predictions?') ? data.response[0] : data.response;
                        await docRef.set({ [dataKey]: payload, lastUpdated: new Date().toISOString() });
                        statusText.textContent = `${successMessage} refreshed and saved.`; statusText.style.color = 'var(--success-color)';
                    } catch (err) { console.error(`Error refreshing ${successMessage}:`, err); statusText.textContent = `Error: ${err.message}`; statusText.style.color = 'var(--danger-color)'; }
                }
                
                getFixturesBtn.addEventListener('click', getFixturesForYear);
                loadFixtureBtn.addEventListener('click', loadFixtureData);
                document.getElementById('podcast-refresh-fixtures-btn').addEventListener('click', () => refreshGenericData(`fixtures?season=${yearSelect.value}&team=${PODCAST_TEAM_ID}`, podcastFixturesDataDocRef, 'fixtures', 'Fixtures', 'fixtures'));
                document.getElementById('podcast-refresh-next-fixtures-btn').addEventListener('click', () => refreshGenericData(`fixtures?team=${PODCAST_TEAM_ID}&next=5`, podcastNextFixturesDataDocRef, 'fixtures', 'Next fixtures', 'next fixtures'));
                document.getElementById('podcast-refresh-prediction-btn').addEventListener('click', () => refreshGenericData(`predictions?fixture=${fixtureSelect.value}`, podcastPredictionDataDocRef, 'prediction', 'Prediction data', 'prediction data'));
                document.getElementById('podcast-refresh-player-stats-btn').addEventListener('click', () => refreshGenericData(`fixtures/players?fixture=${fixtureSelect.value}`, podcastPlayerStatsDataDocRef, 'stats', 'Player stats', 'player stats'));
                document.getElementById('podcast-refresh-match-stats-btn').addEventListener('click', () => refreshGenericData(`fixtures/statistics?fixture=${fixtureSelect.value}`, podcastMatchStatsDataDocRef, 'stats', 'Match stats', 'match stats'));

                addQuestionBtn.addEventListener('click', () => {
                    const text = questionTextInput.value.trim();
                    const name = questionNameInput.value.trim();
                    const source = questionSourceSelect.value;
                    if (!text || !name) {
                        statusText.textContent = "Please enter both a question and a name.";
                        statusText.style.color = 'var(--danger-color)';
                        return;
                    }
                    podcastQuestionsCollectionRef.add({ text, name, source, createdAt: new Date() });
                    questionTextInput.value = '';
                    questionNameInput.value = '';
                });

                podcastQuestionsCollectionRef.orderBy("createdAt", "desc").onSnapshot(snapshot => {
                    questionsListContainer.innerHTML = '';
                    if (snapshot.empty) { questionsListContainer.innerHTML = '<p>No questions added yet.</p>'; return; }
                    snapshot.forEach(doc => {
                        const question = doc.data();
                        const item = document.createElement('div');
                        item.className = 'dynamic-item';
                        item.innerHTML = `<div class="dynamic-text">"${question.text}" ‚Äî <strong>${question.name}</strong></div><div class="dynamic-actions"><button class="show-question-btn">Show</button><button class="remove-question-btn remove-btn">X</button></div>`;
                        item.querySelector('.show-question-btn').addEventListener('click', () => {
                            podcastCurrentQuestionDocRef.set({ ...question, show: true });
                            statusText.textContent = `Set question from ${question.name} to be shown.`; statusText.style.color = 'var(--success-color)';
                        });
                        item.querySelector('.remove-question-btn').addEventListener('click', () => doc.ref.delete());
                        questionsListContainer.appendChild(item);
                    });
                });

                addHeadlineBtn.addEventListener('click', () => {
                    const title = headlineTitleInput.value.trim();
                    const description = headlineDescInput.value.trim();
                    const imageFile = headlineImageInput.value.trim();

                    if (!title || !description || !imageFile) {
                        statusText.textContent = "Please fill in all headline fields.";
                        statusText.style.color = 'var(--danger-color)';
                        return;
                    }

                    podcastHeadlinesCollectionRef.add({
                        title,
                        description,
                        image: imageFile,
                        createdAt: new Date()
                    });

                    headlineTitleInput.value = '';
                    headlineDescInput.value = '';
                    headlineImageInput.value = '';
                });

                podcastHeadlinesCollectionRef.orderBy("createdAt", "desc").onSnapshot(snapshot => {
                    headlinesListContainer.innerHTML = '';
                    if (snapshot.empty) { headlinesListContainer.innerHTML = '<p>No headlines added yet.</p>'; return; }
                    snapshot.forEach(doc => {
                        const headline = doc.data();
                        const item = document.createElement('div');
                        item.className = 'dynamic-item';
                        item.innerHTML = `<div class="dynamic-text"><strong>${headline.title}</strong></div><div class="dynamic-actions"><button class="show-headline-btn">Show</button><button class="remove-headline-btn remove-btn">X</button></div>`;
                        
                        item.querySelector('.show-headline-btn').addEventListener('click', () => {
                            podcastCurrentHeadlineDocRef.set({ ...headline, show: true });
                            statusText.textContent = `Set headline "${headline.title}" to be shown.`; statusText.style.color = 'var(--success-color)';
                        });

                        item.querySelector('.remove-headline-btn').addEventListener('click', () => doc.ref.delete());
                        headlinesListContainer.appendChild(item);
                    });
                });

                const addSwitchListener = (elementId, firestoreField, currentDocRef) => {
                    const toggle = document.getElementById(elementId);
                    if (toggle) {
                        toggle.addEventListener('change', (e) => {
                            const isVisible = e.target.checked;
                            podcastVisibilityDocRef.update({ [firestoreField]: isVisible });
                            if (currentDocRef) {
                                currentDocRef.update({ show: isVisible }).catch(() => currentDocRef.set({ show: isvisible }));
                            }
                        });
                    }
                };

                addSwitchListener('podcast-toggle-fixtures', 'showFixtures');
                addSwitchListener('podcast-toggle-next-fixtures', 'showNextFixtures');
                addSwitchListener('podcast-toggle-prediction', 'showPrediction');
                addSwitchListener('podcast-toggle-player-stats', 'showPlayerStats');
                addSwitchListener('podcast-toggle-match-stats', 'showMatchStats');
                addSwitchListener('podcast-toggle-player-profile', 'showPlayerProfile');
                addSwitchListener('podcast-toggle-questions', 'showQuestions', podcastCurrentQuestionDocRef);
                addSwitchListener('podcast-toggle-news', 'showNews', podcastCurrentHeadlineDocRef);

                podcastVisibilityDocRef.onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        const setSwitchState = (id, value) => {
                            const el = document.getElementById(id);
                            if (el) el.checked = !!value;
                        };
                        setSwitchState('podcast-toggle-fixtures', data.showFixtures);
                        setSwitchState('podcast-toggle-next-fixtures', data.showNextFixtures);
                        setSwitchState('podcast-toggle-prediction', data.showPrediction);
                        setSwitchState('podcast-toggle-player-stats', data.showPlayerStats);
                        setSwitchState('podcast-toggle-match-stats', data.showMatchStats);
                        setSwitchState('podcast-toggle-player-profile', data.showPlayerProfile);
                        setSwitchState('podcast-toggle-questions', data.showQuestions);
                        setSwitchState('podcast-toggle-news', data.showNews);
                    } else {
                        podcastVisibilityDocRef.set({
                            showFixtures: false, showNextFixtures: false, showPrediction: false,
                            showPlayerStats: false, showMatchStats: false, showPlayerProfile: false,
                            showQuestions: false, showNews: false,
                        });
                    }
                });
                
                getFixturesForYear();
                fetchApiStatus();
                setInterval(fetchApiStatus, 300000); 
            }
        });
    </script>
</body>
</html>