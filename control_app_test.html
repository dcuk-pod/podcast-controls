<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurable Control App</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    <script src="config.js"></script>
    <style>
        /* --- Global & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');

        body { font-family: 'Poppins', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; box-sizing: border-box; }
        .tab-nav { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .tab-nav-button { padding: 15px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 18px; font-weight: 700; color: #888; border-bottom: 4px solid transparent; transition: color 0.3s ease, border-color 0.3s ease; }
        .tab-nav-button.active { color: #3498db; border-bottom-color: #3498db; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .control-panel-wrapper { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; }
        .panel-header h1 { margin: 0; font-size: 24px; }
        .api-status-bar { background-color: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; font-size: 14px; }
        .api-status-bar .session-calls { text-align: left; }
        .api-status-bar .daily-calls { text-align: right; }
        .api-status-bar span { font-weight: bold; }
        .polling-controls-wrapper { display: flex; justify-content: center; align-items: center; gap: 10px; }
        .data-fetch-section { padding: 15px; display: grid; align-items: center; gap: 15px; }
        .data-fetch-section label { font-weight: bold; }
        .data-fetch-section select, .data-fetch-section button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; width: 100%; }
        .full-width { grid-column: 1 / -1; }
        #sb-status-text, #pc-status-text { margin-top: 10px; color: #555; font-style: italic; }
        .control-grid, .pc-control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .control-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { margin-top: 0; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .button-row { display: flex; gap: 10px; }
        .button-row button { flex-grow: 1; }
        button { padding: 8px 15px; border: none; background-color: #3498db; color: white; border-radius: 5px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .switch-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 5px 0; }
        .switch-container span { font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(26px); }
        .refresh-container { display: flex; justify-content: space-between; align-items: center; background-color: #2ecc71; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; margin-bottom: 10px; }
        .refresh-container:hover { background-color: #27ae60; }
        .refresh-icon { width: 20px; height: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
        button.remove-btn { background-color: #e74c3c; }
        button.remove-btn:hover { background-color: #c0392b; }
        .dynamic-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .dynamic-form input, .dynamic-form select, .dynamic-form textarea { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; font-family: 'Poppins', sans-serif; }
        .dynamic-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        .dynamic-item { display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; padding: 10px; border-radius: 5px; }
        .score-controls { display: flex; flex-direction: column; gap: 15px; }
        .team-control { display: flex; justify-content: space-between; align-items: center; }
        .team-info { display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .team-logo-small { width: 30px; height: 30px; object-fit: contain; }
        .score-buttons { display: flex; align-items: center; gap: 10px; }
        .score-display { font-size: 20px; font-weight: 700; min-width: 30px; text-align: center; }
        .game-clock-wrapper { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; }
        .clock-inputs { display: flex; align-items: center; gap: 5px; font-size: 20px; font-weight: bold; }
        .clock-inputs input { font-size: 18px; width: 70px; }
        .clock-actions { display: flex; gap: 10px; width: 100%; }
        .period-controls { display: flex; flex-direction: column; gap: 10px; }
        .period-row { display: flex; gap: 10px; width: 100%; }
        .event-controls, .player-profile-controls, .player-profile-season-controls { display: flex; flex-direction: column; align-items: stretch; gap: 10px; }
        .event-controls > div, .player-profile-controls > div, .player-profile-season-controls > div { display: flex; gap: 10px; width: 100%;}
        .event-controls select, .player-profile-controls select, .player-profile-season-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; flex-grow: 1; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <svg width="0" height="0" style="position:absolute">
        <symbol id="refresh-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" />
        </symbol>
    </svg>

    <div class="control-panel-wrapper">
        <nav class="tab-nav">
            <button class="tab-nav-button active" data-tab="scoreboard">Scoreboard (Watchalong)</button>
            <button class="tab-nav-button" data-tab="podcast">Podcast</button>
        </nav>

        <div id="scoreboard-tab" class="tab-content active">
            <header class="panel-header"><h1>Scoreboard Control Panel</h1></header>
            <div class="api-status-bar">
                 <div class="session-calls">Session API Calls: <span id="sb-session-api-calls">0</span></div>
                <div class="polling-controls-wrapper">
                    <span>Live Polling</span>
                    <label class="switch"><input type="checkbox" id="sb-polling-toggle"><span class="slider"></span></label>
                </div>
                <div class="daily-calls">Daily API Calls: <span id="daily-api-calls">Loading...</span></div>
            </div>
            
            <div class="control-grid">
                <div class="control-card">
                    <h2 class="card-title">Configuration</h2>
                    <div class="data-fetch-section" style="grid-template-columns: auto 1fr; padding-top: 0;">
                        <label for="sb-league-select">League:</label>
                        <select id="sb-league-select"><option>Loading Leagues...</option></select>
                        <label for="sb-season-select">Season:</label>
                        <select id="sb-season-select"><option>Select a league first...</option></select>
                        <label for="sb-team-select">Team:</label>
                        <select id="sb-team-select"><option>Select a league and season...</option></select>
                        <button id="sb-get-fixtures-btn" class="full-width" style="margin-top: 10px;">Get Fixtures for Team</button>
                        <label for="sb-fixture-select">Fixture:</label>
                        <select id="sb-fixture-select"><option>Get fixtures first...</option></select>
                        <p id="sb-status-text" class="full-width">Please select a league, season, and team.</p>
                    </div>
                </div>
                </div>
        </div>

        <div id="podcast-tab" class="tab-content">
            </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // All shared setup, Firebase refs, and tab switching logic are unchanged...
            // ...

            // ==========================================================================================
            // --- SCOREBOARD PANEL LOGIC ---
            // ==========================================================================================
            {
                let sb_sessionApiCallCount = 0;
                let allLeaguesData = [];
                // ... other scoreboard state variables ...

                // Element References
                const leagueSelect = document.getElementById('sb-league-select');
                const seasonSelect = document.getElementById('sb-season-select');
                const teamSelect = document.getElementById('sb-team-select');
                const getFixturesBtn = document.getElementById('sb-get-fixtures-btn');
                const fixtureSelect = document.getElementById('sb-fixture-select');
                const statusText = document.getElementById('sb-status-text');
                const sessionApiCallsSpan = document.getElementById('sb-session-api-calls');
                // ... other element references ...

                function sb_updateSessionCallCount() {
                    sessionApiCallsSpan.textContent = sb_sessionApiCallCount;
                }

                // REASON: This function is now restored to fetch ALL leagues from the API.
                // This requires an API plan that supports the /leagues endpoint.
                async function fetchAllLeagues() {
                    statusText.textContent = "Fetching all available leagues from API...";
                    try {
                        const response = await fetch(`${API_BASE_URL}/leagues`, {
                            headers: {
                                'x-rapidapi-key': apiKey,
                                'x-rapidapi-host': 'v3.football.api-sports.io'
                            }
                        });
                        sb_sessionApiCallCount++; 
                        sb_updateSessionCallCount();

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        allLeaguesData = data.response; 

                        leagueSelect.innerHTML = '<option value="">-- Select a League --</option>';
                        allLeaguesData.forEach(item => {
                            if (!item.league.name || !item.country.name) return; // Skip items with null names
                            const option = document.createElement('option');
                            option.value = item.league.id;
                            option.textContent = `${item.country.name} - ${item.league.name}`;
                            leagueSelect.appendChild(option);
                        });
                        statusText.textContent = "Please select a league to begin.";
                    } catch (err) {
                        statusText.textContent = `Error fetching leagues: ${err.message}. Your API plan may not support this endpoint.`;
                        console.error(err);
                    }
                }

                async function handleLeagueOrSeasonChange() {
                    const leagueId = leagueSelect.value;
                    if (!leagueId) return;

                    const selectedLeague = allLeaguesData.find(l => l.league.id == leagueId);
                    if (leagueSelect.lastChanged && selectedLeague) {
                        seasonSelect.innerHTML = '';
                        // The API provides the seasons, so we use that data
                        selectedLeague.seasons.reverse().forEach(season => {
                            const option = document.createElement('option');
                            option.value = season.year;
                            option.textContent = season.year;
                            seasonSelect.appendChild(option);
                        });
                    }
                    
                    const currentSeason = seasonSelect.value;
                    teamSelect.innerHTML = '<option>Loading Teams...</option>';
                    statusText.textContent = `Fetching teams for season ${currentSeason}...`;
                    try {
                        const response = await fetch(`${API_BASE_URL}/teams?league=${leagueId}&season=${currentSeason}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                        sb_sessionApiCallCount++; sb_updateSessionCallCount();
                        const data = await response.json();
                        teamSelect.innerHTML = '<option value="">-- Select a Team --</option>';
                        data.response.forEach(item => {
                            const option = document.createElement('option');
                            option.value = item.team.id;
                            option.textContent = item.team.name;
                            teamSelect.appendChild(option);
                        });
                        statusText.textContent = "Please select a team.";
                    } catch (err) {
                        statusText.textContent = "Error fetching teams."; console.error(err);
                    }
                }

                async function sb_getFixturesForSelectedTeam() {
                    const teamId = teamSelect.value;
                    const seasonYear = seasonSelect.value;
                    const leagueId = leagueSelect.value;
                    if (!teamId || !seasonYear || !leagueId) {
                        statusText.textContent = "Please select a league, season, and team first.";
                        return;
                    }
                    statusText.textContent = `Fetching fixtures for ${seasonYear}...`;
                    try {
                        const response = await fetch(`${API_BASE_URL}/fixtures?league=${leagueId}&season=${seasonYear}&team=${teamId}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                        sb_sessionApiCallCount++; sb_updateSessionCallCount();
                        const data = await response.json();
                        if (!data.response || data.response.length === 0) throw new Error(`No fixtures found.`);
                        sb_populateFixtureSelect(data.response);
                        statusText.textContent = "Fixtures loaded. Select one from the dropdown to load its data.";
                    } catch (err) {
                        console.error("Error getting fixtures:", err);
                        statusText.textContent = `Error: ${err.message}`;
                    }
                }

                function sb_populateFixtureSelect(fixtures) {
                    fixtureSelect.innerHTML = '<option value="">-- Select a Fixture to Load --</option>';
                    fixtures.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.fixture.id;
                        option.textContent = `${f.teams.home.name} vs ${f.teams.away.name} (${new Date(f.fixture.date).toLocaleDateString()})`;
                        fixtureSelect.appendChild(option);
                    });
                }
                
                async function sb_loadLineupData(fixtureId) {
                    // This function remains the same, fetching all detailed data for the selected fixture.
                    // ...
                }


                // --- Event Listeners ---
                leagueSelect.addEventListener('change', () => {
                    leagueSelect.lastChanged = true;
                    handleLeagueOrSeasonChange();
                });
                seasonSelect.addEventListener('change', () => {
                    leagueSelect.lastChanged = false;
                    handleLeagueOrSeasonChange();
                });
                getFixturesBtn.addEventListener('click', sb_getFixturesForSelectedTeam);
                fixtureSelect.addEventListener('change', () => sb_loadLineupData(fixtureSelect.value));
                // ... other scoreboard event listeners ...

                // --- Initial Call ---
                fetchAllLeagues();
            }

            // ==========================================================================================
            // --- PODCAST PANEL LOGIC ---
            // ==========================================================================================
            {
                // The entire podcast panel logic remains here, unchanged.
            }
        });
    </script>
</body>
</html>