<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Combined Control App</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script src="firebase-init.js"></script>
    <script src="config.js"></script>
    <style>
        /* --- Global & Fonts --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        
        /* --- Tab Navigation Styles --- */
        .tab-nav { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .tab-nav-button { padding: 15px 25px; cursor: pointer; border: none; background-color: transparent; font-size: 18px; font-weight: 700; color: #888; border-bottom: 4px solid transparent; transition: color 0.3s ease, border-color 0.3s ease; }
        .tab-nav-button.active { color: #3498db; border-bottom-color: #3498db; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .control-panel-wrapper { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 20px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e0e0e0; padding-bottom: 15px; margin-bottom: 20px; }
        .panel-header h1 { margin: 0; font-size: 24px; }
        
        .api-status-bar { background-color: #e9ecef; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; font-size: 14px; }
        .api-status-bar .session-calls { text-align: left; }
        .api-status-bar .daily-calls { text-align: right; }
        .api-status-bar span { font-weight: bold; }
        .polling-controls-wrapper { display: flex; justify-content: center; align-items: center; gap: 10px; }
        
        .fixture-container { background-color: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px; overflow: hidden; }
        .fixture-header { padding: 15px; cursor: pointer; font-weight: bold; font-size: 18px; display: flex; justify-content: space-between; align-items: center; user-select: none; }
        .fixture-header::after { content: 'â–²'; transition: transform 0.3s ease; }
        .fixture-container.collapsed .fixture-header::after { transform: rotate(180deg); }
        .data-fetch-section { padding: 15px; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 15px; max-height: 500px; transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out; }
        .fixture-container.collapsed .data-fetch-section { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; }

        .data-fetch-section label { font-weight: bold; }
        .data-fetch-section select, .data-fetch-section button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; width: 100%; }
        .full-width { grid-column: 1 / -1; }
        #sb-status-text, #pc-status-text { margin-top: 10px; color: #555; font-style: italic; }

        .control-grid, .pc-control-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; }
        .control-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; }
        .card-title { margin-top: 0; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        .score-controls { display: flex; flex-direction: column; gap: 15px; }
        .team-control { display: flex; justify-content: space-between; align-items: center; }
        .team-info { display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .team-logo-small { width: 30px; height: 30px; object-fit: contain; }
        .score-buttons { display: flex; align-items: center; gap: 10px; }
        .score-display { font-size: 20px; font-weight: 700; min-width: 30px; text-align: center; }
        
        .game-clock-wrapper { display: flex; flex-direction: column; align-items: center; gap: 10px; margin-bottom: 15px; }
        .clock-inputs { display: flex; align-items: center; gap: 5px; font-size: 20px; font-weight: bold; }
        .clock-inputs input { font-size: 18px; width: 70px; }
        .clock-actions { display: flex; gap: 10px; width: 100%; }
        .clock-actions button { flex-grow: 1; }
        .period-controls { display: flex; flex-direction: column; gap: 10px; }
        .period-row { display: flex; gap: 10px; width: 100%; }
        .period-row button { flex-grow: 1; }
        .stoppage-time-controls { display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap; margin-top: 15px; }
        .stoppage-time-controls input { width: 120px; }
        
        .event-controls, .player-profile-controls, .player-profile-season-controls { display: flex; flex-direction: column; align-items: stretch; gap: 10px; }
        .event-controls > div { display: flex; gap: 10px; width: 100%;}
        .event-controls select, .player-profile-controls select, .player-profile-season-controls select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; flex-grow: 1; }
        .event-controls button { margin-top: 10px; }
        .hidden { display: none !important; }
        .sub-select { width: 50%; }
        .button-row { display: flex; gap: 10px; }
        .button-row button { flex-grow: 1; margin-top: 0 !important; }
        button { padding: 8px 15px; border: none; background-color: #3498db; color: white; border-radius: 5px; cursor: pointer; font-weight: 700; transition: background-color 0.2s; }
        button:hover { background-color: #2980b9; }
        input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; text-align: center; font-size: 16px; }

        .switch-container { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding: 5px 0; }
        .switch-container span { font-weight: 600; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2ecc71; }
        input:checked + .slider:before { transform: translateX(26px); }

        .refresh-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2ecc71;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        }
        .refresh-container:hover { background-color: #27ae60; }
        .refresh-icon { width: 20px; height: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }

        /* Podcast Specific Styles */
        button.remove-btn { background-color: #e74c3c; }
        button.remove-btn:hover { background-color: #c0392b; }
        .dynamic-form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .dynamic-form input, .dynamic-form select, .dynamic-form textarea { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; font-family: 'Poppins', sans-serif; }
        .dynamic-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        .dynamic-item { display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; padding: 10px; border-radius: 5px; }
        .dynamic-text { flex-grow: 1; font-size: 14px; word-break: break-all; }
        .dynamic-text strong { color: #555; }
        .dynamic-actions { display: flex; gap: 5px; }
        .dynamic-actions button { padding: 5px 10px; font-size: 12px; }

    </style>
</head>
<body>
    <svg width="0" height="0" style="position:absolute">
        <symbol id="refresh-icon" viewBox="0 0 24 24">
            <path fill="currentColor" d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" />
        </symbol>
    </svg>

    <div class="control-panel-wrapper">
        <nav class="tab-nav">
            <button class="tab-nav-button active" data-tab="scoreboard">Scoreboard (Watchalong)</button>
            <button class="tab-nav-button" data-tab="podcast">Podcast</button>
        </nav>

        <div id="scoreboard-tab" class="tab-content active">
            <header class="panel-header"><h1>Scoreboard Control Panel</h1></header>
            <div class="api-status-bar">
                <div class="session-calls">Session API Calls: <span id="sb-session-api-calls">0</span></div>
                <div class="polling-controls-wrapper">
                    <span>Live Polling</span>
                    <label class="switch"><input type="checkbox" id="sb-polling-toggle"><span class="slider"></span></label>
                </div>
                <div class="daily-calls">Daily API Calls: <span id="daily-api-calls">Loading...</span></div>
            </div>
            <div class="fixture-container">
                <div class="fixture-header" id="sb-fixture-header">Fixture Selection</div>
                <div class="data-fetch-section">
                    <label for="sb-year-select">Season:</label>
                    <select id="sb-year-select"><option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option></select>
                    <button id="sb-get-fixtures-btn">Get Fixtures</button>
                    <label for="sb-fixture-select">Fixture:</label>
                    <select id="sb-fixture-select"><option>Select a year first...</option></select>
                    <button id="sb-load-fixture-btn">Load Selected Fixture</button>
                    <p id="sb-status-text" class="full-width">Select a season and click "Get Fixtures" to begin.</p>
                </div>
            </div>
            <div class="control-grid">
                <div class="control-card">
                    <h2 class="card-title">Scoreboard</h2>
                    <div class="switch-container">
                        <span>Show Visual</span>
                        <label class="switch"><input type="checkbox" id="sb-toggle-scoreboard"><span class="slider"></span></label>
                    </div>
                </div>
                <div class="control-card">
                     <h2 class="card-title">Score</h2>
                    <div class="score-controls">
                        <div class="team-control">
                            <div class="team-info"><img id="home-logo-control" src="https://placehold.co/30x30/eee/ccc?text=H" class="team-logo-small"><span id="home-name-control">HOME</span></div>
                            <div class="score-buttons"><button id="home-score-down">-</button><span id="home-score-display" class="score-display">0</span><button id="home-score-up">+</button></div>
                        </div>
                        <div class="team-control">
                            <div class="team-info"><img id="away-logo-control" src="https://placehold.co/30x30/eee/ccc?text=A" class="team-logo-small"><span id="away-name-control">AWAY</span></div>
                            <div class="score-buttons"><button id="away-score-down">-</button><span id="away-score-display" class="score-display">0</span><button id="away-score-up">+</button></div>
                        </div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Game Clock & Period</h2>
                    <div class="game-clock-wrapper">
                        <div class="clock-inputs"><input type="number" id="minutes-input" value="0" min="0"><span>:</span><input type="number" id="seconds-input" value="0" min="0" max="59"></div>
                        <div class="clock-actions"><button id="set-time-btn">Set</button><button id="play-pause-btn">Play</button><button id="reset-time-btn">Reset</button></div>
                    </div>
                    <div class="period-controls">
                        <div class="period-row"><button class="period-btn" data-period="1H" data-time="0">1H</button><button class="period-btn" data-period="HT" data-time="45">HT</button><button class="period-btn" data-period="2H" data-time="45">2H</button><button class="period-btn" data-period="FT" data-time="90">FT</button></div>
                        <div class="period-row"><button class="period-btn" data-period="ET1" data-time="90">ET1</button><button class="period-btn" data-period="ET2" data-time="105">ET2</button><button class="period-btn" data-period="PENS" data-time="120">PENS</button></div>
                    </div>
                     <div class="stoppage-time-controls"><input type="number" id="stoppage-input" placeholder="+ Mins" min="0"><button id="show-stoppage-btn">Show</button><button id="hide-stoppage-btn">Hide</button></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Broadcast Events</h2>
                    <div class="event-controls">
                        <select id="event-type-select"><option value="goal">Goal</option><option value="yellow">Yellow Card</option><option value="red">Red Card</option><option value="sub">Substitution</option><option value="var_goal">VAR: Goal Check</option><option value="var_no_goal">VAR: No Goal Check</option><option value="var_penalty">VAR: Penalty Check</option><option value="var_red">VAR: Red Card Check</option><option value="var_identity">VAR: Mistaken Identity</option></select>
                        <div id="single-player-section"><label for="event-player-select">Player:</label><select id="event-player-select"><option value="">(Load data first)</option></select></div>
                        <div id="sub-player-section" class="hidden"><select id="player-off-select" class="sub-select"><option value="">Player Off...</option></select><select id="player-on-select" class="sub-select"><option value="">Player On...</option></select></div>
                        <div id="var-team-section" class="hidden"><label for="var-team-select">Team:</label><select id="var-team-select"></select></div>
                        <button id="trigger-event-btn">Trigger Event</button>
                    </div>
                </div>
                 <div class="control-card">
                    <h2 class="card-title">Player Profile - Match</h2>
                    <div class="player-profile-controls">
                        <label for="player-profile-select">Player:</label>
                        <select id="player-profile-select"><option value="">(Load fixture first)</option></select>
                        <div class="button-row" style="margin-bottom: 10px;"><button id="show-player-btn">Refresh & Show Player</button></div>
                    </div>
                    <div class="switch-container"><label class="switch"><input type="checkbox" id="sb-toggle-player-profile"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Player Stats</h2>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="sb-toggle-player-stats"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Combined Lineup</h2>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="sb-toggle-lineup"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Match Stats</h2>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="sb-toggle-match-stats"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Scroller</h2>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="sb-toggle-scroller"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Match Events Ticker</h2>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="sb-toggle-match-events"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">League Events Ticker</h2>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="sb-toggle-league-events"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Player Profile - Season</h2>
                    <div class="player-profile-season-controls">
                        <label for="player-profile-season-select">Player:</label>
                        <select id="player-profile-season-select"><option value="">(Load fixture first)</option></select>
                        <div class="button-row"><button id="load-player-season-btn">Load Data</button><button id="show-player-season-btn">Show Player</button></div>
                    </div>
                    <div class="switch-container"><label class="switch"><input type="checkbox" id="sb-toggle-player-season"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Prediction Graphic</h2>
                    <div class="button-row" style="margin-bottom: 10px;"><button id="load-prediction-btn">Load Data</button></div>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="sb-toggle-prediction"><span class="slider"></span></label></div>
                </div>
            </div>
        </div>

        <div id="podcast-tab" class="tab-content">
            <header class="panel-header"><h1>Podcast Visuals Control Panel</h1></header>
            <div class="api-status-bar">
                <div class="session-calls">Session API Calls: <span id="pc-session-api-calls">0</span></div>
                <div></div>
                <div class="daily-calls">Daily API Calls: <span id="pc-daily-api-calls">Loading...</span></div>
            </div>
            <div class="fixture-container">
                <div class="fixture-header" id="pc-fixture-header">Fixture Selection</div>
                <div class="data-fetch-section">
                    <label for="pc-year-select">Season:</label>
                    <select id="pc-year-select"><option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option><option value="2022">2022</option></select>
                    <button id="pc-get-fixtures-btn">Get Fixtures</button>
                    <label for="pc-fixture-select">Fixture:</label>
                    <select id="pc-fixture-select"><option>Select a year first...</option></select>
                    <button id="pc-load-fixture-btn">Load Selected Fixture</button>
                    <p id="pc-status-text" class="full-width">Select a season and click "Get Fixtures" to begin.</p>
                </div>
            </div>
            <div class="pc-control-grid">
                <div class="control-card">
                    <h2 class="card-title">Fixtures</h2>
                    <div>
                        <div id="pc-refresh-fixtures-btn" class="refresh-container">
                            <span>Refresh Data</span>
                            <svg class="refresh-icon"><use href="#refresh-icon"></use></svg>
                        </div>
                        <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-fixtures"><span class="slider"></span></label></div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Next Fixtures</h2>
                    <div>
                        <div id="pc-refresh-next-fixtures-btn" class="refresh-container"><span>Refresh Data</span><svg class="refresh-icon"><use href="#refresh-icon"></use></svg></div>
                        <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-next-fixtures"><span class="slider"></span></label></div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Prediction</h2>
                    <div>
                        <div id="pc-refresh-prediction-btn" class="refresh-container"><span>Refresh Data</span><svg class="refresh-icon"><use href="#refresh-icon"></use></svg></div>
                        <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-prediction"><span class="slider"></span></label></div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Player Stats</h2>
                    <div>
                        <div id="pc-refresh-player-stats-btn" class="refresh-container"><span>Refresh Data</span><svg class="refresh-icon"><use href="#refresh-icon"></use></svg></div>
                        <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-player-stats"><span class="slider"></span></label></div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Match Stats</h2>
                    <div>
                        <div id="pc-refresh-match-stats-btn" class="refresh-container"><span>Refresh Data</span><svg class="refresh-icon"><use href="#refresh-icon"></use></svg></div>
                        <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-match-stats"><span class="slider"></span></label></div>
                    </div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Player Profile</h2>
                     <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-player-profile"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">Podcast Questions</h2>
                    <div class="dynamic-form"><input type="text" id="question-text-input" placeholder="Enter question..."><input type="text" id="question-name-input" placeholder="Enter name..."><select id="question-source-select"><option value="twitter">Twitter</option><option value="facebook">Facebook</option><option value="instagram">Instagram</option><option value="discord">Discord</option><option value="reddit">Reddit</option><option value="other">Other</option></select><button id="add-question-btn">Add Question</button></div>
                    <div class="dynamic-list" id="questions-list-container"></div>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-questions"><span class="slider"></span></label></div>
                </div>
                <div class="control-card">
                    <h2 class="card-title">News</h2>
                    <div class="dynamic-form"><input type="text" id="headline-title-input" placeholder="Enter headline..."><textarea id="headline-desc-input" placeholder="Enter description..." rows="3"></textarea><input type="text" id="headline-image-input" placeholder="Enter image filename (e.g., news.png)"><button id="add-headline-btn">Add Headline</button></div>
                    <div class="dynamic-list" id="headlines-list-container"></div>
                    <div class="switch-container"><span>Show Visual</span><label class="switch"><input type="checkbox" id="pc-toggle-news"><span class="slider"></span></label></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.querySelectorAll('.tab-nav-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(item => item.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });

            // --- Shared Constants & Variables ---
            const TEAM_ID = 1615;
            const MLS_LEAGUE_ID = 253;
            let sb_sessionApiCallCount = 0;
            let pc_sessionApiCallCount = 0;

            // --- Shared Firebase Document References ---
            const scoreboardDocRef = db.collection('scoreboard').doc('liveState');
            const scoreboardVisibilityDocRef = db.collection('scoreboard').doc('visibility');
            const sb_fixtureDocRef = db.collection('scoreboard').doc('currentFixture');
            const playerProfileDocRef = db.collection('scoreboard').doc('playerProfile');
            const playerStatsDocRef = db.collection('scoreboard').doc('playerStats');
            const playerStatsDataDocRef = db.collection('scoreboard').doc('playerStatsData');
            const combinedLineupDocRef = db.collection('scoreboard').doc('combinedLineup');
            const combinedLineupDataDocRef = db.collection('scoreboard').doc('combinedLineupData');
            const matchStatsDocRef = db.collection('scoreboard').doc('matchStats');
            const matchStatsDataDocRef = db.collection('scoreboard').doc('matchStatsData');
            const scrollerDocRef = db.collection('scoreboard').doc('scroller');
            const scrollerDataDocRef = db.collection('scoreboard').doc('scrollerData');
            const matchEventsDocRef = db.collection('scoreboard').doc('matchEvents');
            const matchEventsDataDocRef = db.collection('scoreboard').doc('matchEventsData');
            const leagueEventsDocRef = db.collection('scoreboard').doc('leagueEvents');
            const leagueEventsDataDocRef = db.collection('scoreboard').doc('leagueEventsData');
            const playerProfileSeasonDocRef = db.collection('scoreboard').doc('playerProfileSeason');
            const predictionVisibilityDocRef = db.collection('scoreboard').doc('predictionVisibility');
            const predictionDataDocRef = db.collection('scoreboard').doc('predictionData');
            const podcastVisibilityDocRef = db.collection('podcast').doc('visibility');
            const podcastFixtureDocRef = db.collection('podcast').doc('currentFixture');
            const podcastFixturesDataDocRef = db.collection('podcast').doc('fixturesData');
            const podcastNextFixturesDataDocRef = db.collection('podcast').doc('nextFixturesData');
            const podcastPredictionDataDocRef = db.collection('podcast').doc('predictionData');
            const podcastPlayerStatsDataDocRef = db.collection('podcast').doc('playerStatsData');
            const podcastMatchStatsDataDocRef = db.collection('podcast').doc('matchStatsData');
            const podcastQuestionsCollectionRef = db.collection('podcastQuestions');
            const podcastCurrentQuestionDocRef = db.collection('podcast').doc('currentQuestion');
            const podcastHeadlinesCollectionRef = db.collection('podcastHeadlines');
            const podcastCurrentHeadlineDocRef = db.collection('podcast').doc('currentHeadline');

            const dailyApiCallsSpan = document.getElementById('daily-api-calls');
            const pc_dailyApiCallsSpan = document.getElementById('pc-daily-api-calls');
            
            async function fetchApiStatus() {
                try {
                    const response = await fetch(`${API_BASE_URL}/status`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                    const data = await response.json();
                    if (data.response && data.response.requests) {
                        const statusString = `${data.response.requests.current} / ${data.response.requests.limit_day}`;
                        dailyApiCallsSpan.textContent = statusString;
                        pc_dailyApiCallsSpan.textContent = statusString;
                    }
                    sb_updateSessionCallCount();
                    pc_updateSessionCallCount();
                } catch (err) {
                    console.error("Error fetching API status:", err);
                    dailyApiCallsSpan.textContent = 'Error';
                    pc_dailyApiCallsSpan.textContent = 'Error';
                }
            }

            // ==========================================================================================
            // --- SCOREBOARD PANEL LOGIC ---
            // ==========================================================================================
            {
                let gameState = {}; let timerInterval = null; let currentFixture = null; let fixturePlayerStats = []; let currentLineups = []; let statsPollingInterval = null; let loadedSeasonPlayerData = null;
                const statusText = document.getElementById('sb-status-text');
                const homeScoreDisplay = document.getElementById('home-score-display'); const awayScoreDisplay = document.getElementById('away-score-display'); const minutesInput = document.getElementById('minutes-input'); const secondsInput = document.getElementById('seconds-input'); const playPauseBtn = document.getElementById('play-pause-btn'); const eventTypeSelect = document.getElementById('event-type-select'); const singlePlayerSection = document.getElementById('single-player-section'); const subPlayerSection = document.getElementById('sub-player-section'); const varTeamSection = document.getElementById('var-team-section'); const eventPlayerSelect = document.getElementById('event-player-select'); const playerOffSelect = document.getElementById('player-off-select'); const playerOnSelect = document.getElementById('player-on-select'); const varTeamSelect = document.getElementById('var-team-select'); const yearSelect = document.getElementById('sb-year-select'); const getFixturesBtn = document.getElementById('sb-get-fixtures-btn'); const fixtureSelect = document.getElementById('sb-fixture-select'); const loadFixtureBtn = document.getElementById('sb-load-fixture-btn'); const fixtureHeader = document.getElementById('sb-fixture-header'); const fixtureContainer = fixtureHeader.closest('.fixture-container'); const playerProfileSelect = document.getElementById('player-profile-select'); const showPlayerBtn = document.getElementById('show-player-btn'); const pollingToggle = document.getElementById('sb-polling-toggle'); const sessionApiCallsSpan = document.getElementById('sb-session-api-calls'); const playerProfileSeasonSelect = document.getElementById('player-profile-season-select'); const loadPlayerSeasonBtn = document.getElementById('load-player-season-btn'); const showPlayerSeasonBtn = document.getElementById('show-player-season-btn'); const loadPredictionBtn = document.getElementById('load-prediction-btn');

                fixtureHeader.addEventListener('click', () => fixtureContainer.classList.toggle('collapsed'));
                function sb_updateSessionCallCount() { sessionApiCallsSpan.textContent = sb_sessionApiCallCount; }

                const sb_addSwitchListener = (elementId, docRef, field = 'show') => {
                    const toggle = document.getElementById(elementId);
                    if (!toggle) return;
                    toggle.addEventListener('change', (e) => docRef.set({ [field]: e.target.checked }, { merge: true }));
                    
                    docRef.onSnapshot((doc) => {
                        if (doc.exists) {
                            toggle.checked = !!doc.data()[field];
                        }
                    });
                };
                
                sb_addSwitchListener('sb-toggle-scoreboard', scoreboardVisibilityDocRef);
                sb_addSwitchListener('sb-toggle-player-profile', playerProfileDocRef);
                sb_addSwitchListener('sb-toggle-player-stats', playerStatsDocRef);
                sb_addSwitchListener('sb-toggle-lineup', combinedLineupDocRef);
                sb_addSwitchListener('sb-toggle-match-stats', matchStatsDocRef);
                sb_addSwitchListener('sb-toggle-scroller', scrollerDocRef);
                sb_addSwitchListener('sb-toggle-match-events', matchEventsDocRef);
                sb_addSwitchListener('sb-toggle-league-events', leagueEventsDocRef);
                sb_addSwitchListener('sb-toggle-player-season', playerProfileSeasonDocRef);
                sb_addSwitchListener('sb-toggle-prediction', predictionVisibilityDocRef);

                async function sb_getFixturesForYear() {
                    const year = yearSelect.value;
                    statusText.textContent = `Checking for saved fixtures for ${year}...`;
                    const fixturesDocRef = db.collection('fixtures').doc(year);
                    try {
                        const doc = await fixturesDocRef.get();
                        if (doc.exists && doc.data().fixtures && doc.data().fixtures.length > 0) {
                            statusText.textContent = `Fixtures for ${year} loaded from database.`;
                            sb_populateFixtureSelect(doc.data().fixtures);
                        } else {
                            statusText.textContent = `Fetching fixtures for ${year} from API...`;
                            const response = await fetch(`${API_BASE_URL}/fixtures?season=${year}&team=${TEAM_ID}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                            sb_sessionApiCallCount++; sb_updateSessionCallCount();
                            const data = await response.json();
                            if (!data.response || data.response.length === 0) throw new Error(`No fixtures found for ${year}.`);
                            const fixtures = data.response.map(f => ({ id: f.fixture.id, name: `${f.teams.home.name} vs ${f.teams.away.name} (${new Date(f.fixture.date).toLocaleDateString()})`, competition: f.league.name }));
                            await fixturesDocRef.set({ fixtures });
                            statusText.textContent = `Fixtures for ${year} fetched and saved.`;
                            sb_populateFixtureSelect(fixtures);
                        }
                    } catch (err) { statusText.textContent = `Error: ${err.message}`; statusText.style.color = 'red'; }
                }
                
                // --- REASON: This function was empty. I have added the logic to populate the select dropdown. ---
                function sb_populateFixtureSelect(fixtures) {
                    fixtureSelect.innerHTML = ''; // Clear existing options
                    const defaultOption = document.createElement('option');
                    defaultOption.textContent = 'Select a fixture...';
                    fixtureSelect.appendChild(defaultOption);

                    // Sort fixtures by date, most recent first
                    fixtures.sort((a, b) => {
                        // Extract date from name string: "...(DD/MM/YYYY)"
                        const dateA = new Date(a.name.match(/\(([^)]+)\)/)[1].split('/').reverse().join('-'));
                        const dateB = new Date(b.name.match(/\(([^)]+)\)/)[1].split('/').reverse().join('-'));
                        return dateB - dateA;
                    });
                    
                    fixtures.forEach(fixture => {
                        const option = document.createElement('option');
                        option.value = fixture.id;
                        option.textContent = `${fixture.name} - ${fixture.competition}`;
                        fixtureSelect.appendChild(option);
                    });
                }
                
                async function sb_loadLineupData() { /* ... (unchanged) ... */ }
                function sb_startPolling(fixtureId) { /* ... (unchanged) ... */ }
                function sb_stopPolling() { /* ... (unchanged) ... */ }
                pollingToggle.addEventListener('change', () => { if (pollingToggle.checked && fixtureSelect.value) { sb_startPolling(fixtureSelect.value); } else { sb_stopPolling(); } });
                async function sb_pollStatsData(fixtureId) { /* ... (unchanged) ... */ }
                async function sb_fetchAllData(fixtureId) { /* ... (unchanged) ... */ }
                getFixturesBtn.addEventListener('click', sb_getFixturesForYear);
                loadFixtureBtn.addEventListener('click', sb_loadLineupData);
                function sb_populateControls(fixture, lineups) { /* ... (unchanged) ... */ }
                function sb_populatePlayerProfileSelectFromLineups(lineups) { /* ... (unchanged) ... */ }
                function sb_populatePlayerProfileSeasonSelect(lineups) { /* ... (unchanged) ... */ }
                function sb_saveState() { scoreboardDocRef.set(gameState).catch(error => console.error("Error writing to Firestore: ", error)); }
                function sb_updateDisplays() { homeScoreDisplay.textContent = gameState.homeScore || 0; awayScoreDisplay.textContent = gameState.awayScore || 0; minutesInput.value = gameState.minutes || 0; secondsInput.value = gameState.seconds || 0; }
                
                document.getElementById('home-score-up').addEventListener('click', () => { gameState.homeScore++; sb_saveState(); sb_updateDisplays(); });
                /* ... (All score, clock, and event button listeners are unchanged) ... */

                showPlayerBtn.addEventListener('click', async () => {
                    /* ... (The existing fetch and update logic is unchanged) ... */
                    // The last part is now to ensure the toggle is on
                    if (playerInfo && teamInfo && playerStats) {
                        await playerProfileDocRef.set({ show: true, player: playerInfo, stats: playerStats, team: teamInfo }, { merge: true });
                        statusText.textContent = `Showing profile for ${playerInfo.name}.`; statusText.style.color = '#555';
                    } else { statusText.textContent = `Could not find data for selected player.`; statusText.style.color = 'red'; }
                });

                loadPlayerSeasonBtn.addEventListener('click', async () => { /* ... (unchanged) ... */ });
                showPlayerSeasonBtn.addEventListener('click', () => {
                    /* ... (unchanged logic) ... */
                    playerProfileSeasonDocRef.set({ show: true, data: loadedSeasonPlayerData }, { merge: true });
                });
                loadPredictionBtn.addEventListener('click', async () => { /* ... (unchanged) ... */ });

                scoreboardDocRef.get().then((doc) => {
                    if (doc.exists) gameState = doc.data(); else gameState = { homeScore: 0, awayScore: 0, minutes: 0, seconds: 0, period: '1H', showStoppage: false, event: null };
                    sb_updateDisplays();
                    sb_getFixturesForYear();
                });
            }

            // ==========================================================================================
            // --- PODCAST PANEL LOGIC ---
            // ==========================================================================================
            {
                const statusText = document.getElementById('pc-status-text'); const yearSelect = document.getElementById('pc-year-select'); const getFixturesBtn = document.getElementById('pc-get-fixtures-btn'); const fixtureSelect = document.getElementById('pc-fixture-select'); const loadFixtureBtn = document.getElementById('pc-load-fixture-btn'); const sessionApiCallsSpan = document.getElementById('pc-session-api-calls'); const questionTextInput = document.getElementById('question-text-input'); const questionNameInput = document.getElementById('question-name-input'); const questionSourceSelect = document.getElementById('question-source-select'); const addQuestionBtn = document.getElementById('add-question-btn'); const questionsListContainer = document.getElementById('questions-list-container'); const headlineTitleInput = document.getElementById('headline-title-input'); const headlineDescInput = document.getElementById('headline-desc-input'); const headlineImageInput = document.getElementById('headline-image-input'); const addHeadlineBtn = document.getElementById('add-headline-btn'); const headlinesListContainer = document.getElementById('headlines-list-container'); const fixtureHeader = document.getElementById('pc-fixture-header');
                
                fixtureHeader.addEventListener('click', () => fixtureHeader.closest('.fixture-container').classList.toggle('collapsed'));
                function pc_updateSessionCallCount() { sessionApiCallsSpan.textContent = pc_sessionApiCallCount; }

                async function pc_getFixturesForYear() {
                     const year = yearSelect.value;
                    statusText.textContent = `Checking for saved fixtures for ${year}...`;
                    const fixturesDocRef = db.collection('fixtures').doc(year);
                    try {
                        const doc = await fixturesDocRef.get();
                        if (doc.exists && doc.data().fixtures && doc.data().fixtures.length > 0) {
                            statusText.textContent = `Fixtures for ${year} loaded from database.`;
                            pc_populateFixtureSelect(doc.data().fixtures);
                        } else {
                            statusText.textContent = `Fetching fixtures for ${year} from API...`;
                            const response = await fetch(`${API_BASE_URL}/fixtures?season=${year}&team=${TEAM_ID}`, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                            pc_sessionApiCallCount++; pc_updateSessionCallCount();
                            const data = await response.json();
                            if (!data.response || data.response.length === 0) throw new Error(`No fixtures found for ${year}.`);
                            const fixtures = data.response.map(f => ({ id: f.fixture.id, name: `${f.teams.home.name} vs ${f.teams.away.name} (${new Date(f.fixture.date).toLocaleDateString()})`, competition: f.league.name }));
                            await fixturesDocRef.set({ fixtures });
                            statusText.textContent = `Fixtures for ${year} fetched and saved.`;
                            pc_populateFixtureSelect(fixtures);
                        }
                    } catch (err) { statusText.textContent = `Error: ${err.message}`; statusText.style.color = 'red'; }
                }
                
                // --- REASON: This function was also empty. Added the same logic as the scoreboard version. ---
                function pc_populateFixtureSelect(fixtures) {
                    fixtureSelect.innerHTML = ''; // Clear existing options
                    const defaultOption = document.createElement('option');
                    defaultOption.textContent = 'Select a fixture...';
                    fixtureSelect.appendChild(defaultOption);

                     // Sort fixtures by date, most recent first
                    fixtures.sort((a, b) => {
                        const dateA = new Date(a.name.match(/\(([^)]+)\)/)[1].split('/').reverse().join('-'));
                        const dateB = new Date(b.name.match(/\(([^)]+)\)/)[1].split('/').reverse().join('-'));
                        return dateB - dateA;
                    });
                    
                    fixtures.forEach(fixture => {
                        const option = document.createElement('option');
                        option.value = fixture.id;
                        option.textContent = `${fixture.name} - ${fixture.competition}`;
                        fixtureSelect.appendChild(option);
                    });
                }
                
                async function pc_loadFixtureData() { /* ... (unchanged) ... */ }

                async function pc_refreshGenericData(endpoint, docRef, dataKey, successMessage, errorMessage, btnElement) {
                    const icon = btnElement ? btnElement.querySelector('.refresh-icon') : null;
                    if (icon) icon.classList.add('spinning');

                    const fixtureId = fixtureSelect.value;
                    if (endpoint.includes('fixture') && !fixtureId && !endpoint.includes('next')) {
                         statusText.textContent = "Error: Please select a valid fixture first."; statusText.style.color = 'red';
                         if (icon) icon.classList.remove('spinning');
                         return;
                    }
                    const url = `${API_BASE_URL}/${endpoint}`;
                    statusText.textContent = `Fetching ${successMessage}...`; statusText.style.color = '#555';
                    try {
                        const response = await fetch(url, { headers: { 'x-rapidapi-key': apiKey, 'x-rapidapi-host': 'v3.football.api-sports.io' } });
                        pc_sessionApiCallCount++; fetchApiStatus();
                        const data = await response.json();
                        if (!data.response || data.response.length === 0) throw new Error(`No ${errorMessage} found.`);
                        const payload = endpoint.includes('prediction') ? data.response[0] : data.response;
                        await docRef.set({ [dataKey]: payload, lastUpdated: new Date().toISOString() });
                        statusText.textContent = `${successMessage} refreshed and saved.`; statusText.style.color = 'green';
                    } catch (err) { statusText.textContent = `Error: ${err.message}`; statusText.style.color = 'red'; }
                    finally {
                        if (icon) icon.classList.remove('spinning');
                    }
                }
                
                getFixturesBtn.addEventListener('click', pc_getFixturesForYear);
                loadFixtureBtn.addEventListener('click', pc_loadFixtureData);
                
                document.getElementById('pc-refresh-fixtures-btn').addEventListener('click', (e) => pc_refreshGenericData(`fixtures?season=${yearSelect.value}&team=${TEAM_ID}`, podcastFixturesDataDocRef, 'fixtures', 'Fixtures', 'fixtures', e.currentTarget));
                document.getElementById('pc-refresh-next-fixtures-btn').addEventListener('click', (e) => pc_refreshGenericData(`fixtures?team=${TEAM_ID}&next=5`, podcastNextFixturesDataDocRef, 'fixtures', 'Next fixtures', 'next fixtures', e.currentTarget));
                document.getElementById('pc-refresh-prediction-btn').addEventListener('click', (e) => pc_refreshGenericData(`predictions?fixture=${fixtureSelect.value}`, podcastPredictionDataDocRef, 'prediction', 'Prediction data', 'prediction data', e.currentTarget));
                document.getElementById('pc-refresh-player-stats-btn').addEventListener('click', (e) => pc_refreshGenericData(`fixtures/players?fixture=${fixtureSelect.value}`, podcastPlayerStatsDataDocRef, 'stats', 'Player stats', 'player stats', e.currentTarget));
                document.getElementById('pc-refresh-match-stats-btn').addEventListener('click', (e) => pc_refreshGenericData(`fixtures/statistics?fixture=${fixtureSelect.value}`, podcastMatchStatsDataDocRef, 'stats', 'Match stats', 'match stats', e.currentTarget));

                addQuestionBtn.addEventListener('click', () => { /* ... (unchanged) ... */ });
                podcastQuestionsCollectionRef.orderBy("createdAt", "desc").onSnapshot(snapshot => { /* ... (unchanged) ... */ });
                addHeadlineBtn.addEventListener('click', () => { /* ... (unchanged) ... */ });
                podcastHeadlinesCollectionRef.orderBy("createdAt", "desc").onSnapshot(snapshot => { /* ... (unchanged) ... */ });

                const addSwitchListener = (elementId, firestoreField, currentDocRef) => { /* ... (unchanged) ... */ };
                addSwitchListener('pc-toggle-fixtures', 'showFixtures'); addSwitchListener('pc-toggle-next-fixtures', 'showNextFixtures'); addSwitchListener('pc-toggle-prediction', 'showPrediction'); addSwitchListener('pc-toggle-player-stats', 'showPlayerStats'); addSwitchListener('pc-toggle-match-stats', 'showMatchStats'); addSwitchListener('pc-toggle-player-profile', 'showPlayerProfile'); addSwitchListener('pc-toggle-questions', 'showQuestions', podcastCurrentQuestionDocRef); addSwitchListener('pc-toggle-news', 'showNews', podcastCurrentHeadlineDocRef);
                podcastVisibilityDocRef.onSnapshot((doc) => { /* ... (unchanged) ... */ });
                pc_getFixturesForYear();
            }
            
            fetchApiStatus();
            setInterval(fetchApiStatus, 300000);
        });
    </script>
</body>
</html>