<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Match Stats</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <link rel="stylesheet" href="matchstats.css">
</head>
<body>
    <div id="stats-container">
        </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyCFDYDSsOswmf2xn8-Z6LNw4Qu-kiph2X4",
                authDomain: "scoreboard-control.firebaseapp.com",
                projectId: "scoreboard-control",
                storageBucket: "scoreboard-control.appspot.com",
                messagingSenderId: "438021450087",
                appId: "1:438021450087:web:cb4eb72e0858b4b2f627c2"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            const assetsBaseUrl = 'https://dcuk-pod.github.io/podcast-controls/';

            // COMMENT: Team colors remain essential for styling the bars and chart.
            const TEAM_COLORS = {
              1595: 'rgb(85, 150, 71)', 1596: 'rgb(0, 102, 175)', 1597: 'rgb(222, 53, 56)', 1598: 'rgb(101, 44, 144)', 1599: 'rgb(181, 152, 90)', 1600: 'rgb(245, 128, 44)', 1601: 'rgb(222, 53, 56)', 1602: 'rgb(217, 39, 46)', 1603: 'rgb(15, 49, 92)', 1604: 'rgb(108, 169, 223)', 1605: 'rgb(0, 40, 85)', 1606: 'rgb(205, 34, 53)', 1607: 'rgb(229, 26, 55)', 1608: 'rgb(141, 22, 44)', 1609: '#021D3D', 1610: 'rgb(149, 29, 64)', 1611: 'rgb(80, 132, 185)', 1612: 'rgb(143, 201, 232)', 1613: 'rgb(254, 222, 0)', 1614: 'rgb(0, 85, 155)', 1615: 'rgb(239, 62, 65)', 1616: 'rgb(193, 162, 92)', 1617: 'rgb(0, 70, 41)', 2242: 'rgb(241, 91, 36)', 9568: 'rgb(252, 185, 205)', 9569: 'rgb(254, 219, 0)', 16489: 'rgb(0, 182, 75)', 18310: 'rgb(91, 192, 240)', 20787: 'rgb(217, 2, 79)', 25484: 'rgb(11, 46, 75)', 70: '#E32124', 76: '#FFFFFF', 'default': 'rgba(66, 65, 65, 1)' 
            };
            const TEAM_COLORS_ALT = {
              1595: '#003C71', 1596: '#000000', 1597: '#003E7B', 1598: '#FFD100', 1599: '#0A2240', 1600: '#000000', 1601: '#231F20', 1602: '#FFC700', 1603: '#92C1E9', 1604: '#002654', 1605: '#FFD200', 1606: '#013A81', 1607: '#001E61', 1608: '#A48A5A', 1609: '#E51938', 1610: '#569FD3', 1611: '#002F65', 1612: '#58595B', 1613: '#000000', 1614: '#000000', 1615: '#000000', 1616: '#000000', 1617: '#E1A023', 2242: '#003067', 9568: '#000000', 9569: '#001F5B', 16489: '#000000', 18310: '#000000', 20787: '#001D4C', 25484: '#F5831F', 70: '#FFFFFF', 76: '#000000', 'default': 'rgb(255, 255, 255)'
            };

            const statsContainer = document.getElementById('stats-container');
            const matchStatsDocRef = db.collection('scoreboard').doc('matchStats');
            const matchStatsDataDocRef = db.collection('scoreboard').doc('matchStatsData');
            const fixtureDocRef = db.collection('scoreboard').doc('currentFixture');

            let showStats = false;
            let currentFixtureDetail = null;
            let currentStatsData = null;
            
            function getTeamColors(teamId) {
                const primary = TEAM_COLORS[teamId] || TEAM_COLORS['default'];
                const alternate = TEAM_COLORS_ALT[teamId] || TEAM_COLORS_ALT['default'];
                return { primary, alternate };
            }

            function renderGraphic() {
                if (showStats && currentFixtureDetail && currentStatsData) {
                    buildGraphic(currentFixtureDetail, currentStatsData);
                } else {
                    statsContainer.innerHTML = '';
                }
            }

            matchStatsDocRef.onSnapshot((doc) => {
                showStats = doc.exists && doc.data().show;
                renderGraphic();
            });

            fixtureDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    currentFixtureDetail = doc.data();
                    renderGraphic();
                }
            });

            matchStatsDataDocRef.onSnapshot((doc) => {
                if (doc.exists) {
                    currentStatsData = doc.data().stats;
                    renderGraphic();
                }
            });

            // --- REBUILT GRAPHIC FUNCTION ---
            function buildGraphic(fixture, stats) {
                statsContainer.innerHTML = '';

                const homeTeamStats = stats.find(team => team.team.id === fixture.teams.home.id);
                const awayTeamStats = stats.find(team => team.team.id === fixture.teams.away.id);
                
                if (!homeTeamStats || !awayTeamStats) {
                     statsContainer.innerHTML = '<h1>Waiting for match stats to become available...</h1>';
                     return;
                }
                
                const homeLogoUrl = `${assetsBaseUrl}assets/logos/${fixture.teams.home.id}.png`;
                const awayLogoUrl = `${assetsBaseUrl}assets/logos/${fixture.teams.away.id}.png`;
                const leagueLogoUrl = `${assetsBaseUrl}assets/leagues/${fixture.league.id}.png`;

                const homeColors = getTeamColors(fixture.teams.home.id);
                const awayColors = getTeamColors(fixture.teams.away.id);

                const wrapper = document.createElement('div');
                wrapper.className = 'stats-wrapper';
                
                // --- Top Bar HTML (largely unchanged) ---
                const topBarHTML = `
                    <div class="top-bar">
                        <img src="${leagueLogoUrl}" alt="${fixture.league.name}" class="league-logo" onerror="this.src='${fixture.league.logo}'">
                        <div class="fixture-details">
                            <div class="fixture-name">
                                <span class="team-name home">${fixture.teams.home.name}</span>
                                <span class="scoreline">${fixture.goals.home} - ${fixture.goals.away}</span>
                                <span class="team-name away">${fixture.teams.away.name}</span>
                            </div>
                        </div>
                    </div>
                `;

                // --- Helper function to generate a single stat row with the new split bar ---
                const createStatRow = (statName, customLabel) => {
                    const homeStat = homeTeamStats.statistics.find(s => s.type === statName);
                    const awayStat = awayTeamStats.statistics.find(s => s.type === statName);
                    if (!homeStat || !awayStat) return '';

                    let homeValue = parseFloat(homeStat.value) || 0;
                    let awayValue = parseFloat(awayStat.value) || 0;
                    
                    const total = homeValue + awayValue;
                    const homeWidth = total > 0 ? (homeValue / total) * 100 : 50;
                    
                    // COMMENT: This creates the CSS linear-gradient for the split bar.
                    // The gradient is angled and the color stop is based on the home team's percentage.
                    // A tiny gap (e.g., 0.2%) is used to create a sharp line.
                    const gradientStyle = `linear-gradient(105deg, ${homeColors.primary} ${homeWidth - 0.2}%, ${awayColors.primary} ${homeWidth + 0.2}%)`;

                    return `
                        <div class="stat-row">
                            <div class="stat-label">${customLabel || statName}</div>
                            <div class="stat-values">
                                <span class="stat-value home">${homeStat.value || 0}</span>
                                <div class="stat-bar-container">
                                    <div class="stat-bar" style="background: ${gradientStyle};"></div>
                                </div>
                                <span class="stat-value away">${awayStat.value || 0}</span>
                            </div>
                        </div>
                    `;
                };
                
                // --- Generate HTML for the three new sections ---
                const possessionData = homeTeamStats.statistics.find(s => s.type === 'Ball Possession');
                const homePossession = parseFloat(possessionData.value) || 50;
                const pieChartStyle = `conic-gradient(${homeColors.primary} 0% ${homePossession}%, ${awayColors.primary} ${homePossession}% 100%)`;

                const possessionHTML = `
                    <div class="stats-card possession-card">
                        <h2 class="card-title">Possession</h2>
                        <div class="possession-content">
                             <div class="pie-chart" style="background: ${pieChartStyle};"></div>
                             <div class="possession-values">
                                <div class="possession-team">
                                    <span class="team-label">${fixture.teams.home.name}</span>
                                    <span class="team-value">${homePossession}%</span>
                                </div>
                                <div class="possession-team">
                                    <span class="team-label">${fixture.teams.away.name}</span>
                                    <span class="team-value">${100 - homePossession}%</span>
                                </div>
                             </div>
                        </div>
                    </div>
                `;

                const shootingHTML = `
                     <div class="stats-card">
                        <h2 class="card-title">Shooting Breakdown</h2>
                        ${createStatRow('Total Shots')}
                        ${createStatRow('Shots on Goal', 'On Target')}
                        ${createStatRow('Shots off Goal', 'Off Target')}
                        ${createStatRow('Blocked Shots', 'Blocked')}
                        ${createStatRow('expected_goals', 'xG')}
                    </div>
                `;
                
                const allStatsHTML = `
                     <div class="stats-card">
                        <h2 class="card-title">All Stats</h2>
                        ${createStatRow('Corner Kicks', 'Corners')}
                        ${createStatRow('Fouls')}
                        ${createStatRow('Offsides')}
                        ${createStatRow('Total passes', 'Passes')}
                        ${createStatRow('Passes %', 'Pass Accuracy')}
                        ${createStatRow('Yellow Cards', 'Yellows')}
                        ${createStatRow('Red Cards', 'Reds')}
                    </div>
                `;

                // --- Assemble the final layout ---
                wrapper.innerHTML = `
                    ${topBarHTML}
                    <div class="stats-grid-layout">
                        <div class="main-stats-col">
                            ${allStatsHTML}
                        </div>
                        <div class="side-stats-col">
                           ${possessionHTML}
                           ${shootingHTML}
                        </div>
                    </div>
                `;

                statsContainer.appendChild(wrapper);

                // Add animation class after a short delay
                setTimeout(() => {
                    const cards = wrapper.querySelectorAll('.stats-card');
                    cards.forEach((card, index) => {
                        setTimeout(() => card.classList.add('visible'), index * 100);
                    });
                }, 100);
            }
        });
    </script>
</body>
</html>